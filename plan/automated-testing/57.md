# TASK-057: Finalize CI test matrix

**Section**: 8. Coverage & CI Tightening
**Subsection**: 8.4
**Task ID**: TASK-057

## Description

Update CI configuration (GitHub Actions, etc.) to run the test script groups: `npm run test:unit`, `npm run test:http`, and optionally `npm run test:e2e-lite`. Ensure the pipeline remains green and stable with all test groups running.

**Reference Implementation**: 
- CI configuration file (`.github/workflows/*.yml` or similar)
- `virtual-assistant/cursor-agents/package.json` - test script groups

## Current State

The project has test script groups defined in `package.json`:
- `test:unit` - runs unit tests
- `test:http` - runs HTTP/API tests
- `test:e2e-lite` - runs E2E-lite tests

CI configuration may exist but may not run all test groups or may need updating.

**Important**: This task should be executed after TASK-056, completing the entire testing plan.

## Checklist

### Preparation and Setup

- [ ] Review existing CI configuration
- [ ] Understand CI platform (GitHub Actions, GitLab CI, etc.)
- [ ] Review test script groups from TASK-002
- [ ] Understand CI matrix/job configuration

### Implementation Steps

- [ ] Step 1: Review/update CI configuration
  - [ ] Locate CI configuration file
  - [ ] Review current test execution
  - [ ] Add or update test jobs for each script group
- [ ] Step 2: Configure test:unit job
  - [ ] Add job or step to run `npm run test:unit`
  - [ ] Ensure dependencies are installed
  - [ ] Configure job to fail on test failures
- [ ] Step 3: Configure test:http job
  - [ ] Add job or step to run `npm run test:http`
  - [ ] Ensure dependencies are installed
  - [ ] Configure job to fail on test failures
- [ ] Step 4: Configure test:e2e-lite job (optional)
  - [ ] Add job or step to run `npm run test:e2e-lite`
  - [ ] Mark as optional or nightly if desired
  - [ ] Ensure dependencies and build are available
- [ ] Step 5: Verify CI pipeline
  - [ ] Push changes and verify CI runs
  - [ ] Verify all test jobs pass
  - [ ] Verify pipeline remains green
  - [ ] Document any CI-specific considerations

### Specific Requirements

- [ ] Requirement 1: Test must configure test:unit
  - Acceptance: CI runs `npm run test:unit`
- [ ] Requirement 2: Test must configure test:http
  - Acceptance: CI runs `npm run test:http`
- [ ] Requirement 3: Test must configure test:e2e-lite (optional)
  - Acceptance: CI runs `npm run test:e2e-lite` (optional/nightly)
- [ ] Requirement 4: Test must verify pipeline stability
  - Acceptance: CI pipeline passes with all test groups

### Error Handling and Edge Cases

- [ ] Handle case where CI platform doesn't support matrix
- [ ] Verify test jobs can run in parallel
- [ ] Ensure proper dependency installation
- [ ] Test with various CI configurations

### Testing

- [ ] Verify CI configuration syntax is correct
- [ ] Push changes and verify CI runs
- [ ] Verify all test jobs execute
- [ ] Verify pipeline passes
- [ ] **DO NOT manually test by running the server** - verify via CI execution

### Documentation

- [ ] Add comments explaining CI test matrix
- [ ] Document why test groups are separated
- [ ] Note any CI-specific requirements

### Verification

- [ ] Verify CI configuration is correct
- [ ] Verify all test jobs run
- [ ] Verify pipeline passes
- [ ] Confirm configuration follows project conventions

## Notes

- This task is part of **Phase 8 â€“ Coverage & CI Tightening**
- **Execution Timing**: Should be executed after TASK-056 (completes entire testing plan)
- **Dependencies**: 
  - TASK-002: Create/verify logical Jest script groups
  - TASK-056: Raise Jest coverage thresholds
- **Important Considerations**: 
  - CI test matrix ensures all test types run
  - Test groups can run in parallel for speed
  - E2E-lite tests may be optional or nightly (slower)
  - CI should fail if any test group fails
  - Coverage thresholds from TASK-056 will be enforced in CI
  - This completes the entire testing plan
- **Task Independence**: Can be completed independently after TASK-056
- **Current State**: CI configuration may exist but may need updating

## Related Tasks

- Previous: TASK-056 (Raise Jest coverage thresholds)
- Next: None (this completes the testing plan)
- Dependencies:
  - TASK-002: Create/verify logical Jest script groups
  - TASK-056: Raise Jest coverage thresholds
- Related:
  - TASK-002: Created test script groups used here
  - TASK-056: Coverage thresholds enforced in CI

## Definition of Done

### Task Type: CONFIGURATION TASK

**Description**: This task involves finalizing CI configuration to run all test groups.

**Definition of Done**: "CI configuration is updated to run `npm run test:unit`, `npm run test:http`, and optionally `npm run test:e2e-lite`. All test jobs are configured correctly. CI pipeline passes with all test groups. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want CI to run all test groups so that all tests are verified automatically.
   - **Acceptance Criteria**: 
     - CI runs test:unit, test:http, and test:e2e-lite
     - All test jobs pass
     - CI pipeline is green

2. **As a developer**, I want CI to be stable so that the pipeline is reliable.
   - **Acceptance Criteria**:
     - CI configuration is correct
     - Pipeline passes consistently
     - Test jobs run in appropriate order/parallel

### Automated Tests

**Note**: This is a configuration task. CI configuration should be:

```yaml
# Example GitHub Actions
name: Tests

on: [push, pull_request]

jobs:
  test-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run test:unit
  
  test-http:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run test:http
  
  test-e2e-lite:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - run: npm run test:e2e-lite
```

- [ ] CI configuration updated
- [ ] All test groups configured
- [ ] CI pipeline passes
- [ ] Test jobs run correctly

### Git Commit and Push Requirements

- [ ] CI configuration file updated
- [ ] Commit message follows project conventions (e.g., "ci: configure test matrix for all test groups")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the CI configuration changes
- [ ] CI pipeline verified to pass

### Final Checklist

- [ ] CI configuration updated
- [ ] All test groups configured
- [ ] CI pipeline passes
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 8 (Coverage & CI Tightening) is complete**
- [ ] **ENTIRE TESTING PLAN (Tasks 1-57) is complete**
