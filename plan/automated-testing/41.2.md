# TASK-041.2: Test DELETE /queues/:queueName - error handling

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.4.2
**Task ID**: TASK-041.2

## Description

Add a test case for the `DELETE /queues/:queueName` endpoint to verify it correctly handles errors when queue deletion fails (e.g., queue has jobs or cannot be deleted). The test should verify that the endpoint returns 500 with an error message.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `DELETE /queues/:queueName` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `DELETE /queues/:queueName` endpoint:
- Returns 500 with error message when `deleteQueue` throws (e.g., queue has jobs, is default queue)

The test file `tests/app.test.ts` exists with previous tests including TASK-041.1.

**Important**: This task should be executed after TASK-041.1, completing TASK-041.

## Checklist

### Preparation and Setup

- [ ] Review `DELETE /queues/:queueName` endpoint error handling
- [ ] Understand `deleteQueue` error cases
- [ ] Review test setup from TASK-041.1

### Implementation Steps

- [ ] Step 1: Write test for queue with jobs error
  - [ ] Create test: `it('should return 500 when queue has jobs', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `deleteQueue` to throw error with message about remaining jobs
  - [ ] Act: DELETE `/queues/q1`
  - [ ] Assert: 
    - [ ] Response status is 500
    - [ ] Response body contains error message (propagated from `deleteQueue`)

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: Returns 500 with error message on failure
- [ ] Requirement 2: Test must verify error message propagation
  - Acceptance: Error message from `deleteQueue` is propagated

### Error Handling and Edge Cases

- [ ] Handle case where queue doesn't exist
- [ ] Verify error messages are descriptive
- [ ] Test with various error types

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling
- [ ] Document error message propagation

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-041.1 (completes TASK-041)
- **Dependencies**: 
  - TASK-041.1: Test DELETE /queues/:queueName - successful deletion
- **Important Considerations**: 
  - Error messages should be descriptive
  - Error propagation ensures users see actual error
  - Validation happens in `deleteQueue` (tested in TASK-034)
  - This is the second and final subtask for TASK-041
- **Task Independence**: Can be completed independently after TASK-041.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-041 (Add tests for /queues/:queueName DELETE)
- Previous: TASK-041.1 (Test DELETE /queues/:queueName - successful deletion)
- Next: TASK-042 (Add tests for /agents endpoints)
- Dependencies:
  - TASK-041.1: Test DELETE /queues/:queueName - successful deletion
- Related:
  - TASK-034: Tested deleteQueue validation in unit tests
  - TASK-041.1: Other subtask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `DELETE /queues/:queueName` error handling.

**Definition of Done**: "A test case is written that verifies `DELETE /queues/:queueName` correctly handles errors when queue deletion fails, returning 500 with error message. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that deletion failures are communicated clearly.
   - **Acceptance Criteria**:
     - Test verifies 500 error is returned on failure
     - Test verifies error message is propagated

### Automated Tests

The test case should be:

```typescript
describe('DELETE /queues/:queueName', () => {
  it('should return 500 when queue has jobs', async () => {
    // Arrange: deleteQueue throws error
    const error = new Error('Queue has remaining jobs');
    mockQueueManager.deleteQueue.mockRejectedValue(error);
    
    // Act
    const response = await request(app.getApp())
      .delete('/queues/q1')
      .expect(500);
    
    // Assert
    expect(response.body).toHaveProperty('error');
    expect(response.body.error).toContain('jobs');
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify error handling
- [ ] Tests verify error message propagation

### Git Commit and Push Requirements

- [ ] Test case added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add DELETE /queues/:queueName error handling test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify error handling
- [ ] Tests verify error message propagation
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-041 (all subtasks) is complete**

