# TASK-012: Test updateTaskStatus when updatedat already exists

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.9
**Task ID**: TASK-012

## Description

Add a test case for the `updateTaskStatus` method to verify it correctly handles the case where the `updatedat` column already exists in the `tasks` table. The test should verify that no `ALTER TABLE` is attempted (or at least doesn't throw), and that the `updatedat` timestamp is updated when the status changes.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 142-198) - `updateTaskStatus()` method

## Current State

The `updateTaskStatus` method:
- Checks if `updatedat` column exists
- Skips `ALTER TABLE` if column already exists
- Updates both `status` and `updatedat` when column exists
- Uses `CURRENT_TIMESTAMP` for `updatedat` value

The test file `tests/services/database-service.test.ts` exists with previous task tests including TASK-011.

**Important**: This task should be executed after TASK-011 (test updateTaskStatus with missing updatedat).

## Checklist

### Preparation and Setup

- [ ] Review `updateTaskStatus` implementation for existing column case
- [ ] Understand how to verify `updatedat` timestamp changes
- [ ] Review SQLite timestamp handling
- [ ] Understand how to detect if `ALTER TABLE` was called

### Implementation Steps

- [ ] Step 1: Set up test database with tasks table (with updatedat)
  - [ ] Create `tasks` table with: `id`, `prompt`, `"order"`, `uuid`, `status`, `updatedat`
  - [ ] Insert a test task row with initial `updatedat` value
- [ ] Step 2: Write test for existing column
  - [ ] Create test: `it('should update status and updatedat when column already exists', () => { ... })`
  - [ ] Arrange: 
    - [ ] Create `tasks` table with `updatedat` column
    - [ ] Insert a task with `id=1`, `status=0`, `updatedat='2024-01-01 00:00:00'`
  - [ ] Act: Call `updateTaskStatus(1, 4)` (set to in_progress)
  - [ ] Assert: 
    - [ ] Method returns `true`
    - [ ] Task status is updated to 4
    - [ ] `updatedat` timestamp is updated (newer than original)
    - [ ] No `ALTER TABLE` error occurs
- [ ] Step 3: Verify timestamp update (if feasible)
  - [ ] Query `updatedat` value before and after update
  - [ ] Assert: `updatedat` is newer after update
  - [ ] Note: Timestamp precision may limit exact comparison

### Specific Requirements

- [ ] Requirement 1: Test must verify no ALTER TABLE is attempted
  - Acceptance: No error occurs from attempting to add existing column
- [ ] Requirement 2: Test must verify status is updated
  - Acceptance: Task status changes to the new value
- [ ] Requirement 3: Test must verify updatedat is updated
  - Acceptance: `updatedat` timestamp changes (if verifiable)
- [ ] Requirement 4: Test must use table with updatedat initially
  - Acceptance: Table is created with `updatedat` column

### Error Handling and Edge Cases

- [ ] Handle case where timestamp doesn't change (timing issues)
- [ ] Verify method works correctly when column exists
- [ ] Test multiple updates to same task
- [ ] Verify timestamp format is correct

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify timestamp update works (if testable)
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining timestamp verification
- [ ] Document any limitations of timestamp testing
- [ ] Note why ALTER TABLE is skipped

### Verification

- [ ] Verify test passes consistently
- [ ] Verify status update works
- [ ] Verify updatedat update works (if testable)
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-011
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-011: Test updateTaskStatus with missing updatedat
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create table with `updatedat` to test existing column path
  - Timestamp verification may be limited by test execution speed
  - The method should not attempt `ALTER TABLE` when column exists
- **Task Independence**: Can be completed independently after TASK-011
- **Current State**: Test file exists with previous task tests

## Related Tasks

- Previous: TASK-011 (Test updateTaskStatus with missing updatedat)
- Next: TASK-013 (Test updateTaskStatus when old complete column exists)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-011: Test updateTaskStatus with missing updatedat
- Related:
  - TASK-011: Tested missing column case
  - TASK-013: Will test warning for old `complete` column

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `updateTaskStatus` when the `updatedat` column already exists.

**Definition of Done**: "A test case is written that verifies `updateTaskStatus` correctly updates both status and `updatedat` when the column already exists, without attempting `ALTER TABLE`. The test verifies the status update and timestamp update (if feasible). All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify status updates work when column exists so that normal operations function correctly.
   - **Acceptance Criteria**: 
     - Test verifies status is updated correctly
     - Test verifies no ALTER TABLE errors occur
     - Test verifies method returns true

2. **As a developer**, I want to verify timestamps are updated so that I can track when tasks were last modified.
   - **Acceptance Criteria**:
     - Test verifies `updatedat` timestamp changes (if testable)
     - Test verifies timestamp format is correct

### Automated Tests

The test case should be:

```typescript
it('should update status and updatedat when column already exists', () => {
  // Arrange: Create tasks table with updatedat column
  const db = new Database(':memory:');
  db.exec(`
    CREATE TABLE tasks (
      id INTEGER PRIMARY KEY,
      prompt TEXT,
      "order" INTEGER,
      uuid TEXT,
      status INTEGER,
      updatedat DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);
  const initialTime = new Date().toISOString();
  db.prepare('INSERT INTO tasks (id, prompt, "order", uuid, status, updatedat) VALUES (?, ?, ?, ?, ?, ?)')
    .run(1, 'Test prompt', 0, 'test-uuid', 0, initialTime);
  
  const service = new DatabaseService(':memory:');
  // Need to use same database instance
  
  // Act
  const result = service.updateTaskStatus(1, 4);
  
  // Assert
  expect(result).toBe(true);
  // Verify status was updated
  const task = db.prepare('SELECT status, updatedat FROM tasks WHERE id = ?').get(1);
  expect(task.status).toBe(4);
  // Verify updatedat changed (may need to account for timing)
  expect(new Date(task.updatedat) >= new Date(initialTime)).toBe(true);
});
```

- [ ] Test case written and passes
- [ ] Test verifies status update
- [ ] Test verifies updatedat update (if feasible)
- [ ] Test verifies no ALTER TABLE errors

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add updateTaskStatus with existing updatedat column test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies status update
- [ ] Test verifies updatedat update (if feasible)
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
