# TASK-010: Test getNextReadyTask behavior

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.7
**Task ID**: TASK-010

**NOTE**: This task has been split into granular subtasks:
- **TASK-010.1**: Test getNextReadyTask when no tasks (returns null)
- **TASK-010.2**: Test getNextReadyTask with tasks - status filtering
- **TASK-010.3**: Test getNextReadyTask ordering logic (order ASC then id ASC)
- **TASK-010.4**: Test getNextReadyTask when query fails (returns null, logs error)

Please execute the subtasks (10.1, 10.2, 10.3, 10.4) instead of this parent task.

## Description

Add comprehensive test cases for the `getNextReadyTask` method to verify it correctly retrieves the next ready or in-progress task from the database. The tests should cover: no tasks available, tasks with different statuses, ordering by `"order"` then `id`, and error handling when queries fail.

**This task has been split into subtasks - see TASK-010.1 through TASK-010.4**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 111-135) - `getNextReadyTask()` method
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 101-105) - Status constants

## Current State

The `getNextReadyTask` method:
- Queries `tasks` table for tasks with `status IN (0, 4)` (ready or in_progress)
- Orders by `"order"` ASC, then `id` ASC
- Returns the first matching task or `null` if none
- Returns `null` on error and logs the error

The test file `tests/services/database-service.test.ts` exists with system settings tests from previous tasks.

**Important**: This task should be executed after TASK-004 through TASK-009.

## Checklist

### Preparation and Setup

- [ ] Review `getNextReadyTask` implementation
- [ ] Understand `tasks` table schema: `id`, `prompt`, `"order"`, `uuid`, `status`
- [ ] Review status constants: 0=ready, 1=complete, 2=archived, 3=backlogged, 4=in_progress
- [ ] Understand SQLite table creation and data insertion

### Implementation Steps

- [ ] Step 1: Set up test database with tasks table
  - [ ] Create `tasks` table with required fields
  - [ ] Table should have: `id` (INTEGER PRIMARY KEY), `prompt` (TEXT), `"order"` (INTEGER), `uuid` (TEXT), `status` (INTEGER)
  - [ ] Add helper function to create table if needed
- [ ] Step 2: Write test for no tasks
  - [ ] Create test: `it('should return null when no tasks are available', () => { ... })`
  - [ ] Arrange: Empty `tasks` table
  - [ ] Act: Call `getNextReadyTask()`
  - [ ] Assert: Returns `null`
- [ ] Step 3: Write test for tasks with status IN (0,4)
  - [ ] Create test: `it('should return task with lowest order then id when tasks exist', () => { ... })`
  - [ ] Arrange: Insert multiple tasks:
    - [ ] Task 1: `status=0` (ready), `order=10`, `id=1`
    - [ ] Task 2: `status=0` (ready), `order=5`, `id=2` (lower order, should be returned)
    - [ ] Task 3: `status=4` (in_progress), `order=5`, `id=3` (same order, higher id)
    - [ ] Task 4: `status=1` (complete), `order=1`, `id=4` (should be ignored)
  - [ ] Act: Call `getNextReadyTask()`
  - [ ] Assert: Returns Task 2 (lowest order, then lowest id)
- [ ] Step 4: Write test for ordering logic
  - [ ] Create test: `it('should order by order ASC then id ASC', () => { ... })`
  - [ ] Arrange: Insert tasks with same order but different ids
  - [ ] Act: Call `getNextReadyTask()`
  - [ ] Assert: Returns task with lowest id when orders are equal
- [ ] Step 5: Write test for error path
  - [ ] Create test: `it('should return null and log error when query fails', () => { ... })`
  - [ ] Arrange: Drop `tasks` table or cause query to fail
  - [ ] Act: Call `getNextReadyTask()`
  - [ ] Assert: Returns `null`, error is logged

### Specific Requirements

- [ ] Requirement 1: Test must verify no tasks returns null
  - Acceptance: Empty table returns `null`
- [ ] Requirement 2: Test must verify correct task selection
  - Acceptance: Task with lowest `order` then `id` is returned
- [ ] Requirement 3: Test must verify status filtering
  - Acceptance: Only tasks with `status IN (0, 4)` are considered
- [ ] Requirement 4: Test must verify error handling
  - Acceptance: Query error returns `null` and logs error

### Error Handling and Edge Cases

- [ ] Handle case where table doesn't exist
- [ ] Handle case where all tasks have status not in (0, 4)
- [ ] Verify ordering with multiple tasks having same order
- [ ] Test with tasks having null or invalid order values (if possible)

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify tests are isolated
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining task ordering logic
- [ ] Document status filtering behavior
- [ ] Note any edge cases covered

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify ordering logic is correct
- [ ] Verify status filtering works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-004 through TASK-009
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005 through TASK-009: Previous DatabaseService tests
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create `tasks` table schema in test setup
  - Test ordering logic carefully (order ASC, then id ASC)
  - Status filtering: only 0 (ready) and 4 (in_progress) are considered
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: Test file exists with system settings tests

## Related Tasks

- Previous: TASK-009 (Test setSystemSetting error path)
- Next: TASK-011 (Test updateTaskStatus with updatedat column missing)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005 through TASK-009: Previous DatabaseService tests
- Related:
  - TASK-011 through TASK-015: Will test task status update operations

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive test cases for the `getNextReadyTask` method.

**Definition of Done**: "Test cases are written that verify `getNextReadyTask` correctly retrieves tasks with status IN (0,4), orders by `order` ASC then `id` ASC, returns null when no tasks exist, and handles errors properly. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify task retrieval works so that the task operator can process tasks correctly.
   - **Acceptance Criteria**: 
     - Test verifies correct task is returned based on ordering
     - Test verifies only ready/in_progress tasks are considered
     - Test verifies null is returned when no tasks exist

2. **As a developer**, I want to verify ordering logic works so that tasks are processed in the correct order.
   - **Acceptance Criteria**:
     - Test verifies ordering by `order` ASC then `id` ASC
     - Test verifies lowest order task is returned first
     - Test verifies lowest id is returned when orders are equal

### Automated Tests

Test cases should include:

```typescript
describe('getNextReadyTask', () => {
  it('should return null when no tasks are available', () => {
    // Arrange: Empty tasks table
    // Act: getNextReadyTask()
    // Assert: Returns null
  });
  
  it('should return task with lowest order then id', () => {
    // Arrange: Insert multiple tasks with varying order and status
    // Act: getNextReadyTask()
    // Assert: Returns task with lowest order, then lowest id
  });
  
  it('should only consider tasks with status IN (0, 4)', () => {
    // Arrange: Insert tasks with various statuses
    // Act: getNextReadyTask()
    // Assert: Only ready/in_progress tasks are considered
  });
  
  it('should return null and log error when query fails', () => {
    // Arrange: Drop table or cause error
    // Act: getNextReadyTask()
    // Assert: Returns null, error logged
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests cover no tasks, ordering, status filtering, and errors
- [ ] Tests verify ordering logic correctly
- [ ] Tests are properly isolated

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getNextReadyTask comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover no tasks, ordering, status filtering, and errors
- [ ] Tests verify ordering logic
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
