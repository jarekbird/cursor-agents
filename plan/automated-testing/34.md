# TASK-034: Add tests for deleteQueue

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.7
**Task ID**: TASK-034

**NOTE**: This task has been split into granular subtasks:
- **TASK-034.1**: Test deleteQueue - queue not found error
- **TASK-034.2**: Test deleteQueue - default queue protection
- **TASK-034.3**: Test deleteQueue - queue with jobs error
- **TASK-034.4**: Test deleteQueue - successful deletion

Please execute the subtasks (34.1, 34.2, 34.3, 34.4) instead of this parent task.

## Description

Add test cases for the `deleteQueue` method to verify it correctly validates queue deletion conditions and properly cleans up queue resources. The tests should verify error cases (queue not found, default queue, queue with jobs) and successful deletion (closing workers, events, queue, and removing from map).

**This task has been split into subtasks - see TASK-034.1 through TASK-034.4**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `deleteQueue()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `deleteQueue` method:
- Validates queue exists
- Throws error if queue is default queue
- Throws error if queue has jobs or repeatable entries
- Closes worker, queue events, and queue
- Removes queue from internal maps
- Only succeeds if queue is empty and not default

The test file `tests/queue/queue-manager.test.ts` exists but may not have comprehensive `deleteQueue` tests.

**Important**: This task should be executed after TASK-033, completing Phase 3.

## Checklist

### Preparation and Setup

- [ ] Review `deleteQueue` implementation
- [ ] Understand validation logic (default queue, jobs check)
- [ ] Review resource cleanup (worker, events, queue closing)
- [ ] Understand map removal

### Implementation Steps

- [ ] Step 1: Write test for queue not found
  - [ ] Create test: `it('should throw error when queue is not found', async () => { ... })`
  - [ ] Arrange: Queue name that doesn't exist
  - [ ] Act: Call `deleteQueue('non-existent')`
  - [ ] Assert: Throws expected error
- [ ] Step 2: Write test for default queue
  - [ ] Create test: `it('should throw error when attempting to delete default queue', async () => { ... })`
  - [ ] Arrange: Default queue name
  - [ ] Act: Call `deleteQueue('default')`
  - [ ] Assert: Throws error about not deleting default queue
- [ ] Step 3: Write test for queue with jobs
  - [ ] Create test: `it('should throw error when queue has jobs', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Queue with waiting/active/delayed jobs or repeatable entries
  - [ ] Act: Call `deleteQueue('queue-with-jobs')`
  - [ ] Assert: Throws error about remaining jobs
- [ ] Step 4: Write test for successful deletion
  - [ ] Create test: `it('should close resources and remove queue when empty', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Empty non-default queue
    - [ ] Mock worker, events, queue `close` methods
  - [ ] Act: Call `deleteQueue('empty-queue')`
  - [ ] Assert: 
    - [ ] Worker closed
    - [ ] Events closed
    - [ ] Queue closed
    - [ ] Queue removed from maps

### Specific Requirements

- [ ] Requirement 1: Test must verify validation errors
  - Acceptance: Appropriate errors thrown for invalid cases
- [ ] Requirement 2: Test must verify resource cleanup
  - Acceptance: All resources are closed properly
- [ ] Requirement 3: Test must verify map removal
  - Acceptance: Queue is removed from internal maps
- [ ] Requirement 4: Test must verify success case
  - Acceptance: Deletion succeeds when conditions are met

### Error Handling and Edge Cases

- [ ] Handle case where close methods throw
- [ ] Verify queue is removed even if close fails
- [ ] Test with various queue states
- [ ] Verify error messages are descriptive

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining deletion validation
- [ ] Document why default queue is protected
- [ ] Note resource cleanup order

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify validation works
- [ ] Verify resource cleanup works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-033 (completes Phase 3)
- **Dependencies**: 
  - TASK-033: Add tests for removeAgent and checkAndCleanupEmptyQueue
- **Important Considerations**: 
  - Default queue protection prevents system instability
  - Jobs check prevents data loss
  - Resource cleanup prevents leaks
  - Map removal ensures consistency
  - Validation errors should be descriptive
- **Task Independence**: Can be completed independently after TASK-033
- **Current State**: Test file exists but may not have comprehensive deleteQueue tests

## Related Tasks

- Previous: TASK-033 (Add tests for removeAgent and checkAndCleanupEmptyQueue)
- Next: TASK-035 (Extend prompt-processor.test.ts for re-enqueueing) - Starts Phase 4
- Dependencies:
  - TASK-033: Add tests for removeAgent and checkAndCleanupEmptyQueue
- Related:
  - TASK-033: Used deleteQueue in cleanup tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `deleteQueue` method.

**Definition of Done**: "Test cases are added that verify `deleteQueue` correctly validates deletion conditions (throws errors for invalid cases) and properly cleans up resources (closes worker, events, queue, removes from maps) when deletion succeeds. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify validation works so that queues aren't deleted inappropriately.
   - **Acceptance Criteria**: 
     - Test verifies default queue protection
     - Test verifies jobs check prevents deletion
     - Test verifies not found error

2. **As a developer**, I want to verify resource cleanup works so that resources don't leak.
   - **Acceptance Criteria**:
     - Test verifies all resources are closed
     - Test verifies queue is removed from maps
     - Test verifies cleanup order is correct

### Automated Tests

Test cases should include:

```typescript
describe('deleteQueue', () => {
  it('should throw error when queue is not found', async () => {
    // Arrange: Queue doesn't exist
    // Act & Assert: Throws error
  });
  
  it('should throw error when attempting to delete default queue', async () => {
    // Arrange: Default queue
    // Act & Assert: Throws error about default queue
  });
  
  it('should throw error when queue has jobs', async () => {
    // Arrange: Queue with jobs
    // Act & Assert: Throws error about remaining jobs
  });
  
  it('should close resources and remove queue when empty', async () => {
    // Arrange: Empty non-default queue
    const mockWorker = { close: jest.fn().mockResolvedValue(undefined) };
    const mockEvents = { close: jest.fn().mockResolvedValue(undefined) };
    const mockQueue = { close: jest.fn().mockResolvedValue(undefined) };
    // Act: deleteQueue('empty-queue')
    // Assert: All close methods called, queue removed from maps
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify validation errors
- [ ] Tests verify resource cleanup
- [ ] Tests verify map removal

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add deleteQueue comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify validation
- [ ] Tests verify resource cleanup
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 3 (QueueManager Enhancements) is complete**
