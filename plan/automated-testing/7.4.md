# TASK-007.4: Test isSystemSettingEnabled when query fails (returns false, logs error)

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.4.4
**Task ID**: TASK-007.4

## Description

Add a test case for the `isSystemSettingEnabled` method to verify it returns `false` and logs an error when the database query fails. This verifies fail-closed error handling behavior.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 43-63) - `isSystemSettingEnabled()` method

## Current State

The `isSystemSettingEnabled` method:
- Queries `system_settings` table for a setting by name
- Returns `false` on error (fail-closed behavior)
- Logs errors when queries fail

The test file `tests/services/database-service.test.ts` exists with previous tests including TASK-007.1, TASK-007.2, and TASK-007.3.

**Important**: This task should be executed after TASK-007.3, completing TASK-007.

## Checklist

### Preparation and Setup

- [ ] Review `isSystemSettingEnabled` error handling implementation
- [ ] Understand how to simulate query failures
- [ ] Review logger mocking patterns
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Set up test for query failure
  - [ ] Create test: `it('should return false and log error when query fails', () => { ... })`
  - [ ] Arrange: 
    - [ ] Drop `system_settings` table or cause query to fail
    - [ ] Mock logger to capture error logs
  - [ ] Act: Call `isSystemSettingEnabled('test')`
  - [ ] Assert: 
    - [ ] Returns `false`
    - [ ] Error is logged

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: Query error returns `false` and logs error
- [ ] Requirement 2: Test must verify fail-closed behavior
  - Acceptance: Method returns false on error (doesn't throw)
- [ ] Requirement 3: Test must verify error logging
  - Acceptance: Logger receives error message

### Error Handling and Edge Cases

- [ ] Handle case where table doesn't exist (drop table)
- [ ] Handle case where database connection fails
- [ ] Verify error messages are descriptive
- [ ] Test with various error scenarios

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify error logging works
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling
- [ ] Document why fail-closed behavior is important
- [ ] Note error logging approach

### Verification

- [ ] Verify test passes consistently
- [ ] Verify error handling works
- [ ] Verify error logging works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-007.3 (completes TASK-007)
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-007.3: Test isSystemSettingEnabled when setting missing
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Fail-closed behavior (returns false on error) is intentional for safety
  - Error logging is important for debugging
  - This is the fourth and final subtask for TASK-007
- **Task Independence**: Can be completed independently after TASK-007.3
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-007 (Test isSystemSettingEnabled behavior)
- Previous: TASK-007.3 (Test isSystemSettingEnabled when setting missing)
- Next: TASK-008 (Test setSystemSetting happy path)
- Dependencies:
  - TASK-007.3: Test isSystemSettingEnabled when setting missing
- Related:
  - TASK-007.1, TASK-007.2, TASK-007.3: Other subtasks for isSystemSettingEnabled
  - TASK-008: Will test setting system settings (write operations)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `isSystemSettingEnabled` when query fails.

**Definition of Done**: "A test case is written that verifies `isSystemSettingEnabled` returns `false` and logs an error when the database query fails. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that the system fails safely.
   - **Acceptance Criteria**: 
     - Test verifies query errors return `false` (fail-closed)
     - Test verifies errors are logged for debugging
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('isSystemSettingEnabled', () => {
  it('should return false and log error when query fails', () => {
    // Arrange: Drop table or cause error
    const db = createTestDatabase();
    // Don't create table, or drop it to cause error
    const mockLogger = { error: jest.fn() };
    const service = new DatabaseService(':memory:');
    // Inject mock logger or spy on logger
    
    // Act
    const result = service.isSystemSettingEnabled('test');
    
    // Assert
    expect(result).toBe(false);
    expect(mockLogger.error).toHaveBeenCalled();
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies error returns false
- [ ] Test verifies error is logged

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add isSystemSettingEnabled query failure test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies error handling
- [ ] Test verifies error logging
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-007 (all subtasks) is complete**

