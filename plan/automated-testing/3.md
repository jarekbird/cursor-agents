# TASK-003: Confirm global Jest setup

**Section**: 0. Baseline & Tooling
**Subsection**: 0.3
**Task ID**: TASK-003

## Description

Verify that the global Jest setup file (`tests/setup.ts`) is properly configured with necessary global mocks and configurations. This ensures consistent test environment across all test suites. The setup should handle global `fetch` mocking and console output suppression.

**Reference Implementation**: `virtual-assistant/cursor-agents/tests/setup.ts` (lines 1-26)

## Current State

The `tests/setup.ts` file currently exists and contains:
- Global `fetch` mock setup (if not available)
- Console output suppression in `beforeAll` hook
- Console output restoration in `afterAll` hook

The setup file is referenced in `jest.config.js` via `setupFilesAfterEnv: ['<rootDir>/tests/setup.ts']`.

**Important**: This task should be executed after TASK-001 and TASK-002 to ensure test infrastructure is ready.

## Checklist

### Preparation and Setup

- [ ] Review `tests/setup.ts` file
- [ ] Review `jest.config.js` to understand how setup is loaded
- [ ] Understand what global mocks are needed for the project
- [ ] Check if any additional global concerns need to be addressed

### Implementation Steps

- [ ] Step 1: Verify global `fetch` mock
  - [ ] Open `tests/setup.ts`
  - [ ] Confirm `global.fetch` is mocked if not available
  - [ ] Verify mock uses `jest.fn()` for type safety
  - [ ] Test that `fetch` is available in test environment
- [ ] Step 2: Verify console output suppression
  - [ ] Confirm `beforeAll` hook suppresses `console.log`, `console.error`, `console.warn`
  - [ ] Confirm `afterAll` hook restores original console methods
  - [ ] Verify suppression works by running a test that logs
- [ ] Step 3: Check for additional global concerns
  - [ ] Review if any other globals need mocking (e.g., `process.env`, `Date`, etc.)
  - [ ] Add any missing global mocks if needed
  - [ ] Document any new global mocks added

### Specific Requirements

- [ ] Requirement 1: Global `fetch` must be available in all tests
  - Acceptance: Tests can use `fetch` without errors, even if native `fetch` is unavailable
- [ ] Requirement 2: Console output must be suppressed during tests
  - Acceptance: Running tests doesn't produce console output unless explicitly needed
- [ ] Requirement 3: Console methods must be restored after tests
  - Acceptance: Console works normally after test suite completes
- [ ] Requirement 4: Setup file must be loaded by Jest
  - Acceptance: `jest.config.js` references `tests/setup.ts` in `setupFilesAfterEnv`

### Error Handling and Edge Cases

- [ ] Handle case where `global.fetch` already exists (don't override)
- [ ] Handle case where console methods are undefined
- [ ] Ensure setup doesn't interfere with test-specific console usage
- [ ] Verify setup works in both watch and single-run modes

### Testing

- [ ] Create a simple test that uses `fetch` to verify it's available
- [ ] Create a simple test that logs to verify suppression works
- [ ] Run full test suite to ensure setup doesn't break existing tests
- [ ] Verify setup file is loaded by checking Jest output
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Document any global mocks added in code comments
- [ ] Update `tests/README.md` if setup behavior changes
- [ ] Document any special considerations for future test writers

### Verification

- [ ] Verify `fetch` is available in test environment
- [ ] Verify console suppression works correctly
- [ ] Verify no regressions in existing tests
- [ ] Confirm setup follows project conventions

## Notes

- This task is part of **Phase 0 â€“ Baseline & Tooling**
- **Execution Timing**: Should be executed after TASK-001 and TASK-002
- **Dependencies**: 
  - TASK-001: Verify existing test commands
  - TASK-002: Create/verify logical Jest script groups
- **Important Considerations**: 
  - The setup file runs before all tests, so it must be lightweight
  - Console suppression should not interfere with test debugging when needed
  - Global mocks should be minimal and only for truly global concerns
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: Setup file exists but needs verification

## Related Tasks

- Previous: TASK-002 (Create/verify logical Jest script groups)
- Next: TASK-004 (Create a new test file for DatabaseService)
- Dependencies:
  - TASK-001: Verify existing test commands
  - TASK-002: Create/verify logical Jest script groups
- Related:
  - TASK-004+: Will use this setup for all test files

## Definition of Done

### Task Type: CONFIGURATION TASK

**Description**: This task involves verifying and potentially updating the global Jest setup configuration.

**Definition of Done**: "The `tests/setup.ts` file is verified to properly configure global mocks and test environment. Global `fetch` is available in all tests. Console output is suppressed during test execution. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a test writer**, I want `fetch` to be available in all tests so that I can test HTTP functionality without additional setup.
   - **Acceptance Criteria**: 
     - `fetch` is available in test environment
     - Tests can use `fetch` without errors
     - Mock is properly typed with `jest.fn()`

2. **As a developer**, I want console output suppressed during tests so that test output is clean and readable.
   - **Acceptance Criteria**:
     - Console methods are suppressed in `beforeAll`
     - Console methods are restored in `afterAll`
     - Tests run without console noise

3. **As a developer**, I want the test setup to be minimal and fast so that tests run quickly.
   - **Acceptance Criteria**:
     - Setup file loads quickly
     - No unnecessary global mocks
     - Setup doesn't slow down test execution

### Automated Tests

**Note**: This is a configuration task, but we can verify setup works with simple tests:

- [ ] Test: Verify `fetch` is available
  ```typescript
  it('should have fetch available', () => {
    expect(global.fetch).toBeDefined();
    expect(typeof global.fetch).toBe('function');
  });
  ```
- [ ] Test: Verify console suppression (if testable)
  - May need to check that console methods are replaced during tests

### Git Commit and Push Requirements

- [ ] All changes to `tests/setup.ts` (if any) are committed to git
- [ ] Commit message follows project conventions (e.g., "test: verify global Jest setup configuration")
- [ ] Changes are pushed to origin
- [ ] Commit includes only changes related to this task

### Final Checklist

- [ ] Global `fetch` mock verified
- [ ] Console suppression verified
- [ ] Setup file works correctly
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
