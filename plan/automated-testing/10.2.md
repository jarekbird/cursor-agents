# TASK-010.2: Test getNextReadyTask with tasks - status filtering

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.7.2
**Task ID**: TASK-010.2

## Description

Add a test case for the `getNextReadyTask` method to verify it correctly filters tasks by status (only returns tasks with `status IN (0, 4)`) and ignores tasks with other statuses. This verifies status filtering logic.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 111-135) - `getNextReadyTask()` method
- Status constants: 0=ready, 1=complete, 2=archived, 3=backlogged, 4=in_progress

## Current State

The `getNextReadyTask` method:
- Queries `tasks` table for tasks with `status IN (0, 4)` (ready or in_progress)
- Ignores tasks with other statuses (1=complete, 2=archived, 3=backlogged)

The test file `tests/services/database-service.test.ts` exists with previous tests including TASK-010.1.

**Important**: This task should be executed after TASK-010.1.

## Checklist

### Preparation and Setup

- [ ] Review `getNextReadyTask` implementation
- [ ] Understand status constants: 0=ready, 1=complete, 2=archived, 3=backlogged, 4=in_progress
- [ ] Review test setup from TASK-010.1

### Implementation Steps

- [ ] Step 1: Set up test database with tasks table
  - [ ] Create `tasks` table with required fields (may reuse from TASK-010.1)
- [ ] Step 2: Write test for status filtering
  - [ ] Create test: `it('should only return tasks with status IN (0, 4)', () => { ... })`
  - [ ] Arrange: Insert multiple tasks:
    - [ ] Task 1: `status=0` (ready), `order=1`, `id=1` (should be considered)
    - [ ] Task 2: `status=4` (in_progress), `order=2`, `id=2` (should be considered)
    - [ ] Task 3: `status=1` (complete), `order=0`, `id=3` (should be ignored)
    - [ ] Task 4: `status=2` (archived), `order=0`, `id=4` (should be ignored)
  - [ ] Act: Call `getNextReadyTask()`
  - [ ] Assert: Returns Task 1 (lowest order among status 0 and 4 tasks), ignores tasks 3 and 4

### Specific Requirements

- [ ] Requirement 1: Test must verify status filtering
  - Acceptance: Only tasks with `status IN (0, 4)` are considered
- [ ] Requirement 2: Test must verify other statuses are ignored
  - Acceptance: Tasks with status 1, 2, 3 are not returned
- [ ] Requirement 3: Test must set up database correctly
  - Acceptance: `tasks` table exists with test data

### Error Handling and Edge Cases

- [ ] Handle case where all tasks have status not in (0, 4) (should return null)
- [ ] Verify status filtering is correct
- [ ] Test with various status combinations

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify test is isolated
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining status filtering
- [ ] Document which statuses are considered

### Verification

- [ ] Verify test passes consistently
- [ ] Verify status filtering works correctly
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-010.1
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-010.1: Test getNextReadyTask when no tasks
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create `tasks` table schema in test setup
  - This is the second of 4 subtasks for TASK-010
  - Status filtering: only 0 (ready) and 4 (in_progress) are considered
- **Task Independence**: Can be completed independently after TASK-010.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-010 (Test getNextReadyTask behavior)
- Previous: TASK-010.1 (Test getNextReadyTask when no tasks)
- Next: TASK-010.3 (Test getNextReadyTask ordering logic)
- Dependencies:
  - TASK-010.1: Test getNextReadyTask when no tasks
- Related:
  - TASK-010.1, TASK-010.3, TASK-010.4: Other subtasks for getNextReadyTask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `getNextReadyTask` status filtering.

**Definition of Done**: "A test case is written that verifies `getNextReadyTask` only returns tasks with `status IN (0, 4)` and ignores tasks with other statuses. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify status filtering works so that only ready/in_progress tasks are returned.
   - **Acceptance Criteria**: 
     - Test verifies only status 0 and 4 tasks are considered
     - Test verifies other statuses are ignored
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('getNextReadyTask', () => {
  it('should only return tasks with status IN (0, 4)', () => {
    // Arrange: Insert tasks with various statuses
    const db = createTestDatabase();
    db.exec(`CREATE TABLE tasks (...)`);
    db.exec(`INSERT INTO tasks (id, prompt, "order", uuid, status) VALUES 
      (1, 'task1', 1, 'uuid1', 0),
      (2, 'task2', 2, 'uuid2', 4),
      (3, 'task3', 0, 'uuid3', 1),
      (4, 'task4', 0, 'uuid4', 2)`);
    const service = new DatabaseService(':memory:');
    
    // Act
    const result = service.getNextReadyTask();
    
    // Assert
    expect(result).not.toBeNull();
    expect(result.status).toBeIn([0, 4]);
    // Verify task 3 and 4 are not returned
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies status filtering

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getNextReadyTask status filtering test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies status filtering
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

