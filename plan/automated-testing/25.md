# TASK-025: Test handleCallback failure path

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.10
**Task ID**: TASK-025

## Description

Add a test case for the `handleCallback` method to verify it correctly handles failed task execution. The test should verify that when a valid `requestId` is received with failure result, the task status is reset to ready, the pending entry is removed, and the lock is released.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `handleCallback()` method failure path

## Current State

The `handleCallback` method:
- Receives callback with `requestId` and failure result (`success: false`)
- Looks up `requestId` in `pendingTasks` map to find associated `taskId`
- Calls `DatabaseService.updateTaskStatus(taskId, STATUS_READY)` to reset task to ready
- Removes pending task entry from map
- Releases the lock via `releaseLock()`

The test file `tests/services/task-operator-service.test.ts` exists with previous tests including TASK-024.

**Important**: This task should be executed after TASK-024.

## Checklist

### Preparation and Setup

- [ ] Review `handleCallback` failure path implementation
- [ ] Understand how task status is reset on failure
- [ ] Review error handling in callback processing
- [ ] Understand why tasks are reset to ready (for retry)

### Implementation Steps

- [ ] Step 1: Set up test for callback failure
  - [ ] Create test: `it('should reset task to ready and release lock on failed callback', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Seed `pendingTasks` map with entry: `{ requestId: 'req-123', taskId: 1, timestamp: Date.now() }`
    - [ ] Mock `DatabaseService.updateTaskStatus` to return `true` when called with `STATUS_READY` (0)
    - [ ] Mock Redis lock to be owned by current instance
    - [ ] Mock Redis `del` for `releaseLock()` call
  - [ ] Act: Call `handleCallback('req-123', { success: false, error: 'boom' })`
  - [ ] Assert: 
    - [ ] `updateTaskStatus(1, 0)` was called (reset to ready)
    - [ ] Pending task entry was removed from map
    - [ ] `releaseLock()` was invoked
    - [ ] Error information is handled (logged if applicable)

### Specific Requirements

- [ ] Requirement 1: Test must verify task reset
  - Acceptance: Task status is reset to ready (STATUS_READY = 0)
- [ ] Requirement 2: Test must verify pending task cleanup
  - Acceptance: Pending task entry is removed from map
- [ ] Requirement 3: Test must verify lock release
  - Acceptance: Lock is released after failed callback
- [ ] Requirement 4: Test must verify error handling
  - Acceptance: Error information from callback is handled appropriately

### Error Handling and Edge Cases

- [ ] Handle case where `updateTaskStatus` fails
- [ ] Handle case where error message is missing
- [ ] Verify lock is released even if status update fails
- [ ] Test with various error structures

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify all mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining callback failure flow
- [ ] Document why task is reset to ready (allows retry)
- [ ] Note error handling considerations

### Verification

- [ ] Verify test passes consistently
- [ ] Verify task reset works
- [ ] Verify pending task cleanup works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-024
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-024: Test handleCallback success path
- **Important Considerations**: 
  - Task is reset to ready to allow retry later
  - Failure doesn't mean task is permanently failed
  - Error information may be logged for debugging
  - Lock must be released to allow other processing
- **Task Independence**: Can be completed independently after TASK-024
- **Current State**: Test file exists with callback success test

## Related Tasks

- Previous: TASK-024 (Test handleCallback success path)
- Next: TASK-026 (Test isProcessing and clearLock)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-024: Test handleCallback success path
- Related:
  - TASK-024: Tested callback success
  - TASK-026: Will test utility methods

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for the `handleCallback` failure path.

**Definition of Done**: "A test case is written that verifies `handleCallback` correctly handles failed callbacks by resetting task status to ready, removing pending task entry, and releasing the lock. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify callback failure handling works so that failed tasks can be retried.
   - **Acceptance Criteria**: 
     - Test verifies task is reset to ready
     - Test verifies pending task is removed
     - Test verifies lock is released

2. **As a developer**, I want to verify error information is handled so that failures can be debugged.
   - **Acceptance Criteria**:
     - Test verifies error information is processed
     - Test verifies error is logged (if applicable)

### Automated Tests

The test case should be:

```typescript
it('should reset task to ready and release lock on failed callback', async () => {
  // Arrange: Seed pendingTasks, mock failure
  const requestId = 'req-123';
  const taskId = 1;
  const mockRedis = {
    get: jest.fn().mockResolvedValue(`${process.pid}-${Date.now()}-random`), // Own lock
    del: jest.fn().mockResolvedValue(1), // releaseLock
  };
  const mockDbService = {
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  
  const service = TaskOperatorService.getInstance(mockRedis);
  // Seed pendingTasks
  // Inject mocks
  
  // Act
  await service.handleCallback(requestId, { success: false, error: 'boom' });
  
  // Assert
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(taskId, 0); // STATUS_READY
  // Verify pending task removed
  // Verify releaseLock called
});
```

- [ ] Test case written and passes
- [ ] Test verifies task reset
- [ ] Test verifies pending task cleanup
- [ ] Test verifies lock release

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add handleCallback failure path test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies task reset
- [ ] Test verifies pending task cleanup
- [ ] Test verifies lock release
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
