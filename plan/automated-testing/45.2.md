# TASK-045.2: Add tests for POST /task-operator/callback - requestId validation

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.8.2
**Task ID**: TASK-045.2

## Description

Add test cases for the `POST /task-operator/callback` endpoint to verify it correctly validates requestId in the request body. The tests should verify that requestId is required and that both `requestId` and `request_id` field names are accepted.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator/callback` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `POST /task-operator/callback` endpoint:
- Validates requestId in body (checks both `requestId` and `request_id`)
- Returns 400 when requestId is missing

The test file `tests/app.test.ts` exists with previous tests including TASK-045.1.

**Important**: This task should be executed after TASK-045.1.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator/callback` endpoint requestId validation
- [ ] Understand requestId field name flexibility (requestId vs request_id)
- [ ] Review test setup from TASK-045.1

### Implementation Steps

- [ ] Step 1: Write tests for requestId validation
  - [ ] Create test: `it('should return 400 when requestId is missing', async () => { ... })`
    - [ ] Arrange: Valid secret, no requestId in body
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: 400, "requestId is required"
  - [ ] Create test: `it('should accept requestId from body', async () => { ... })`
    - [ ] Arrange: Valid secret, body with `requestId` field
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: Proceeds to callback processing (not 400)
  - [ ] Create test: `it('should accept request_id from body', async () => { ... })`
    - [ ] Arrange: Valid secret, body with `request_id` field
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: Proceeds to callback processing (not 400)

### Specific Requirements

- [ ] Requirement 1: Test must verify requestId validation
  - Acceptance: 400 returned when missing, accepts requestId or request_id
- [ ] Requirement 2: Test must verify field name flexibility
  - Acceptance: Both `requestId` and `request_id` are accepted

### Error Handling and Edge Cases

- [ ] Handle case where both requestId and request_id are present
- [ ] Verify requestId is extracted correctly
- [ ] Test with various requestId formats

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining requestId validation
- [ ] Document field name flexibility

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify validation works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-045.1
- **Dependencies**: 
  - TASK-045.1: Add tests for POST /task-operator/callback - secret authentication
- **Important Considerations**: 
  - requestId field name flexibility (requestId vs request_id) provides compatibility
  - This is the second of 4 subtasks for TASK-045
- **Task Independence**: Can be completed independently after TASK-045.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-045 (Add tests for /task-operator/callback endpoint)
- Previous: TASK-045.1 (Add tests for POST /task-operator/callback - secret authentication)
- Next: TASK-045.3 (Add tests for POST /task-operator/callback - successful processing)
- Dependencies:
  - TASK-045.1: Add tests for POST /task-operator/callback - secret authentication
- Related:
  - TASK-045.1, TASK-045.3, TASK-045.4: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for `POST /task-operator/callback` requestId validation.

**Definition of Done**: "Test cases are added that verify `POST /task-operator/callback` correctly validates requestId (returns 400 when missing, accepts requestId or request_id). All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify requestId validation works so that callbacks are properly identified.
   - **Acceptance Criteria**:
     - Test verifies 400 when requestId is missing
     - Test verifies requestId or request_id are accepted

### Automated Tests

Test cases should include:

```typescript
describe('POST /task-operator/callback', () => {
  it('should return 400 when requestId is missing', async () => {
    // Arrange: Valid secret, no requestId
    // Act: POST /task-operator/callback
    // Assert: 400, "requestId is required"
  });
  
  it('should accept requestId from body', async () => {
    // Arrange: Valid secret, body with requestId
    // Act & Assert: Proceeds to callback processing
  });
  
  it('should accept request_id from body', async () => {
    // Arrange: Valid secret, body with request_id
    // Act & Assert: Proceeds to callback processing
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify requestId validation
- [ ] Tests verify field name flexibility

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator/callback requestId validation tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify requestId validation
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

