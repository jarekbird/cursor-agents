# TASK-027: Test stale task cleanup (cleanupStaleTasks)

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.12
**Task ID**: TASK-027

**NOTE**: This task has been split into granular subtasks:
- **TASK-027.1**: Test cleanupStaleTasks - reset stale IN_PROGRESS tasks
- **TASK-027.2**: Test cleanupStaleTasks - lock release when no pending tasks remain

Please execute the subtasks (27.1, 27.2) instead of this parent task.

## Description

Add a test case for the `cleanupStaleTasks` method to verify it correctly identifies and cleans up stale tasks that have exceeded the timeout. The test should verify that tasks still IN_PROGRESS are reset to ready, completed tasks are not reset, and the lock is released if no pending tasks remain.

**This task has been split into subtasks - see TASK-027.1 and TASK-027.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `cleanupStaleTasks()` method

## Current State

The `cleanupStaleTasks` method:
- Iterates through `pendingTasks` map
- Checks if task timestamp exceeds `TASK_TIMEOUT_MS` (1 hour)
- For stale tasks still IN_PROGRESS, resets status to ready and removes from map
- For stale tasks that are COMPLETE, removes from map without resetting status
- If no pending tasks remain and lock exists, releases the lock

The test file `tests/services/task-operator-service.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-026, completing Phase 2.

## Checklist

### Preparation and Setup

- [ ] Review `cleanupStaleTasks` implementation
- [ ] Understand `TASK_TIMEOUT_MS` constant (1 hour)
- [ ] Review how stale tasks are identified (timestamp comparison)
- [ ] Understand status checking logic

### Implementation Steps

- [ ] Step 1: Set up test for stale task cleanup
  - [ ] Create test: `it('should reset stale IN_PROGRESS tasks to ready and remove from map', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Insert entries into `pendingTasks` with old timestamps (exceeding `TASK_TIMEOUT_MS`)
    - [ ] Task 1: `{ taskId: 1, requestId: 'req-1', timestamp: Date.now() - 2 * 60 * 60 * 1000 }` (2 hours ago, stale)
    - [ ] Task 2: `{ taskId: 2, requestId: 'req-2', timestamp: Date.now() - 2 * 60 * 60 * 1000 }` (2 hours ago, stale)
    - [ ] Mock `DatabaseService.getTaskStatus`:
      - [ ] Return `STATUS_IN_PROGRESS` (4) for task 1
      - [ ] Return `STATUS_COMPLETE` (1) for task 2
    - [ ] Mock `DatabaseService.updateTaskStatus` for reset to ready
  - [ ] Act: Call `cleanupStaleTasks()` (may need test-only access or trigger via `processNextTask`)
  - [ ] Assert: 
    - [ ] Task 1 (IN_PROGRESS) was reset to ready and removed from map
    - [ ] Task 2 (COMPLETE) was removed from map but NOT reset
    - [ ] `updateTaskStatus` was called only for task 1
- [ ] Step 2: Test lock release when no pending tasks remain
  - [ ] Create test: `it('should release lock when no pending tasks remain after cleanup', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Single stale task that gets cleaned up
    - [ ] Mock Redis to show lock exists
  - [ ] Act: Call `cleanupStaleTasks()`
  - [ ] Assert: `releaseLock()` was called

### Specific Requirements

- [ ] Requirement 1: Test must verify stale task identification
  - Acceptance: Tasks exceeding timeout are identified correctly
- [ ] Requirement 2: Test must verify IN_PROGRESS task reset
  - Acceptance: Stale IN_PROGRESS tasks are reset to ready
- [ ] Requirement 3: Test must verify COMPLETE task handling
  - Acceptance: Stale COMPLETE tasks are removed but not reset
- [ ] Requirement 4: Test must verify lock release
  - Acceptance: Lock is released when no pending tasks remain

### Error Handling and Edge Cases

- [ ] Handle case where `getTaskStatus` fails
- [ ] Handle case where `updateTaskStatus` fails
- [ ] Verify tasks within timeout are not cleaned up
- [ ] Test with empty pendingTasks map

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining stale task cleanup logic
- [ ] Document why COMPLETE tasks are not reset
- [ ] Note timeout value and rationale

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify stale task identification works
- [ ] Verify status-based cleanup works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-026 (completes Phase 2)
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-026: Test isProcessing and clearLock
- **Important Considerations**: 
  - Stale task cleanup prevents orphaned tasks from blocking processing
  - Timeout is 1 hour (`TASK_TIMEOUT_MS = 60 * 60 * 1000`)
  - Only IN_PROGRESS tasks are reset (COMPLETE tasks are just removed)
  - Lock release prevents deadlocks when all tasks are cleaned up
  - May need test-only access to `cleanupStaleTasks` or trigger via `processNextTask`
- **Task Independence**: Can be completed independently after TASK-026
- **Current State**: Test file exists with previous tests

## Related Tasks

- Previous: TASK-026 (Test isProcessing and clearLock)
- Next: TASK-028 (Extend queue-manager.test.ts for Redis scan discovery) - Starts Phase 3
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-026: Test isProcessing and clearLock
- Related:
  - TASK-020: Created pending tasks in happy path
  - TASK-024, TASK-025: Handled callback cleanup

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing test cases for the `cleanupStaleTasks` method.

**Definition of Done**: "Test cases are written that verify `cleanupStaleTasks` correctly identifies stale tasks, resets IN_PROGRESS tasks to ready, removes COMPLETE tasks without reset, and releases lock when no pending tasks remain. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify stale task cleanup works so that orphaned tasks don't block processing.
   - **Acceptance Criteria**: 
     - Test verifies stale tasks are identified correctly
     - Test verifies IN_PROGRESS tasks are reset to ready
     - Test verifies COMPLETE tasks are removed without reset

2. **As a developer**, I want to verify lock cleanup works so that locks are released when no work remains.
   - **Acceptance Criteria**:
     - Test verifies lock is released when no pending tasks remain
     - Test verifies cleanup doesn't affect non-stale tasks

### Automated Tests

Test cases should include:

```typescript
it('should reset stale IN_PROGRESS tasks to ready and remove from map', async () => {
  // Arrange: Stale tasks with old timestamps
  const staleTimestamp = Date.now() - 2 * 60 * 60 * 1000; // 2 hours ago
  const service = TaskOperatorService.getInstance(mockRedis);
  // Seed pendingTasks with stale entries
  service.pendingTasks.set('req-1', { taskId: 1, requestId: 'req-1', timestamp: staleTimestamp });
  service.pendingTasks.set('req-2', { taskId: 2, requestId: 'req-2', timestamp: staleTimestamp });
  
  const mockDbService = {
    getTaskStatus: jest.fn()
      .mockReturnValueOnce(4) // IN_PROGRESS for task 1
      .mockReturnValueOnce(1), // COMPLETE for task 2
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  // Inject mocks
  
  // Act: Call cleanupStaleTasks (may need test access)
  await service.cleanupStaleTasks();
  
  // Assert
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(1, 0); // Reset task 1 to ready
  expect(mockDbService.updateTaskStatus).not.toHaveBeenCalledWith(2, expect.anything()); // Task 2 not reset
  expect(service.pendingTasks.has('req-1')).toBe(false); // Removed
  expect(service.pendingTasks.has('req-2')).toBe(false); // Removed
});

it('should release lock when no pending tasks remain after cleanup', async () => {
  // Arrange: Single stale task, lock exists
  // Act: cleanupStaleTasks
  // Assert: releaseLock called
});
```

- [ ] All test cases written and pass
- [ ] Tests cover stale task identification
- [ ] Tests cover IN_PROGRESS reset and COMPLETE removal
- [ ] Tests cover lock release

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add cleanupStaleTasks comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover stale task cleanup scenarios
- [ ] Tests verify status-based handling
- [ ] Tests verify lock release
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 2 (TaskOperatorService Unit Tests) is complete**
