# TASK-031.2: Test addDelayedAgent - task-operator with existing jobs

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.4.2
**Task ID**: TASK-031.2

## Description

Add a test case for the `addDelayedAgent` method to verify it correctly handles the task-operator queue when jobs already exist. The test should verify that the method returns null and logs a skip message when jobs exist.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `addDelayedAgent()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `addDelayedAgent` method:
- For task-operator queue: checks `hasExistingJobs` first
- If jobs exist: returns `null` and logs skip message

The test file `tests/queue/queue-manager.test.ts` exists with previous tests including TASK-031.1.

**Important**: This task should be executed after TASK-031.1.

## Checklist

### Preparation and Setup

- [ ] Review `addDelayedAgent` task-operator special handling
- [ ] Understand `hasExistingJobs` usage (from TASK-030)
- [ ] Review test setup from TASK-031.1

### Implementation Steps

- [ ] Step 1: Write test for task-operator with existing jobs
  - [ ] Create test: `it('should return null and log skip for task-operator when jobs exist', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Queue name `'task-operator'`
    - [ ] Mock `hasExistingJobs` to return `true`
  - [ ] Act: Call `addDelayedAgent(queue, config, delay)`
  - [ ] Assert: 
    - [ ] Returns `null`
    - [ ] Skip message logged
    - [ ] Queue `add` not called

### Specific Requirements

- [ ] Requirement 1: Test must verify task-operator skip logic
  - Acceptance: Returns `null` when jobs exist, logs skip
- [ ] Requirement 2: Test must verify no job creation
  - Acceptance: Queue `add` is not called

### Error Handling and Edge Cases

- [ ] Handle case where `hasExistingJobs` throws
- [ ] Verify skip message is descriptive

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining task-operator special handling
- [ ] Document why existing jobs prevent new task-operator jobs

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify skip logic works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-031.1
- **Dependencies**: 
  - TASK-031.1: Test addDelayedAgent - non-task-operator queue
- **Important Considerations**: 
  - Task-operator queue should only have one job at a time
  - Skip logic prevents duplicate task processing
  - This is the second of 3 subtasks for TASK-031
- **Task Independence**: Can be completed independently after TASK-031.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-031 (Add tests for addDelayedAgent)
- Previous: TASK-031.1 (Test addDelayedAgent - non-task-operator queue)
- Next: TASK-031.3 (Test addDelayedAgent - task-operator with no existing jobs)
- Dependencies:
  - TASK-031.1: Test addDelayedAgent - non-task-operator queue
- Related:
  - TASK-031.1, TASK-031.3: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `addDelayedAgent` when task-operator queue has existing jobs.

**Definition of Done**: "A test case is written that verifies `addDelayedAgent` correctly returns null and logs a skip message for task-operator queue when jobs exist. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify task-operator skip logic works so that duplicate task processing is prevented.
   - **Acceptance Criteria**:
     - Test verifies skip when jobs exist
     - Test verifies skip message is logged

### Automated Tests

The test case should be:

```typescript
describe('addDelayedAgent', () => {
  it('should return null and log skip for task-operator when jobs exist', async () => {
    // Arrange: task-operator queue, hasExistingJobs returns true
    const mockQueue = { add: jest.fn() };
    const queueManager = new QueueManager(mockRedis);
    jest.spyOn(queueManager, 'hasExistingJobs').mockResolvedValue(true);
    
    // Act
    const result = await queueManager.addDelayedAgent(mockQueue, config, delay);
    
    // Assert
    expect(result).toBeNull();
    expect(mockQueue.add).not.toHaveBeenCalled();
    // Verify skip logged
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify task-operator skip logic

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add addDelayedAgent task-operator existing jobs test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify skip logic
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

