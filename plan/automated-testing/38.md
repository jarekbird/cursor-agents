# TASK-038: Extend app.test.ts for Bull Board base path

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.1
**Task ID**: TASK-038

**NOTE**: This task has been split into granular subtasks:
- **TASK-038.1**: Test Bull Board base path - configuration
- **TASK-038.2**: Test Bull Board base path - dashboard accessibility

Please execute the subtasks (38.1, 38.2) instead of this parent task.

## Description

Extend the existing `tests/app.test.ts` file to add test cases for Bull Board base path configuration. The tests should verify that when `BULL_BOARD_BASE_PATH` environment variable is set, the Express adapter's base path is configured correctly and the dashboard is accessible at the configured path.

**This task has been split into subtasks - see TASK-038.1 and TASK-038.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - Bull Board setup with base path
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `CursorAgentsApp` class:
- Configures Bull Board with optional base path from `process.env.BULL_BOARD_BASE_PATH`
- Calls `ExpressAdapter.setBasePath()` if base path is provided
- Mounts Bull Board dashboard at `/admin/queues` (or configured path)
- Dashboard should be accessible via GET request

The test file `tests/app.test.ts` already exists with some tests but may not cover base path configuration.

**Important**: This task should be executed after Phase 4 (TASK-035 through TASK-037).

## Checklist

### Preparation and Setup

- [ ] Review `CursorAgentsApp` Bull Board setup implementation
- [ ] Understand `ExpressAdapter.setBasePath()` usage
- [ ] Review existing `app.test.ts` structure
- [ ] Understand environment variable handling in tests

### Implementation Steps

- [ ] Step 1: Set up test for base path configuration
  - [ ] Create test: `it('should configure Bull Board base path from environment variable', () => { ... })`
  - [ ] Arrange: 
    - [ ] Set `process.env.BULL_BOARD_BASE_PATH = '/agents/admin/queues'`
    - [ ] Mock `ExpressAdapter.setBasePath`
    - [ ] Create app instance
  - [ ] Act: Initialize app (may happen in constructor or separate method)
  - [ ] Assert: 
    - [ ] `ExpressAdapter.setBasePath` was called with `/agents/admin/queues`
- [ ] Step 2: Write test for dashboard accessibility
  - [ ] Create test: `it('should serve Bull Board dashboard at configured base path', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Set `process.env.BULL_BOARD_BASE_PATH = '/agents/admin/queues'`
    - [ ] Create app instance
  - [ ] Act: Make GET request to `/admin/queues` (or configured path)
  - [ ] Assert: 
    - [ ] Response status is 200
    - [ ] Response contains HTML (Bull Board dashboard)

### Specific Requirements

- [ ] Requirement 1: Test must verify base path configuration
  - Acceptance: `setBasePath` is called with correct value
- [ ] Requirement 2: Test must verify dashboard accessibility
  - Acceptance: Dashboard is accessible at configured path
- [ ] Requirement 3: Test must verify environment variable usage
  - Acceptance: Base path comes from environment variable
- [ ] Requirement 4: Test must clean up environment
  - Acceptance: Environment variable is restored after test

### Error Handling and Edge Cases

- [ ] Handle case where base path is not set (default behavior)
- [ ] Handle case where base path has trailing slash
- [ ] Verify base path is applied correctly
- [ ] Test with various base path values

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining base path configuration
- [ ] Document environment variable usage
- [ ] Note Bull Board setup behavior

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify base path configuration works
- [ ] Verify dashboard accessibility works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after Phase 4 (TASK-035 through TASK-037)
- **Dependencies**: 
  - TASK-035 through TASK-037: Phase 4 PromptProcessor tests
- **Important Considerations**: 
  - Base path allows Bull Board to work behind reverse proxies
  - Environment variable should be set in test, then cleaned up
  - Mocking `ExpressAdapter.setBasePath` may require careful setup
  - Dashboard HTML response indicates successful mounting
  - Existing test file should be extended, not replaced
- **Task Independence**: Can be completed independently after Phase 4
- **Current State**: Test file exists but may not cover base path configuration

## Related Tasks

- Previous: TASK-037 (Add tests for task-operator internal jobs) - Completes Phase 4
- Next: TASK-039 (Add tests for /admin/queues/refresh)
- Dependencies:
  - TASK-035 through TASK-037: Phase 4 tests
- Related:
  - TASK-039 through TASK-045: Will add more HTTP/API tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves extending existing tests for Bull Board base path configuration.

**Definition of Done**: "Test cases are added to `tests/app.test.ts` that verify Bull Board base path is configured from environment variable and dashboard is accessible at configured path. Tests verify `ExpressAdapter.setBasePath` is called correctly. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify base path configuration works so that Bull Board works behind reverse proxies.
   - **Acceptance Criteria**: 
     - Test verifies `setBasePath` is called with correct value
     - Test verifies dashboard is accessible
     - Test passes consistently

2. **As a developer**, I want to verify environment variable handling works so that configuration is flexible.
   - **Acceptance Criteria**:
     - Test verifies base path comes from environment variable
     - Test verifies environment is cleaned up after test

### Automated Tests

Test cases should include:

```typescript
describe('Bull Board base path', () => {
  beforeEach(() => {
    // Save original env
    originalBasePath = process.env.BULL_BOARD_BASE_PATH;
  });
  
  afterEach(() => {
    // Restore original env
    if (originalBasePath) {
      process.env.BULL_BOARD_BASE_PATH = originalBasePath;
    } else {
      delete process.env.BULL_BOARD_BASE_PATH;
    }
  });
  
  it('should configure Bull Board base path from environment variable', () => {
    // Arrange
    process.env.BULL_BOARD_BASE_PATH = '/agents/admin/queues';
    const setBasePathSpy = jest.spyOn(ExpressAdapter.prototype, 'setBasePath');
    
    // Act: Create app instance
    const app = new CursorAgentsApp();
    
    // Assert
    expect(setBasePathSpy).toHaveBeenCalledWith('/agents/admin/queues');
  });
  
  it('should serve Bull Board dashboard at configured base path', async () => {
    // Arrange: Set base path, create app
    // Act: GET /admin/queues
    // Assert: 200, HTML response
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify base path configuration
- [ ] Tests verify dashboard accessibility
- [ ] Tests clean up environment

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add Bull Board base path tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify base path configuration
- [ ] Tests verify dashboard accessibility
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
