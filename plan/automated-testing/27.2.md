# TASK-027.2: Test cleanupStaleTasks - lock release when no pending tasks remain

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.12.2
**Task ID**: TASK-027.2

## Description

Add a test case for the `cleanupStaleTasks` method to verify it correctly releases the lock when no pending tasks remain after cleanup. This verifies lock management after cleanup.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `cleanupStaleTasks()` method

## Current State

The `cleanupStaleTasks` method:
- If no pending tasks remain and lock exists, releases the lock

The test file `tests/services/task-operator-service.test.ts` exists with previous tests including TASK-027.1.

**Important**: This task should be executed after TASK-027.1, completing TASK-027.

## Checklist

### Preparation and Setup

- [ ] Review `cleanupStaleTasks` lock release logic
- [ ] Understand when lock should be released
- [ ] Review test setup from TASK-027.1

### Implementation Steps

- [ ] Step 1: Write test for lock release
  - [ ] Create test: `it('should release lock when no pending tasks remain after cleanup', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Single stale task that gets cleaned up
    - [ ] Mock Redis to show lock exists
    - [ ] Mock `releaseLock` method
  - [ ] Act: Call `cleanupStaleTasks()`
  - [ ] Assert: `releaseLock()` was called

### Specific Requirements

- [ ] Requirement 1: Test must verify lock release
  - Acceptance: Lock is released when no pending tasks remain
- [ ] Requirement 2: Test must verify cleanup completes first
  - Acceptance: Tasks are cleaned up before lock release
- [ ] Requirement 3: Test must verify lock exists check
  - Acceptance: Lock release only occurs if lock exists

### Error Handling and Edge Cases

- [ ] Handle case where lock doesn't exist (should not call releaseLock)
- [ ] Verify lock release occurs after cleanup
- [ ] Test with various cleanup scenarios

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining lock release logic
- [ ] Document why lock is released after cleanup

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify lock release works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-027.1 (completes TASK-027 and Phase 2)
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-027.1: Test cleanupStaleTasks - reset stale IN_PROGRESS tasks
- **Important Considerations**: 
  - Lock release prevents deadlocks when all tasks are cleaned up
  - Lock should only be released if it exists
  - This is the second and final subtask for TASK-027
- **Task Independence**: Can be completed independently after TASK-027.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-027 (Test stale task cleanup)
- Previous: TASK-027.1 (Test cleanupStaleTasks - reset stale IN_PROGRESS tasks)
- Next: TASK-028 (Extend queue-manager.test.ts for Redis scan discovery) - Starts Phase 3
- Dependencies:
  - TASK-027.1: Test cleanupStaleTasks - reset stale IN_PROGRESS tasks
- Related:
  - TASK-027.1: Tested stale task cleanup logic

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `cleanupStaleTasks` to verify lock release.

**Definition of Done**: "A test case is written that verifies `cleanupStaleTasks` correctly releases the lock when no pending tasks remain after cleanup. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify lock cleanup works so that locks are released when no work remains.
   - **Acceptance Criteria**: 
     - Test verifies lock is released when no pending tasks remain
     - Test verifies cleanup doesn't affect non-stale tasks

### Automated Tests

The test case should be:

```typescript
it('should release lock when no pending tasks remain after cleanup', async () => {
  // Arrange: Single stale task, lock exists
  const staleTimestamp = Date.now() - 2 * 60 * 60 * 1000;
  const service = TaskOperatorService.getInstance(mockRedis);
  service.pendingTasks.set('req-1', { taskId: 1, requestId: 'req-1', timestamp: staleTimestamp });
  
  const mockDbService = {
    getTaskStatus: jest.fn().mockReturnValue(4), // IN_PROGRESS
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  const releaseLockSpy = jest.spyOn(service, 'releaseLock');
  // Inject mocks
  
  // Act: cleanupStaleTasks
  await service.cleanupStaleTasks();
  
  // Assert: releaseLock called
  expect(releaseLockSpy).toHaveBeenCalled();
});
```

- [ ] Test case written and passes
- [ ] Test verifies lock release

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add cleanupStaleTasks lock release test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies lock release
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-027 (all subtasks) is complete**
- [ ] **Phase 2 (TaskOperatorService Unit Tests) is complete**

