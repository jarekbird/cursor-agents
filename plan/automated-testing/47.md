# TASK-047: Add tests for queue-related MCP tools

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.2
**Task ID**: TASK-047

**NOTE**: This task has been split into granular subtasks:
- **TASK-047.1**: Add tests for list_queues MCP tool
- **TASK-047.2**: Add tests for get_queue_info MCP tool
- **TASK-047.3**: Add tests for delete_queue MCP tool

Please execute the subtasks (47.1, 47.2, 47.3) instead of this parent task.

## Description

Add comprehensive test cases for queue-related MCP tools: `list_queues`, `get_queue_info`, and `delete_queue`. The tests should verify they correctly interact with QueueManager and return appropriate JSON responses for success and error cases.

**This task has been split into subtasks - see TASK-047.1 through TASK-047.3**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - queue-related tool handlers
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The queue-related MCP tools:
- `list_queues`: Lists all queues with their info
- `get_queue_info`: Gets detailed info for a specific queue
- `delete_queue`: Deletes a queue

The test file `tests/mcp/server.test.ts` exists but may not have comprehensive queue-related tool tests.

**Important**: This task should be executed after TASK-046.

## Checklist

### Preparation and Setup

- [ ] Review queue-related MCP tool implementations
- [ ] Understand `QueueManager.listQueues` and `getQueueInfo` usage
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand MCP error response format (`isError: true`)

### Implementation Steps

- [ ] Step 1: Write tests for `list_queues`
  - [ ] Create test: `it('should list all queues with info', async () => { ... })`
    - [ ] Arrange: Mock `listQueues` and `getQueueInfo` to return queue objects
    - [ ] Act: Call `list_queues` tool
    - [ ] Assert: 
      - [ ] JSON contains `queues` array
      - [ ] Queue objects have expected structure
      - [ ] All queues are included
- [ ] Step 2: Write tests for `get_queue_info`
  - [ ] Create test: `it('should return queue info for existing queue', async () => { ... })`
    - [ ] Arrange: Mock `getQueueInfo` to return queue object
    - [ ] Act: Call `get_queue_info` tool with queue name
    - [ ] Assert: JSON contains queue info
  - [ ] Create test: `it('should return error when queue not found', async () => { ... })`
    - [ ] Arrange: `getQueueInfo` returns `null`
    - [ ] Act: Call `get_queue_info` tool
    - [ ] Assert: JSON has `isError: true` and error message
- [ ] Step 3: Write tests for `delete_queue`
  - [ ] Create test: `it('should delete queue successfully', async () => { ... })`
    - [ ] Arrange: Mock `deleteQueue` to resolve
    - [ ] Act: Call `delete_queue` tool
    - [ ] Assert: JSON contains success message
  - [ ] Create test: `it('should return error when queue cannot be deleted', async () => { ... })`
    - [ ] Arrange: `deleteQueue` throws error
    - [ ] Act: Call `delete_queue` tool
    - [ ] Assert: JSON has `isError: true` with error message

### Specific Requirements

- [ ] Requirement 1: Test must verify list_queues
  - Acceptance: Returns queues array with correct structure
- [ ] Requirement 2: Test must verify get_queue_info
  - Acceptance: Returns queue info for existing, error for missing
- [ ] Requirement 3: Test must verify delete_queue
  - Acceptance: Returns success on deletion, error on failure
- [ ] Requirement 4: Test must verify error format
  - Acceptance: Errors have `isError: true` and descriptive messages

### Error Handling and Edge Cases

- [ ] Handle case where listQueues throws
- [ ] Handle case where getQueueInfo throws
- [ ] Verify error messages are descriptive
- [ ] Test with various queue states

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining queue tool behavior
- [ ] Document error response format
- [ ] Note queue info structure

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify queue tools work correctly
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-046
- **Dependencies**: 
  - TASK-046: Extend mcp/server.test.ts for JSON payload assertions
- **Important Considerations**: 
  - Queue tools provide MCP access to queue management
  - Error responses use `isError: true` format
  - Queue info structure should match QueueManager output
  - Error messages should be user-friendly
- **Task Independence**: Can be completed independently after TASK-046
- **Current State**: Test file exists but may not have comprehensive queue tool tests

## Related Tasks

- Previous: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions)
- Next: TASK-048 (Add tests for MCP resources (agents))
- Dependencies:
  - TASK-046: Extend mcp/server.test.ts for JSON payload assertions
- Related:
  - TASK-048, TASK-049: Will add more MCP tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for queue-related MCP tools.

**Definition of Done**: "Test cases are added that verify `list_queues`, `get_queue_info`, and `delete_queue` MCP tools correctly interact with QueueManager and return appropriate JSON responses. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue listing works so that MCP clients can see all queues.
   - **Acceptance Criteria**: 
     - Test verifies queues array is returned
     - Test verifies queue info structure is correct
     - Test passes consistently

2. **As a developer**, I want to verify queue info retrieval works so that MCP clients can inspect queues.
   - **Acceptance Criteria**:
     - Test verifies existing queues return info
     - Test verifies missing queues return error

3. **As a developer**, I want to verify queue deletion works so that MCP clients can delete queues.
   - **Acceptance Criteria**:
     - Test verifies successful deletion returns success
     - Test verifies errors return isError format

### Automated Tests

Test cases should include:

```typescript
describe('queue-related MCP tools', () => {
  it('list_queues should return queues array', async () => {
    // Arrange: Mock listQueues and getQueueInfo
    mockQueueManager.listQueues.mockReturnValue(['q1', 'q2']);
    mockQueueManager.getQueueInfo.mockImplementation((name) => ({
      name,
      waiting: 0,
      active: 0,
    }));
    
    // Act: Call list_queues tool
    // Assert: JSON contains queues array with queue info
  });
  
  it('get_queue_info should return queue info for existing queue', async () => {
    // Arrange: getQueueInfo returns queue object
    // Act: Call get_queue_info tool
    // Assert: JSON contains queue info
  });
  
  it('get_queue_info should return error when queue not found', async () => {
    // Arrange: getQueueInfo returns null
    // Act: Call get_queue_info tool
    // Assert: JSON has isError: true, error message
  });
  
  it('delete_queue should delete queue successfully', async () => {
    // Arrange: deleteQueue resolves
    // Act: Call delete_queue tool
    // Assert: JSON contains success message
  });
  
  it('delete_queue should return error when queue cannot be deleted', async () => {
    // Arrange: deleteQueue throws
    // Act: Call delete_queue tool
    // Assert: JSON has isError: true, error message
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify list_queues
- [ ] Tests verify get_queue_info
- [ ] Tests verify delete_queue

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add queue-related MCP tools tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify all queue tools
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
