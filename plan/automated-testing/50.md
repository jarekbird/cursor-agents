# TASK-050: Enhance integration.test.ts for richer agent lifecycle

**Section**: 7. Integration & E2E-lite Scenarios
**Subsection**: 7.1
**Task ID**: TASK-050

## Description

Enhance the existing `tests/integration.test.ts` file to add a comprehensive agent lifecycle integration test. The test should use the real `CursorAgentsApp` with a mocked `QueueManager` that retains state, and verify the complete agent lifecycle: create, check status, delete, verify deletion.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - CursorAgentsApp
- `virtual-assistant/cursor-agents/tests/integration.test.ts` - existing test structure

## Current State

The `tests/integration.test.ts` file exists with some integration tests but may not have a comprehensive agent lifecycle test that verifies state retention across multiple API calls.

The test should use real app instance with stateful QueueManager mock to simulate production behavior.

**Important**: This task should be executed after Phase 6 (TASK-046 through TASK-049).

## Checklist

### Preparation and Setup

- [ ] Review existing `integration.test.ts` structure
- [ ] Understand how to create stateful QueueManager mock
- [ ] Review CursorAgentsApp initialization
- [ ] Understand agent lifecycle flow

### Implementation Steps

- [ ] Step 1: Set up stateful QueueManager mock
  - [ ] Create mock QueueManager that retains state (agents map, queues map)
  - [ ] Mock methods to update and read from state
  - [ ] Ensure state persists across API calls
- [ ] Step 2: Write comprehensive agent lifecycle test
  - [ ] Create test: `it('should handle complete agent lifecycle', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Create real `CursorAgentsApp` with stateful QueueManager mock
    - [ ] Set up app instance
  - [ ] Act & Assert Steps:
    - [ ] Step 1: POST `/agents` to create agent
      - [ ] Assert: 200, agent created
    - [ ] Step 2: GET `/agents/:name` to check status
      - [ ] Assert: 200, agent status returned
    - [ ] Step 3: DELETE `/agents/:name` to delete agent
      - [ ] Assert: 200, agent deleted
    - [ ] Step 4: GET `/agents/:name` to verify deletion
      - [ ] Assert: 404, agent not found

### Specific Requirements

- [ ] Requirement 1: Test must use real app instance
  - Acceptance: Real `CursorAgentsApp` is used
- [ ] Requirement 2: Test must use stateful mock
  - Acceptance: QueueManager mock retains state across calls
- [ ] Requirement 3: Test must verify complete lifecycle
  - Acceptance: Create, status, delete, verify deletion all work
- [ ] Requirement 4: Test must verify state consistency
  - Acceptance: State changes are reflected in subsequent calls

### Error Handling and Edge Cases

- [ ] Handle case where agent is created but status check fails
- [ ] Handle case where deletion fails
- [ ] Verify state is consistent throughout lifecycle
- [ ] Test with various agent configurations

### Testing

- [ ] Run `npm run test:http` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining integration test approach
- [ ] Document stateful mock pattern
- [ ] Note why real app instance is used

### Verification

- [ ] Verify test passes consistently
- [ ] Verify agent lifecycle works end-to-end
- [ ] Verify state retention works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 7 â€“ Integration & E2E-lite Scenarios**
- **Execution Timing**: Should be executed after Phase 6 (TASK-046 through TASK-049)
- **Dependencies**: 
  - TASK-046 through TASK-049: Phase 6 MCP tests
- **Important Considerations**: 
  - Integration tests verify multiple components working together
  - Stateful mock simulates production behavior
  - Real app instance ensures actual integration
  - Lifecycle test verifies complete workflow
  - Existing test file should be enhanced, not replaced
- **Task Independence**: Can be completed independently after Phase 6
- **Current State**: Test file exists but may not have comprehensive lifecycle test

## Related Tasks

- Previous: TASK-049 (Add logging expectation tests) - Completes Phase 6
- Next: TASK-051 (Add task-operator lifecycle integration test)
- Dependencies:
  - TASK-046 through TASK-049: Phase 6 tests
- Related:
  - TASK-051, TASK-052: Will add more integration tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves enhancing existing integration tests with a comprehensive agent lifecycle test.

**Definition of Done**: "A comprehensive agent lifecycle integration test is added that uses real CursorAgentsApp with stateful QueueManager mock and verifies complete agent lifecycle (create, status, delete, verify deletion). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent lifecycle works end-to-end so that I can trust the complete workflow.
   - **Acceptance Criteria**: 
     - Test verifies agent can be created
     - Test verifies agent status can be retrieved
     - Test verifies agent can be deleted
     - Test verifies deletion is reflected

2. **As a developer**, I want to verify state retention works so that stateful operations function correctly.
   - **Acceptance Criteria**:
     - Test verifies state persists across API calls
     - Test verifies state changes are reflected

### Automated Tests

The test case should be:

```typescript
describe('Agent lifecycle integration', () => {
  it('should handle complete agent lifecycle', async () => {
    // Arrange: Real app with stateful QueueManager mock
    const statefulQueueManager = createStatefulQueueManagerMock();
    const app = new CursorAgentsApp(statefulQueueManager);
    const agentName = 'test-agent';
    
    // Step 1: Create agent
    const createResponse = await request(app.getApp())
      .post('/agents')
      .send({
        name: agentName,
        targetUrl: 'http://example.com',
        oneTime: true,
      })
      .expect(200);
    expect(createResponse.body).toHaveProperty('success', true);
    
    // Step 2: Check status
    const statusResponse = await request(app.getApp())
      .get(`/agents/${agentName}`)
      .expect(200);
    expect(statusResponse.body).toHaveProperty('name', agentName);
    
    // Step 3: Delete agent
    const deleteResponse = await request(app.getApp())
      .delete(`/agents/${agentName}`)
      .expect(200);
    expect(deleteResponse.body).toHaveProperty('success', true);
    
    // Step 4: Verify deletion
    await request(app.getApp())
      .get(`/agents/${agentName}`)
      .expect(404);
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies complete lifecycle
- [ ] Test uses stateful mock
- [ ] Test uses real app instance

### Git Commit and Push Requirements

- [ ] Test case added to `tests/integration.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance integration test with agent lifecycle")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies complete lifecycle
- [ ] Test uses stateful mock
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
