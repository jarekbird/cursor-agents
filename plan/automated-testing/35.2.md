# TASK-035.2: Test re-enqueueing - config preservation

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.1.2
**Task ID**: TASK-035.2

## Description

Add a test case for the `PromptProcessor.process()` method to verify it correctly preserves the original agent config when re-enqueueing. The test should verify that the config passed to `addDelayedAgent` is identical to the original config with no modifications.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - re-enqueueing logic
- `virtual-assistant/cursor-agents/tests/queue/prompt-processor.test.ts` - existing test structure

## Current State

The `PromptProcessor.process()` method:
- Calls `QueueManager.addDelayedAgent()` with agent config and delay
- Should preserve original agent config exactly

The test file `tests/queue/prompt-processor.test.ts` exists with previous tests including TASK-035.1.

**Important**: This task should be executed after TASK-035.1, completing TASK-035.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` config handling
- [ ] Understand how agent config is passed to addDelayedAgent
- [ ] Review test setup from TASK-035.1

### Implementation Steps

- [ ] Step 1: Write test for config preservation
  - [ ] Create test: `it('should preserve original agent config when re-enqueueing', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Agent job data with specific config
    - [ ] Mock HTTP response with `{ requeue: true, delay: 5000 }`
    - [ ] Set up spy on `addDelayedAgent`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] Original agent config is passed to `addDelayedAgent`
    - [ ] No modifications to config
    - [ ] Config object is identical (deep equality)

### Specific Requirements

- [ ] Requirement 1: Test must verify config preservation
  - Acceptance: Original agent config is preserved
- [ ] Requirement 2: Test must verify no modifications
  - Acceptance: No modifications to config

### Error Handling and Edge Cases

- [ ] Test with various config structures
- [ ] Verify config is not mutated
- [ ] Test with nested config objects

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining config preservation
- [ ] Note that config must be preserved exactly

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify config preservation works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after TASK-035.1 (completes TASK-035)
- **Dependencies**: 
  - TASK-035.1: Test re-enqueueing - trigger and delay extraction
- **Important Considerations**: 
  - Agent config must be preserved exactly
  - This is the second and final subtask for TASK-035
- **Task Independence**: Can be completed independently after TASK-035.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-035 (Extend prompt-processor.test.ts for re-enqueueing)
- Previous: TASK-035.1 (Test re-enqueueing - trigger and delay extraction)
- Next: TASK-036 (Add tests for no re-enqueue conditions)
- Dependencies:
  - TASK-035.1: Test re-enqueueing - trigger and delay extraction
- Related:
  - TASK-035.1: Other subtask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for re-enqueueing config preservation.

**Definition of Done**: "A test case is written that verifies re-enqueueing preserves the original agent config exactly with no modifications. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify config preservation works so that agent settings are maintained.
   - **Acceptance Criteria**:
     - Test verifies original agent config is preserved
     - Test verifies no modifications to config

### Automated Tests

The test case should be:

```typescript
describe('re-enqueueing', () => {
  it('should preserve original agent config when re-enqueueing', async () => {
    // Arrange: Agent config with specific values
    const originalConfig = {
      name: 'test-agent',
      targetUrl: 'http://example.com',
      method: 'GET',
      headers: { 'X-Custom': 'value' },
    };
    
    // Act: Process with requeue: true
    // Assert: Config passed to addDelayedAgent is identical
    expect(mockQueueManager.addDelayedAgent).toHaveBeenCalledWith(
      expect.anything(),
      originalConfig, // Same config object
      expect.any(Number)
    );
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify config preservation

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add re-enqueueing config preservation test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify config preservation
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-035 (all subtasks) is complete**

