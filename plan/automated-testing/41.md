# TASK-041: Add tests for /queues/:queueName DELETE

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.4
**Task ID**: TASK-041

**NOTE**: This task has been split into granular subtasks:
- **TASK-041.1**: Test DELETE /queues/:queueName - successful deletion
- **TASK-041.2**: Test DELETE /queues/:queueName - error handling

Please execute the subtasks (41.1, 41.2) instead of this parent task.

## Description

Add test cases for the `DELETE /queues/:queueName` endpoint to verify it correctly deletes queues. The tests should verify the happy path (successful deletion) and error path (queue has jobs or cannot be deleted).

**This task has been split into subtasks - see TASK-041.1 and TASK-041.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `DELETE /queues/:queueName` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `DELETE /queues/:queueName` endpoint:
- Accepts DELETE requests with queue name parameter
- Calls `queueManager.deleteQueue(queueName)`
- Returns 200 with `{ success: true, message: <string> }` on success
- Returns 500 with error message when `deleteQueue` throws (e.g., queue has jobs, is default queue)

The test file `tests/app.test.ts` exists but may not have comprehensive DELETE queue tests.

**Important**: This task should be executed after TASK-040.

## Checklist

### Preparation and Setup

- [ ] Review `DELETE /queues/:queueName` endpoint implementation
- [ ] Understand `deleteQueue` method behavior and error cases
- [ ] Review existing `app.test.ts` structure
- [ ] Understand queue deletion validation

### Implementation Steps

- [ ] Step 1: Write test for happy path
  - [ ] Create test: `it('should delete queue successfully', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `queueManager.deleteQueue` to resolve successfully
    - [ ] Create app instance
  - [ ] Act: DELETE `/queues/q1` using `supertest`
  - [ ] Assert: 
    - [ ] Response status is 200
    - [ ] Response body is `{ success: true, message: <string> }`
    - [ ] `deleteQueue` was called with correct queue name
- [ ] Step 2: Write test for queue with jobs error
  - [ ] Create test: `it('should return 500 when queue has jobs', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `deleteQueue` to throw error with message about remaining jobs
  - [ ] Act: DELETE `/queues/q1`
  - [ ] Assert: 
    - [ ] Response status is 500
    - [ ] Response body contains error message (propagated from `deleteQueue`)

### Specific Requirements

- [ ] Requirement 1: Test must verify successful deletion
  - Acceptance: Returns 200 with success message
- [ ] Requirement 2: Test must verify error handling
  - Acceptance: Returns 500 with error message on failure
- [ ] Requirement 3: Test must verify error message propagation
  - Acceptance: Error message from `deleteQueue` is propagated
- [ ] Requirement 4: Test must verify endpoint method
  - Acceptance: Endpoint accepts DELETE requests

### Error Handling and Edge Cases

- [ ] Handle case where queue is default queue (covered in TASK-034 unit tests)
- [ ] Handle case where queue doesn't exist
- [ ] Verify error messages are descriptive
- [ ] Test with various error types

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining queue deletion endpoint
- [ ] Document error message propagation
- [ ] Note validation behavior

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify queue deletion works
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-040
- **Dependencies**: 
  - TASK-040: Add tests for /queues/:queueName
- **Important Considerations**: 
  - Queue deletion endpoint allows queue cleanup
  - Error messages should be descriptive
  - Error propagation ensures users see actual error
  - Validation happens in `deleteQueue` (tested in TASK-034)
- **Task Independence**: Can be completed independently after TASK-040
- **Current State**: Test file exists but may not have comprehensive DELETE queue tests

## Related Tasks

- Previous: TASK-040 (Add tests for /queues/:queueName)
- Next: TASK-042 (Add tests for /agents endpoints)
- Dependencies:
  - TASK-040: Add tests for /queues/:queueName
- Related:
  - TASK-034: Tested deleteQueue validation in unit tests
  - TASK-042: Will test agent endpoints

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `DELETE /queues/:queueName` endpoint.

**Definition of Done**: "Test cases are added that verify `DELETE /queues/:queueName` correctly deletes queues (200 with success message) and handles errors gracefully (500 with error message). All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue deletion works so that queues can be cleaned up.
   - **Acceptance Criteria**: 
     - Test verifies successful deletion returns 200
     - Test verifies success message is returned
     - Test passes consistently

2. **As a developer**, I want to verify error handling works so that deletion failures are communicated clearly.
   - **Acceptance Criteria**:
     - Test verifies 500 error is returned on failure
     - Test verifies error message is propagated

### Automated Tests

Test cases should include:

```typescript
describe('DELETE /queues/:queueName', () => {
  it('should delete queue successfully', async () => {
    // Arrange: Mock deleteQueue to resolve
    mockQueueManager.deleteQueue.mockResolvedValue(undefined);
    
    // Act
    const response = await request(app.getApp())
      .delete('/queues/q1')
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      success: true,
      message: expect.any(String),
    });
    expect(mockQueueManager.deleteQueue).toHaveBeenCalledWith('q1');
  });
  
  it('should return 500 when queue has jobs', async () => {
    // Arrange: deleteQueue throws error
    const error = new Error('Queue has remaining jobs');
    mockQueueManager.deleteQueue.mockRejectedValue(error);
    
    // Act
    const response = await request(app.getApp())
      .delete('/queues/q1')
      .expect(500);
    
    // Assert
    expect(response.body).toHaveProperty('error');
    expect(response.body.error).toContain('jobs');
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify successful deletion
- [ ] Tests verify error handling
- [ ] Tests verify error message propagation

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add DELETE /queues/:queueName endpoint tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify queue deletion
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
