# TASK-023: Test handleCallback for unknown requestId with foreign lock

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.8
**Task ID**: TASK-023

## Description

Add a test case for the `handleCallback` method to verify it correctly handles the case where an unknown `requestId` is received and the lock is held by a different process (foreign lock). The test should verify that `clearLock()` is called and no database status changes occur.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `handleCallback()` method with unknown requestId and foreign lock handling

## Current State

The `handleCallback` method:
- Receives callback with `requestId` and result data
- Checks if `requestId` exists in `pendingTasks` map
- If `requestId` is unknown, checks if lock is held by foreign process
- If lock is foreign (different PID), calls `clearLock()` to release it
- Does not perform any database status changes for unknown requestIds

The test file `tests/services/task-operator-service.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-022.

## Checklist

### Preparation and Setup

- [ ] Review `handleCallback` unknown requestId handling
- [ ] Understand how foreign lock detection works (PID comparison)
- [ ] Review `clearLock()` implementation
- [ ] Understand pendingTasks map structure

### Implementation Steps

- [ ] Step 1: Set up test for unknown requestId with foreign lock
  - [ ] Create test: `it('should clear foreign lock for unknown requestId', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Leave `pendingTasks` map empty (no matching requestId)
    - [ ] Mock Redis `get` to return lock value with different PID (e.g., `'other-pid-12345-timestamp-random'`)
    - [ ] Mock Redis `del` for `clearLock()` call
    - [ ] Mock `DatabaseService` methods (should not be called)
  - [ ] Act: Call `handleCallback('unknown-request-id', { success: true })`
  - [ ] Assert: 
    - [ ] `clearLock()` was called
    - [ ] No database status changes occurred
    - [ ] `markTaskComplete` or `updateTaskStatus` were not called
- [ ] Step 2: Verify foreign lock detection
  - [ ] Assert: Lock value contains different PID than current process
  - [ ] Assert: Method correctly identifies foreign lock
  - [ ] Assert: `clearLock()` is invoked

### Specific Requirements

- [ ] Requirement 1: Test must verify foreign lock detection
  - Acceptance: Method correctly identifies lock held by different process
- [ ] Requirement 2: Test must verify lock cleanup
  - Acceptance: `clearLock()` is called for foreign lock
- [ ] Requirement 3: Test must verify no database changes
  - Acceptance: No database status updates occur for unknown requestId
- [ ] Requirement 4: Test must verify pendingTasks check
  - Acceptance: Method checks pendingTasks before processing

### Error Handling and Edge Cases

- [ ] Handle case where lock value format is invalid
- [ ] Handle case where Redis `get` fails
- [ ] Verify method doesn't crash on unknown requestId
- [ ] Test with various lock value formats

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining foreign lock scenario
- [ ] Document why lock is cleared for unknown requestIds
- [ ] Note PID comparison logic

### Verification

- [ ] Verify test passes consistently
- [ ] Verify foreign lock detection works
- [ ] Verify lock cleanup works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-022
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-022: Test cursor-runner HTTP failure
- **Important Considerations**: 
  - Foreign lock detection uses PID comparison from lock value
  - Lock value format: `{pid}-{timestamp}-{random}`
  - Clearing foreign locks prevents deadlocks from crashed processes
  - Unknown requestIds may come from old/crashed instances
- **Task Independence**: Can be completed independently after TASK-022
- **Current State**: Test file exists with previous tests

## Related Tasks

- Previous: TASK-022 (Test cursor-runner HTTP failure)
- Next: TASK-024 (Test handleCallback success path)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-022: Test cursor-runner HTTP failure
- Related:
  - TASK-024: Will test callback success
  - TASK-025: Will test callback failure

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `handleCallback` with unknown requestId and foreign lock.

**Definition of Done**: "A test case is written that verifies `handleCallback` correctly handles unknown requestId with foreign lock by calling `clearLock()` and not performing database status changes. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify foreign lock handling works so that deadlocks from crashed processes are prevented.
   - **Acceptance Criteria**: 
     - Test verifies foreign lock is detected correctly
     - Test verifies `clearLock()` is called
     - Test passes consistently

2. **As a developer**, I want to verify unknown requestIds are handled safely so that orphaned callbacks don't cause errors.
   - **Acceptance Criteria**:
     - Test verifies no database changes occur
     - Test verifies method doesn't crash

### Automated Tests

The test case should be:

```typescript
it('should clear foreign lock for unknown requestId', async () => {
  // Arrange: Unknown requestId, foreign lock
  const unknownRequestId = 'unknown-request-id';
  const foreignLockValue = `other-pid-${Date.now()}-random`; // Different PID
  const mockRedis = {
    get: jest.fn().mockResolvedValue(foreignLockValue), // Foreign lock
    del: jest.fn().mockResolvedValue(1), // clearLock
  };
  const mockDbService = {
    markTaskComplete: jest.fn(),
    updateTaskStatus: jest.fn(),
  };
  
  const service = TaskOperatorService.getInstance(mockRedis);
  // Ensure pendingTasks is empty
  // Inject mocks
  
  // Act
  await service.handleCallback(unknownRequestId, { success: true });
  
  // Assert
  expect(mockRedis.del).toHaveBeenCalled(); // clearLock called
  expect(mockDbService.markTaskComplete).not.toHaveBeenCalled();
  expect(mockDbService.updateTaskStatus).not.toHaveBeenCalled();
});
```

- [ ] Test case written and passes
- [ ] Test verifies foreign lock detection
- [ ] Test verifies lock cleanup
- [ ] Test verifies no database changes

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add handleCallback unknown requestId with foreign lock test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies foreign lock handling
- [ ] Test verifies lock cleanup
- [ ] Test verifies no database changes
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
