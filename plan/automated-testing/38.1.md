# TASK-038.1: Test Bull Board base path - configuration

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.1.1
**Task ID**: TASK-038.1

## Description

Add a test case to verify that Bull Board base path is configured correctly from the `BULL_BOARD_BASE_PATH` environment variable. The test should verify that `ExpressAdapter.setBasePath()` is called with the correct value.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - Bull Board setup with base path
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `CursorAgentsApp` class:
- Configures Bull Board with optional base path from `process.env.BULL_BOARD_BASE_PATH`
- Calls `ExpressAdapter.setBasePath()` if base path is provided

The test file `tests/app.test.ts` already exists with some tests but may not cover base path configuration.

**Important**: This task should be executed after Phase 4 (TASK-035 through TASK-037). This is the first subtask of TASK-038.

## Checklist

### Preparation and Setup

- [ ] Review `CursorAgentsApp` Bull Board setup implementation
- [ ] Understand `ExpressAdapter.setBasePath()` usage
- [ ] Review existing `app.test.ts` structure
- [ ] Understand environment variable handling in tests

### Implementation Steps

- [ ] Step 1: Set up test for base path configuration
  - [ ] Create test: `it('should configure Bull Board base path from environment variable', () => { ... })`
  - [ ] Arrange: 
    - [ ] Set `process.env.BULL_BOARD_BASE_PATH = '/agents/admin/queues'`
    - [ ] Mock `ExpressAdapter.setBasePath`
    - [ ] Create app instance
  - [ ] Act: Initialize app (may happen in constructor or separate method)
  - [ ] Assert: 
    - [ ] `ExpressAdapter.setBasePath` was called with `/agents/admin/queues`

### Specific Requirements

- [ ] Requirement 1: Test must verify base path configuration
  - Acceptance: `setBasePath` is called with correct value
- [ ] Requirement 2: Test must verify environment variable usage
  - Acceptance: Base path comes from environment variable
- [ ] Requirement 3: Test must clean up environment
  - Acceptance: Environment variable is restored after test

### Error Handling and Edge Cases

- [ ] Handle case where base path is not set (default behavior)
- [ ] Handle case where base path has trailing slash
- [ ] Test with various base path values

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining base path configuration
- [ ] Document environment variable usage

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify base path configuration works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after Phase 4 (TASK-035 through TASK-037)
- **Dependencies**: 
  - TASK-035 through TASK-037: Phase 4 PromptProcessor tests
- **Important Considerations**: 
  - Base path allows Bull Board to work behind reverse proxies
  - Environment variable should be set in test, then cleaned up
  - Mocking `ExpressAdapter.setBasePath` may require careful setup
  - This is the first of 2 subtasks for TASK-038
- **Task Independence**: Can be completed independently after Phase 4
- **Current State**: Test file exists but may not cover base path configuration

## Related Tasks

- Parent: TASK-038 (Extend app.test.ts for Bull Board base path)
- Next: TASK-038.2 (Test Bull Board base path - dashboard accessibility)
- Dependencies:
  - TASK-035 through TASK-037: Phase 4 tests
- Related:
  - TASK-038.2: Will test dashboard accessibility

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for Bull Board base path configuration.

**Definition of Done**: "A test case is written that verifies Bull Board base path is configured from environment variable and `ExpressAdapter.setBasePath` is called correctly. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify base path configuration works so that Bull Board works behind reverse proxies.
   - **Acceptance Criteria**: 
     - Test verifies `setBasePath` is called with correct value
     - Test passes consistently

2. **As a developer**, I want to verify environment variable handling works so that configuration is flexible.
   - **Acceptance Criteria**:
     - Test verifies base path comes from environment variable
     - Test verifies environment is cleaned up after test

### Automated Tests

The test case should be:

```typescript
describe('Bull Board base path', () => {
  beforeEach(() => {
    // Save original env
    originalBasePath = process.env.BULL_BOARD_BASE_PATH;
  });
  
  afterEach(() => {
    // Restore original env
    if (originalBasePath) {
      process.env.BULL_BOARD_BASE_PATH = originalBasePath;
    } else {
      delete process.env.BULL_BOARD_BASE_PATH;
    }
  });
  
  it('should configure Bull Board base path from environment variable', () => {
    // Arrange
    process.env.BULL_BOARD_BASE_PATH = '/agents/admin/queues';
    const setBasePathSpy = jest.spyOn(ExpressAdapter.prototype, 'setBasePath');
    
    // Act: Create app instance
    const app = new CursorAgentsApp();
    
    // Assert
    expect(setBasePathSpy).toHaveBeenCalledWith('/agents/admin/queues');
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify base path configuration
- [ ] Tests clean up environment

### Git Commit and Push Requirements

- [ ] Test case added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add Bull Board base path configuration test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify base path configuration
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

