# TASK-056: Raise Jest coverage thresholds

**Section**: 8. Coverage & CI Tightening
**Subsection**: 8.3
**Task ID**: TASK-056

## Description

Configure Jest coverage thresholds in `jest.config.js` for `src/**` files (excluding entrypoints) based on current stable coverage levels. Set thresholds for lines, branches, functions, and statements (e.g., 80-85%) and ensure CI passes with the new thresholds.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/jest.config.js` - Jest configuration
- Coverage results from TASK-054 and TASK-055

## Current State

The `jest.config.js` file exists but may not have `coverageThreshold` configuration. Coverage analysis from TASK-054 and improvements from TASK-055 provide baseline for setting thresholds.

Coverage thresholds enforce minimum coverage levels and fail tests if thresholds aren't met.

**Important**: This task should be executed after TASK-055.

## Checklist

### Preparation and Setup

- [ ] Review current coverage levels from TASK-054/TASK-055
- [ ] Understand Jest `coverageThreshold` configuration
- [ ] Review `jest.config.js` structure
- [ ] Understand entrypoint exclusion patterns

### Implementation Steps

- [ ] Step 1: Determine appropriate thresholds
  - [ ] Review current coverage metrics (lines, branches, functions, statements)
  - [ ] Set thresholds based on stable coverage (e.g., 80-85%)
  - [ ] Consider: lines 80%, branches 75%, functions 80%, statements 80%
  - [ ] Ensure thresholds are achievable but meaningful
- [ ] Step 2: Configure coverageThreshold in jest.config.js
  - [ ] Add `coverageThreshold` configuration
  - [ ] Set thresholds for `src/**` pattern
  - [ ] Exclude entrypoints (index.ts, mcp/index.ts)
  - [ ] Configure: `global`, `src/**/*.{js,ts}` patterns
- [ ] Step 3: Verify thresholds work
  - [ ] Run `npm run test:coverage`
  - [ ] Verify coverage meets thresholds
  - [ ] If not, adjust thresholds or add more tests
  - [ ] Ensure CI will pass with thresholds

### Specific Requirements

- [ ] Requirement 1: Test must configure thresholds
  - Acceptance: `coverageThreshold` is added to jest.config.js
- [ ] Requirement 2: Test must set appropriate levels
  - Acceptance: Thresholds are based on current stable coverage
- [ ] Requirement 3: Test must exclude entrypoints
  - Acceptance: Entrypoints are not included in thresholds
- [ ] Requirement 4: Test must verify CI compatibility
  - Acceptance: Coverage meets thresholds, CI will pass

### Error Handling and Edge Cases

- [ ] Handle case where current coverage is below desired threshold
- [ ] Verify threshold configuration syntax is correct
- [ ] Test that thresholds fail appropriately when not met
- [ ] Ensure entrypoint exclusion works

### Testing

- [ ] Run `npm run test:coverage` to verify thresholds work
- [ ] Verify coverage meets configured thresholds
- [ ] Verify thresholds fail when coverage drops (test by temporarily lowering)
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated coverage verification only

### Documentation

- [ ] Add comments explaining coverage thresholds
- [ ] Document why thresholds are set at specific levels
- [ ] Note entrypoint exclusion rationale

### Verification

- [ ] Verify coverage thresholds are configured correctly
- [ ] Verify coverage meets thresholds
- [ ] Verify CI compatibility
- [ ] Confirm configuration follows project conventions

## Notes

- This task is part of **Phase 8 â€“ Coverage & CI Tightening**
- **Execution Timing**: Should be executed after TASK-055
- **Dependencies**: 
  - TASK-054: Measure coverage and identify remaining gaps
  - TASK-055: Add targeted tests for uncovered branches
- **Important Considerations**: 
  - Coverage thresholds enforce quality standards
  - Thresholds should be based on achievable, stable coverage
  - Entrypoints are excluded (not typically unit tested)
  - Thresholds prevent coverage regression
  - CI will fail if thresholds aren't met
  - Typical thresholds: 80% lines, 75% branches, 80% functions, 80% statements
- **Task Independence**: Can be completed independently after TASK-055
- **Current State**: Coverage thresholds may not be configured

## Related Tasks

- Previous: TASK-055 (Add targeted tests for uncovered branches)
- Next: TASK-057 (Finalize CI test matrix)
- Dependencies:
  - TASK-054: Measure coverage and identify remaining gaps
  - TASK-055: Add targeted tests for uncovered branches
- Related:
  - TASK-057: Will configure CI to use coverage thresholds

## Definition of Done

### Task Type: CONFIGURATION TASK

**Description**: This task involves configuring Jest coverage thresholds.

**Definition of Done**: "Coverage thresholds are configured in `jest.config.js` for `src/**` files (excluding entrypoints) based on current stable coverage. Thresholds are set for lines, branches, functions, and statements. Coverage meets thresholds and CI will pass. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want coverage thresholds enforced so that test coverage doesn't regress.
   - **Acceptance Criteria**: 
     - Coverage thresholds are configured
     - Thresholds are based on stable coverage
     - CI will enforce thresholds

2. **As a developer**, I want meaningful thresholds so that code quality is maintained.
   - **Acceptance Criteria**:
     - Thresholds are set at appropriate levels (80-85%)
     - Entrypoints are excluded
     - Thresholds cover all metrics (lines, branches, functions, statements)

### Automated Tests

**Note**: This is a configuration task. Coverage should be verified:

```javascript
// jest.config.js
export default {
  // ... existing config
  coverageThreshold: {
    global: {
      branches: 75,
      functions: 80,
      lines: 80,
      statements: 80,
    },
    // Or more specific:
    'src/**/*.{js,ts}': {
      branches: 75,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
  collectCoverageFrom: [
    'src/**/*.{js,ts}',
    '!src/index.{js,ts}',
    '!src/mcp/index.{js,ts}',
  ],
};
```

- [ ] Coverage thresholds configured
- [ ] Thresholds are appropriate
- [ ] Coverage meets thresholds
- [ ] Entrypoints excluded

### Git Commit and Push Requirements

- [ ] `jest.config.js` updated with coverageThreshold
- [ ] Commit message follows project conventions (e.g., "test: configure Jest coverage thresholds")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the configuration changes

### Final Checklist

- [ ] Coverage thresholds configured
- [ ] Thresholds are appropriate
- [ ] Coverage meets thresholds
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
