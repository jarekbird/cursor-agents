# TASK-046.5: Enhance MCP tests - list_queues JSON structure assertions

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.1.5
**Task ID**: TASK-046.5

## Description

Enhance the existing test for the `list_queues` MCP tool to add comprehensive JSON payload assertions. The test should verify that `content[0].text` is valid JSON and assert the exact structure (keys, types) for the list_queues tool.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - `list_queues` tool handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The `list_queues` MCP tool:
- Lists all queues
- Returns MCP response with `content[0].text` containing JSON
- JSON should contain: `queues` array

The test file `tests/mcp/server.test.ts` exists with previous tests including TASK-046.1 through TASK-046.4.

**Important**: This task should be executed after TASK-046.4.

## Checklist

### Preparation and Setup

- [ ] Review `list_queues` tool handler implementation
- [ ] Understand MCP response format (`content[0].text` as JSON)
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Enhance existing list_queues test with JSON assertions
  - [ ] Find existing test for list_queues
  - [ ] Add JSON parsing: `const content = JSON.parse(response.content[0].text)`
  - [ ] Assert JSON contains: `queues` array
  - [ ] Assert queue objects have required fields
  - [ ] Assert array structure is correct

### Specific Requirements

- [ ] Requirement 1: Test must verify JSON is valid
  - Acceptance: `content[0].text` parses as valid JSON
- [ ] Requirement 2: Test must verify structure
  - Acceptance: All required keys are present with correct types
- [ ] Requirement 3: Test must verify array structure
  - Acceptance: Queues array has correct structure

### Error Handling and Edge Cases

- [ ] Handle case where no queues exist (empty array)
- [ ] Verify queue object structure
- [ ] Test with various queue configurations

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining JSON structure assertions
- [ ] Document expected JSON schema for list_queues

### Verification

- [ ] Verify test passes consistently
- [ ] Verify JSON parsing works
- [ ] Verify structure assertions work
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-046.4
- **Dependencies**: 
  - TASK-046.4: Enhance MCP tests - delete_agent JSON structure assertions
- **Important Considerations**: 
  - This is the fifth of 7 subtasks for TASK-046
- **Task Independence**: Can be completed independently after TASK-046.4
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions)
- Previous: TASK-046.4 (Enhance MCP tests - delete_agent JSON structure assertions)
- Next: TASK-046.6 (Enhance MCP tests - get_queue_info JSON structure assertions)
- Dependencies:
  - TASK-046.4: Enhance MCP tests - delete_agent JSON structure assertions
- Related:
  - TASK-046.1 through TASK-046.4, TASK-046.6, TASK-046.7: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves enhancing the list_queues MCP tool test with JSON structure assertions.

**Definition of Done**: "The list_queues MCP tool test is enhanced with JSON parsing and structure assertions. Test verifies exact JSON structure (queues array, queue object fields). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify JSON structure is correct so that MCP clients receive expected data.
   - **Acceptance Criteria**: 
     - Test verifies JSON is valid
     - Test verifies queues array structure is correct
     - Test verifies queue objects have required fields

### Automated Tests

Test enhancements should include:

```typescript
describe('list_queues MCP tool', () => {
  it('should return valid JSON with queues array', async () => {
    // Arrange & Act
    // Assert
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('queues', expect.any(Array));
    content.queues.forEach(queue => {
      // Assert queue object structure
    });
  });
});
```

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure

### Git Commit and Push Requirements

- [ ] Test enhancements added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance list_queues MCP tool with JSON structure assertions")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test enhancements

### Final Checklist

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

