# TASK-008: Test setSystemSetting happy path

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.5
**Task ID**: TASK-008

**NOTE**: This task has been split into granular subtasks:
- **TASK-008.1**: Test setSystemSetting - setting to true
- **TASK-008.2**: Test setSystemSetting - setting to false
- **TASK-008.3**: Test setSystemSetting - updating existing setting

Please execute the subtasks (8.1, 8.2, 8.3) instead of this parent task.

## Description

Add test cases for the `setSystemSetting` method to verify it correctly inserts and updates system settings in the database. The tests should verify that settings can be set to both `true` and `false`, and that subsequent reads return the correct values. This tests the write path for system settings.

**This task has been split into subtasks - see TASK-008.1 through TASK-008.3**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 68-91) - `setSystemSetting()` method

## Current State

The `setSystemSetting` method:
- Uses `INSERT ... ON CONFLICT` to handle both insert and update
- Stores booleans as integers (1 for true, 0 for false)
- Updates `updated_at` timestamp
- Returns `true` on success, `false` on error
- Logs success and errors

The test file `tests/services/database-service.test.ts` exists with connection and read tests from previous tasks.

**Important**: This task should be executed after TASK-007 (test isSystemSettingEnabled).

## Checklist

### Preparation and Setup

- [ ] Review `setSystemSetting` implementation
- [ ] Understand `INSERT ... ON CONFLICT` SQL syntax
- [ ] Review how to verify database writes in tests
- [ ] Understand timestamp handling in SQLite

### Implementation Steps

- [ ] Step 1: Set up test database with schema
  - [ ] Ensure `system_settings` table exists with: `name`, `value`, `created_at`, `updated_at`
  - [ ] Use same setup as TASK-007
- [ ] Step 2: Write test for setting to true
  - [ ] Create test: `it('should set system setting to true', () => { ... })`
  - [ ] Arrange: Empty or clean `system_settings` table
  - [ ] Act: Call `setSystemSetting('test_setting', true)`
  - [ ] Assert: Returns `true`
  - [ ] Assert: `isSystemSettingEnabled('test_setting')` returns `true`
  - [ ] Assert: Database row has `value = 1`
- [ ] Step 3: Write test for setting to false
  - [ ] Create test: `it('should set system setting to false', () => { ... })`
  - [ ] Arrange: Setting already exists with value 1
  - [ ] Act: Call `setSystemSetting('test_setting', false)`
  - [ ] Assert: Returns `true`
  - [ ] Assert: `isSystemSettingEnabled('test_setting')` returns `false`
  - [ ] Assert: Database row has `value = 0`
- [ ] Step 4: Write test for updating existing setting
  - [ ] Create test: `it('should update existing system setting', () => { ... })`
  - [ ] Arrange: Insert setting with value 0
  - [ ] Act: Call `setSystemSetting('test_setting', true)`
  - [ ] Assert: Returns `true`
  - [ ] Assert: Setting now has value 1
  - [ ] Assert: `updated_at` timestamp changed (if verifiable)

### Specific Requirements

- [ ] Requirement 1: Test must verify setting to true works
  - Acceptance: Setting to `true` stores value 1 and can be read back as `true`
- [ ] Requirement 2: Test must verify setting to false works
  - Acceptance: Setting to `false` stores value 0 and can be read back as `false`
- [ ] Requirement 3: Test must verify updates work
  - Acceptance: Updating existing setting changes value correctly
- [ ] Requirement 4: Test must verify return value
  - Acceptance: Method returns `true` on success

### Error Handling and Edge Cases

- [ ] Handle case where setting is updated multiple times
- [ ] Verify `created_at` is preserved on updates (if applicable)
- [ ] Test with various setting names
- [ ] Verify concurrent updates (if testable)

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify tests are isolated
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining test scenarios
- [ ] Document why `ON CONFLICT` is used
- [ ] Note any timestamp verification limitations

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify database writes are correct
- [ ] Verify reads after writes work
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-007
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-007: Test isSystemSettingEnabled behavior
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Verify both insert (new) and update (existing) paths
  - Test round-trip: write then read
  - Timestamp verification may be limited by test timing
- **Task Independence**: Can be completed independently after TASK-007
- **Current State**: Test file exists with read tests

## Related Tasks

- Previous: TASK-007 (Test isSystemSettingEnabled behavior)
- Next: TASK-009 (Test setSystemSetting error path)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-007: Test isSystemSettingEnabled behavior
- Related:
  - TASK-009: Will test error handling for setSystemSetting

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing test cases for the `setSystemSetting` method happy path.

**Definition of Done**: "Test cases are written that verify `setSystemSetting` correctly inserts and updates system settings. Tests verify setting to true, setting to false, and updating existing settings. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify system settings can be set so that feature flags can be toggled.
   - **Acceptance Criteria**: 
     - Test verifies setting to `true` works
     - Test verifies setting to `false` works
     - Test verifies values are stored correctly in database

2. **As a developer**, I want to verify settings can be updated so that values can be changed.
   - **Acceptance Criteria**:
     - Test verifies updating existing setting works
     - Test verifies updated value is correct
     - Test verifies round-trip (write then read) works

### Automated Tests

Test cases should include:

```typescript
describe('setSystemSetting', () => {
  it('should set system setting to true', () => {
    // Arrange: Clean table
    // Act: setSystemSetting('test', true)
    // Assert: Returns true, isSystemSettingEnabled returns true, DB has value 1
  });
  
  it('should set system setting to false', () => {
    // Arrange: Setting exists with value 1
    // Act: setSystemSetting('test', false)
    // Assert: Returns true, isSystemSettingEnabled returns false, DB has value 0
  });
  
  it('should update existing system setting', () => {
    // Arrange: Setting exists with value 0
    // Act: setSystemSetting('test', true)
    // Assert: Returns true, setting now has value 1
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify database writes
- [ ] Tests verify round-trip (write then read)
- [ ] Tests are properly isolated

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add setSystemSetting happy path tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover setting to true, false, and updates
- [ ] Tests verify database writes
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
