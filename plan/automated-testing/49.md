# TASK-049: Add logging expectation tests

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.4
**Task ID**: TASK-049

## Description

Add test cases to verify that MCP tool handlers log appropriately. The tests should verify that "MCP tool called" and "MCP tool completed" log entries occur with correct tool names and success flags for representative tools.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - MCP tool handlers with logging
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The MCP tool handlers:
- Log "MCP tool called" with tool name when tool is invoked
- Log "MCP tool completed" with tool name and success flag when tool completes
- Use logger.info for these log entries

The test file `tests/mcp/server.test.ts` exists but may not verify logging behavior.

**Important**: This task should be executed after TASK-048, completing Phase 6.

## Checklist

### Preparation and Setup

- [ ] Review MCP tool handler logging implementation
- [ ] Understand logger mocking patterns
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand log message formats

### Implementation Steps

- [ ] Step 1: Set up logger mock
  - [ ] Mock logger module or spy on logger methods
  - [ ] Set up spy on `logger.info` to capture log calls
- [ ] Step 2: Write test for create_agent logging
  - [ ] Create test: `it('should log MCP tool called and completed for create_agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock logger.info
      - [ ] Set up successful agent creation
    - [ ] Act: Call `create_agent` tool
    - [ ] Assert: 
      - [ ] "MCP tool called" log with tool name "create_agent"
      - [ ] "MCP tool completed" log with success: true
- [ ] Step 3: Write test for list_agents logging
  - [ ] Create test: `it('should log MCP tool called and completed for list_agents', async () => { ... })`
    - [ ] Arrange: Mock logger, set up successful listing
    - [ ] Act: Call `list_agents` tool
    - [ ] Assert: 
      - [ ] "MCP tool called" log with tool name "list_agents"
      - [ ] "MCP tool completed" log with success: true
- [ ] Step 4: Write test for error logging
  - [ ] Create test: `it('should log MCP tool completed with success: false on error', async () => { ... })`
    - [ ] Arrange: Tool handler throws error
    - [ ] Act: Call tool (e.g., `get_agent_status` for non-existent agent)
    - [ ] Assert: 
      - [ ] "MCP tool called" log occurs
      - [ ] "MCP tool completed" log with success: false

### Specific Requirements

- [ ] Requirement 1: Test must verify tool called logging
  - Acceptance: "MCP tool called" log occurs with correct tool name
- [ ] Requirement 2: Test must verify tool completed logging
  - Acceptance: "MCP tool completed" log occurs with success flag
- [ ] Requirement 3: Test must verify success flag
  - Acceptance: Success flag reflects tool outcome (true/false)
- [ ] Requirement 4: Test must cover representative tools
  - Acceptance: At least 2-3 tools tested for logging

### Error Handling and Edge Cases

- [ ] Handle case where logging fails (shouldn't affect tool execution)
- [ ] Verify log messages are formatted correctly
- [ ] Test with various tool outcomes
- [ ] Verify tool names are correct

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining logging verification
- [ ] Document log message formats
- [ ] Note why logging is important

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify logging occurs correctly
- [ ] Verify success flags are correct
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-048 (completes Phase 6)
- **Dependencies**: 
  - TASK-048: Add tests for MCP resources (agents)
- **Important Considerations**: 
  - Logging provides observability for MCP tool usage
  - Log verification ensures debugging information is available
  - Success flags help identify tool failures
  - Representative tools (create_agent, list_agents) are sufficient
  - Logger mocking may require module mocking
- **Task Independence**: Can be completed independently after TASK-048
- **Current State**: Test file exists but may not verify logging

## Related Tasks

- Previous: TASK-048 (Add tests for MCP resources (agents))
- Next: TASK-050 (Enhance integration.test.ts for richer agent lifecycle) - Starts Phase 7
- Dependencies:
  - TASK-048: Add tests for MCP resources (agents)
- Related:
  - TASK-050: Will start integration tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases to verify MCP tool logging behavior.

**Definition of Done**: "Test cases are added that verify MCP tool handlers log 'MCP tool called' and 'MCP tool completed' with correct tool names and success flags for representative tools. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify logging works so that MCP tool usage can be monitored.
   - **Acceptance Criteria**: 
     - Test verifies "MCP tool called" log occurs
     - Test verifies "MCP tool completed" log occurs
     - Test passes consistently

2. **As a developer**, I want to verify success flags are correct so that tool failures can be identified.
   - **Acceptance Criteria**:
     - Test verifies success: true for successful tools
     - Test verifies success: false for failed tools

### Automated Tests

Test cases should include:

```typescript
describe('MCP tool logging', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    logger.info = jest.fn();
  });
  
  it('should log MCP tool called and completed for create_agent', async () => {
    // Arrange: Mock successful creation
    // Act: Call create_agent tool
    // Assert
    expect(logger.info).toHaveBeenCalledWith(
      expect.stringContaining('MCP tool called'),
      expect.objectContaining({ tool: 'create_agent' })
    );
    expect(logger.info).toHaveBeenCalledWith(
      expect.stringContaining('MCP tool completed'),
      expect.objectContaining({ tool: 'create_agent', success: true })
    );
  });
  
  it('should log MCP tool completed with success: false on error', async () => {
    // Arrange: Tool throws error
    // Act: Call tool
    // Assert: success: false in completed log
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify tool called logging
- [ ] Tests verify tool completed logging
- [ ] Tests verify success flags

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add MCP tool logging expectation tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify logging behavior
- [ ] Tests verify success flags
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 6 (MCP Server Black-box Tests) is complete**
