# TASK-030.1: Test hasExistingJobs - matching jobs with excludeActive=false

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.3.1
**Task ID**: TASK-030.1

## Description

Add a test case for the `hasExistingJobs` method to verify it correctly detects matching jobs when `excludeActive` is false. The test should verify that waiting, active, and delayed jobs are all checked and matching jobs are detected.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `hasExistingJobs()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `hasExistingJobs` method:
- Checks for jobs in a queue with matching names
- Checks waiting, active, and delayed jobs
- Returns `true` if matching jobs exist, `false` otherwise

The test file `tests/queue/queue-manager.test.ts` exists but may not have `hasExistingJobs` tests.

**Important**: This task should be executed after TASK-029. This is the first subtask of TASK-030.

## Checklist

### Preparation and Setup

- [ ] Review `hasExistingJobs` implementation
- [ ] Understand BullMQ job querying methods (`getWaiting`, `getActive`, `getDelayed`)
- [ ] Review job name matching logic

### Implementation Steps

- [ ] Step 1: Write test for matching jobs with excludeActive=false
  - [ ] Create test: `it('should return true when matching jobs exist and excludeActive is false', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock queue with `getWaiting`, `getActive`, `getDelayed` methods
    - [ ] Return jobs with matching names (e.g., `job.name === 'agent:test'`)
    - [ ] Set `excludeActive=false`
  - [ ] Act: Call `hasExistingJobs(queue, 'agent:test', false)`
  - [ ] Assert: Returns `true`

### Specific Requirements

- [ ] Requirement 1: Test must verify job detection
  - Acceptance: Method correctly identifies matching jobs
- [ ] Requirement 2: Test must verify all job types
  - Acceptance: Waiting, active, and delayed jobs are checked

### Error Handling and Edge Cases

- [ ] Handle case where no jobs exist
- [ ] Handle case where job names don't match
- [ ] Test with various job name patterns

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining job detection logic

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify job detection works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-029
- **Dependencies**: 
  - TASK-029: Add tests for getOrCreateQueue
- **Important Considerations**: 
  - Job name matching is critical for agent detection
  - This is the first of 3 subtasks for TASK-030
- **Task Independence**: Can be completed independently after TASK-029
- **Current State**: Test file exists but may not have hasExistingJobs tests

## Related Tasks

- Parent: TASK-030 (Add tests for hasExistingJobs)
- Next: TASK-030.2 (Test hasExistingJobs - excludeActive=true with only active jobs)
- Dependencies:
  - TASK-029: Add tests for getOrCreateQueue
- Related:
  - TASK-030.2, TASK-030.3: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `hasExistingJobs` when excludeActive is false.

**Definition of Done**: "A test case is written that verifies `hasExistingJobs` correctly detects matching jobs when excludeActive is false, checking waiting, active, and delayed jobs. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify job detection works so that duplicate jobs can be prevented.
   - **Acceptance Criteria**: 
     - Test verifies matching jobs are detected
     - Test verifies all job types are checked
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('hasExistingJobs', () => {
  it('should return true when matching jobs exist and excludeActive is false', async () => {
    // Arrange: Mock queue with matching jobs
    const mockQueue = {
      getWaiting: jest.fn().mockResolvedValue([
        { id: '1', name: 'agent:test', data: {} },
      ]),
      getActive: jest.fn().mockResolvedValue([]),
      getDelayed: jest.fn().mockResolvedValue([]),
    };
    const queueManager = new QueueManager(mockRedis);
    
    // Act
    const result = await queueManager.hasExistingJobs(mockQueue, 'agent:test', false);
    
    // Assert
    expect(result).toBe(true);
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify job detection

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add hasExistingJobs excludeActive=false test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify job detection
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

