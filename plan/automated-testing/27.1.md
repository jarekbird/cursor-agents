# TASK-027.1: Test cleanupStaleTasks - reset stale IN_PROGRESS tasks

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.12.1
**Task ID**: TASK-027.1

## Description

Add a test case for the `cleanupStaleTasks` method to verify it correctly identifies stale tasks that have exceeded the timeout and resets IN_PROGRESS tasks to ready while removing COMPLETE tasks without resetting. This verifies the core cleanup logic.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `cleanupStaleTasks()` method

## Current State

The `cleanupStaleTasks` method:
- Iterates through `pendingTasks` map
- Checks if task timestamp exceeds `TASK_TIMEOUT_MS` (1 hour)
- For stale tasks still IN_PROGRESS, resets status to ready and removes from map
- For stale tasks that are COMPLETE, removes from map without resetting status

The test file `tests/services/task-operator-service.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-026. This is the first subtask of TASK-027.

## Checklist

### Preparation and Setup

- [ ] Review `cleanupStaleTasks` implementation
- [ ] Understand `TASK_TIMEOUT_MS` constant (1 hour)
- [ ] Review how stale tasks are identified (timestamp comparison)
- [ ] Understand status checking logic

### Implementation Steps

- [ ] Step 1: Set up test for stale task cleanup
  - [ ] Create test: `it('should reset stale IN_PROGRESS tasks to ready and remove from map', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Insert entries into `pendingTasks` with old timestamps (exceeding `TASK_TIMEOUT_MS`)
    - [ ] Task 1: `{ taskId: 1, requestId: 'req-1', timestamp: Date.now() - 2 * 60 * 60 * 1000 }` (2 hours ago, stale)
    - [ ] Task 2: `{ taskId: 2, requestId: 'req-2', timestamp: Date.now() - 2 * 60 * 60 * 1000 }` (2 hours ago, stale)
    - [ ] Mock `DatabaseService.getTaskStatus`:
      - [ ] Return `STATUS_IN_PROGRESS` (4) for task 1
      - [ ] Return `STATUS_COMPLETE` (1) for task 2
    - [ ] Mock `DatabaseService.updateTaskStatus` for reset to ready
  - [ ] Act: Call `cleanupStaleTasks()` (may need test-only access or trigger via `processNextTask`)
  - [ ] Assert: 
    - [ ] Task 1 (IN_PROGRESS) was reset to ready and removed from map
    - [ ] Task 2 (COMPLETE) was removed from map but NOT reset
    - [ ] `updateTaskStatus` was called only for task 1

### Specific Requirements

- [ ] Requirement 1: Test must verify stale task identification
  - Acceptance: Tasks exceeding timeout are identified correctly
- [ ] Requirement 2: Test must verify IN_PROGRESS task reset
  - Acceptance: Stale IN_PROGRESS tasks are reset to ready
- [ ] Requirement 3: Test must verify COMPLETE task handling
  - Acceptance: Stale COMPLETE tasks are removed but not reset

### Error Handling and Edge Cases

- [ ] Handle case where `getTaskStatus` fails
- [ ] Handle case where `updateTaskStatus` fails
- [ ] Verify tasks within timeout are not cleaned up
- [ ] Test with empty pendingTasks map

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining stale task cleanup logic
- [ ] Document why COMPLETE tasks are not reset
- [ ] Note timeout value and rationale

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify stale task identification works
- [ ] Verify status-based cleanup works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-026
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-026: Test isProcessing and clearLock
- **Important Considerations**: 
  - Stale task cleanup prevents orphaned tasks from blocking processing
  - Timeout is 1 hour (`TASK_TIMEOUT_MS = 60 * 60 * 1000`)
  - Only IN_PROGRESS tasks are reset (COMPLETE tasks are just removed)
  - This is the first of 2 subtasks for TASK-027
  - May need test-only access to `cleanupStaleTasks` or trigger via `processNextTask`
- **Task Independence**: Can be completed independently after TASK-026
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-027 (Test stale task cleanup)
- Next: TASK-027.2 (Test cleanupStaleTasks - lock release)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-026: Test isProcessing and clearLock
- Related:
  - TASK-027.2: Will test lock release after cleanup

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `cleanupStaleTasks` to verify stale task reset logic.

**Definition of Done**: "A test case is written that verifies `cleanupStaleTasks` correctly identifies stale tasks, resets IN_PROGRESS tasks to ready, and removes COMPLETE tasks without reset. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify stale task cleanup works so that orphaned tasks don't block processing.
   - **Acceptance Criteria**: 
     - Test verifies stale tasks are identified correctly
     - Test verifies IN_PROGRESS tasks are reset to ready
     - Test verifies COMPLETE tasks are removed without reset

### Automated Tests

The test case should be:

```typescript
it('should reset stale IN_PROGRESS tasks to ready and remove from map', async () => {
  // Arrange: Stale tasks with old timestamps
  const staleTimestamp = Date.now() - 2 * 60 * 60 * 1000; // 2 hours ago
  const service = TaskOperatorService.getInstance(mockRedis);
  // Seed pendingTasks with stale entries
  service.pendingTasks.set('req-1', { taskId: 1, requestId: 'req-1', timestamp: staleTimestamp });
  service.pendingTasks.set('req-2', { taskId: 2, requestId: 'req-2', timestamp: staleTimestamp });
  
  const mockDbService = {
    getTaskStatus: jest.fn()
      .mockReturnValueOnce(4) // IN_PROGRESS for task 1
      .mockReturnValueOnce(1), // COMPLETE for task 2
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  // Inject mocks
  
  // Act: Call cleanupStaleTasks (may need test access)
  await service.cleanupStaleTasks();
  
  // Assert
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(1, 0); // Reset task 1 to ready
  expect(mockDbService.updateTaskStatus).not.toHaveBeenCalledWith(2, expect.anything()); // Task 2 not reset
  expect(service.pendingTasks.has('req-1')).toBe(false); // Removed
  expect(service.pendingTasks.has('req-2')).toBe(false); // Removed
});
```

- [ ] Test case written and passes
- [ ] Test verifies stale task identification
- [ ] Test verifies IN_PROGRESS reset and COMPLETE removal

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add cleanupStaleTasks stale task reset test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies stale task cleanup scenarios
- [ ] Test verifies status-based handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

