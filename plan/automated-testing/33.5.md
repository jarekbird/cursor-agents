# TASK-033.5: Test checkAndCleanupEmptyQueue - don't delete queue with jobs

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.6.5
**Task ID**: TASK-033.5

## Description

Add a test case for the `checkAndCleanupEmptyQueue` method to verify it does NOT delete queues that have jobs, even if they are non-default queues. Only empty queues should be deleted.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `checkAndCleanupEmptyQueue()` method

## Current State

The `checkAndCleanupEmptyQueue` method:
- Only deletes queues when they are empty (zero jobs)
- Does not delete queues that have jobs

The test file `tests/queue/queue-manager.test.ts` exists with previous tests including TASK-033.1 through TASK-033.4.

**Important**: This task should be executed after TASK-033.4, completing TASK-033.

## Checklist

### Preparation and Setup

- [ ] Review `checkAndCleanupEmptyQueue` queue emptiness check logic
- [ ] Understand how job count is determined
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for queue with jobs protection
  - [ ] Create test: `it('should not delete queue with jobs', async () => { ... })`
    - [ ] Arrange: Queue with jobs
    - [ ] Mock `deleteQueue` method
    - [ ] Act: Call `checkAndCleanupEmptyQueue(queue)`
    - [ ] Assert: `deleteQueue` not called

### Specific Requirements

- [ ] Requirement 1: Test must verify queue with jobs protection
  - Acceptance: Queues with jobs are not deleted
- [ ] Requirement 2: Test must verify job count check
  - Acceptance: Queue job count is checked before deletion

### Error Handling and Edge Cases

- [ ] Handle case where job count is zero but queue appears to have jobs
- [ ] Verify job count determination works correctly

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining queue with jobs protection
- [ ] Document why queues with jobs are not deleted

### Verification

- [ ] Verify test passes consistently
- [ ] Verify queue with jobs protection works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-033.4 (completes TASK-033)
- **Dependencies**: 
  - TASK-033.4: Test checkAndCleanupEmptyQueue - don't delete default queue
- **Important Considerations**: 
  - This is the fifth and final subtask for TASK-033
  - Only empty queues should be deleted
- **Task Independence**: Can be completed independently after TASK-033.4
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-033 (Add tests for removeAgent and checkAndCleanupEmptyQueue)
- Previous: TASK-033.4 (Test checkAndCleanupEmptyQueue - don't delete default queue)
- Next: TASK-034 (Add tests for PromptProcessor.process() method)
- Dependencies:
  - TASK-033.4: Test checkAndCleanupEmptyQueue - don't delete default queue
- Related:
  - TASK-033.1 through TASK-033.4: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `checkAndCleanupEmptyQueue` to verify queues with jobs are not deleted.

**Definition of Done**: "A test case is written that verifies `checkAndCleanupEmptyQueue` does NOT delete queues that have jobs. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue with jobs protection works so that active queues are never deleted.
   - **Acceptance Criteria**: 
     - Test verifies queues with jobs are not deleted
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('checkAndCleanupEmptyQueue', () => {
  it('should not delete queue with jobs', async () => {
    // Arrange: Queue with jobs
    // Act: checkAndCleanupEmptyQueue(queue)
    // Assert: deleteQueue not called
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies queue with jobs protection

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add checkAndCleanupEmptyQueue queue with jobs protection test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies queue with jobs protection
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-033 (all subtasks) is complete**

