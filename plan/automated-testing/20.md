# TASK-020: Test happy path processNextTask

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.5
**Task ID**: TASK-020

## Description

Add a comprehensive test case for the `processNextTask` method happy path to verify it correctly processes a task from start to finish. The test should verify lock acquisition, task retrieval, status update, conversation creation, async iteration, and pending task tracking.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `processNextTask()` method happy path

## Current State

The `processNextTask` method:
- Acquires Redis lock
- Gets next ready task from database
- Updates task status to IN_PROGRESS
- Creates new conversation via cursor-runner API
- Calls async iterate endpoint
- Stores pending task entry
- Returns success result
- Lock is NOT released immediately (callback will release it)

The test file `tests/services/task-operator-service.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-019.

## Checklist

### Preparation and Setup

- [ ] Review `processNextTask` happy path implementation
- [ ] Understand conversation creation flow
- [ ] Understand async iterate call flow
- [ ] Review pending task tracking

### Implementation Steps

- [ ] Step 1: Set up comprehensive mocks
  - [ ] Mock Redis `set` to return `'OK'` (lock acquired)
  - [ ] Mock `DatabaseService.getNextReadyTask` to return sample task
  - [ ] Mock `DatabaseService.updateTaskStatus` to succeed
  - [ ] Mock `fetch` for conversation creation (POST `/cursor/conversation/new`)
  - [ ] Mock `fetch` for async iterate (POST `/cursor/iterate/async`)
- [ ] Step 2: Write happy path test
  - [ ] Create test: `it('should process task successfully through happy path', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Sample task: `{ id: 1, prompt: 'test', order: 0, uuid: 'test-uuid', status: 0 }`
    - [ ] Mock conversation creation to return `{ conversationId: 'conv-123' }`
    - [ ] Mock async iterate to return `{ success: true }`
  - [ ] Act: Call `processNextTask()`
  - [ ] Assert: 
    - [ ] Result is `{ processed: true, taskId: 1 }`
    - [ ] Task status updated to IN_PROGRESS (status 4)
    - [ ] Pending task entry stored with `requestId`
    - [ ] Lock is NOT released (callback will release it)
    - [ ] Conversation creation was called
    - [ ] Async iterate was called

### Specific Requirements

- [ ] Requirement 1: Test must verify complete happy path
  - Acceptance: All steps execute successfully
- [ ] Requirement 2: Test must verify task status update
  - Acceptance: Task is marked IN_PROGRESS
- [ ] Requirement 3: Test must verify pending task tracking
  - Acceptance: Pending task entry is stored
- [ ] Requirement 4: Test must verify lock is not released
  - Acceptance: Lock remains held (callback will release)

### Error Handling and Edge Cases

- [ ] Handle case where conversation creation succeeds but iterate fails (covered in TASK-022)
- [ ] Verify requestId is generated correctly
- [ ] Test that pending task has correct structure
- [ ] Verify all HTTP calls are made correctly

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify all mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining happy path flow
- [ ] Document why lock is not released immediately
- [ ] Note pending task structure

### Verification

- [ ] Verify test passes consistently
- [ ] Verify all steps execute correctly
- [ ] Verify pending task tracking works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-019
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-019: Test processNextTask with no tasks
- **Important Considerations**: 
  - This is the most complex test in Phase 2
  - Requires mocking multiple external dependencies (Redis, Database, HTTP)
  - Lock is intentionally not released (callback handles it)
  - Pending task tracking is critical for callback handling
- **Task Independence**: Can be completed independently after TASK-019
- **Current State**: Test file exists with previous tests

## Related Tasks

- Previous: TASK-019 (Test processNextTask with no tasks)
- Next: TASK-021 (Test conversation creation failure)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-019: Test processNextTask with no tasks
- Related:
  - TASK-021, TASK-022: Will test error paths
  - TASK-024: Will test callback handling

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a comprehensive test case for the `processNextTask` happy path.

**Definition of Done**: "A comprehensive test case is written that verifies `processNextTask` correctly processes a task through the complete happy path: lock acquisition, task retrieval, status update, conversation creation, async iteration, and pending task tracking. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify the happy path works so that I can trust task processing functions correctly.
   - **Acceptance Criteria**: 
     - Test verifies all steps execute successfully
     - Test verifies task is processed correctly
     - Test passes consistently

2. **As a developer**, I want to verify pending task tracking works so that callbacks can be handled correctly.
   - **Acceptance Criteria**:
     - Test verifies pending task entry is stored
     - Test verifies requestId is generated
     - Test verifies task structure is correct

### Automated Tests

The test case should be:

```typescript
it('should process task successfully through happy path', async () => {
  // Arrange: Comprehensive mocks
  const sampleTask = { id: 1, prompt: 'test', order: 0, uuid: 'test-uuid', status: 0 };
  const mockRedis = { set: jest.fn().mockResolvedValue('OK') };
  const mockDbService = {
    getNextReadyTask: jest.fn().mockReturnValue(sampleTask),
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  global.fetch = jest.fn()
    .mockResolvedValueOnce({ // Conversation creation
      ok: true,
      text: () => Promise.resolve(JSON.stringify({ conversationId: 'conv-123' })),
    })
    .mockResolvedValueOnce({ // Async iterate
      ok: true,
      json: () => Promise.resolve({ success: true }),
    });
  
  const service = TaskOperatorService.getInstance(mockRedis);
  // Inject mocks
  
  // Act
  const result = await service.processNextTask();
  
  // Assert
  expect(result).toEqual({ processed: true, taskId: 1 });
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(1, 4); // IN_PROGRESS
  // Verify pending task entry
  // Verify lock not released
});
```

- [ ] Test case written and passes
- [ ] Test verifies complete happy path
- [ ] Test verifies pending task tracking
- [ ] Test verifies lock is not released

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add processNextTask happy path test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies complete happy path
- [ ] Test verifies pending task tracking
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
