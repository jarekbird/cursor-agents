# TASK-045.1: Add tests for POST /task-operator/callback - secret authentication

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.8.1
**Task ID**: TASK-045.1

## Description

Add test cases for the `POST /task-operator/callback` endpoint to verify it correctly handles webhook secret authentication. The tests should verify secret validation from headers and query string, and return 401 for missing or incorrect secrets.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator/callback` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `POST /task-operator/callback` endpoint:
- Validates webhook secret from headers or query string
- Returns 401 when secret is missing or incorrect

The test file `tests/app.test.ts` exists but may not have comprehensive callback endpoint tests.

**Important**: This task should be executed after TASK-044. This is the first subtask of TASK-045.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator/callback` endpoint implementation
- [ ] Understand webhook secret validation (headers vs query string)
- [ ] Review existing `app.test.ts` structure
- [ ] Understand secret header names

### Implementation Steps

- [ ] Step 1: Write tests for secret handling
  - [ ] Create test: `it('should return 401 when secret is missing', async () => { ... })`
    - [ ] Arrange: No secret in headers or query
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: 401, "Unauthorized"
  - [ ] Create test: `it('should return 401 when secret is incorrect', async () => { ... })`
    - [ ] Arrange: Wrong secret
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: 401, "Unauthorized"
  - [ ] Create test: `it('should accept secret from headers', async () => { ... })`
    - [ ] Arrange: Secret in header (e.g., `X-Webhook-Secret`)
    - [ ] Act: POST `/task-operator/callback` with valid secret
    - [ ] Assert: Proceeds to requestId checks (not 401)
  - [ ] Create test: `it('should accept secret from query string', async () => { ... })`
    - [ ] Arrange: Secret in query string (`?secret=...`)
    - [ ] Act: POST `/task-operator/callback` with valid secret
    - [ ] Assert: Proceeds to requestId checks (not 401)

### Specific Requirements

- [ ] Requirement 1: Test must verify secret authentication
  - Acceptance: 401 returned for missing/incorrect secrets, accepts from headers/query
- [ ] Requirement 2: Test must verify secret sources
  - Acceptance: Secrets from both headers and query string are accepted

### Error Handling and Edge Cases

- [ ] Handle case where secret is in both headers and query
- [ ] Verify secret comparison is case-sensitive (if applicable)
- [ ] Test with various secret formats

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining secret validation
- [ ] Document secret header names and query parameter

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify authentication works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-044
- **Dependencies**: 
  - TASK-044: Add tests for /task-operator/lock endpoints
- **Important Considerations**: 
  - Webhook secret provides security for callback endpoint
  - Secret can be in headers (`X-Webhook-Secret` or similar) or query string (`?secret=...`)
  - This is the first of 4 subtasks for TASK-045
- **Task Independence**: Can be completed independently after TASK-044
- **Current State**: Test file exists but may not have comprehensive callback endpoint tests

## Related Tasks

- Parent: TASK-045 (Add tests for /task-operator/callback endpoint)
- Next: TASK-045.2 (Add tests for POST /task-operator/callback - requestId validation)
- Dependencies:
  - TASK-044: Add tests for /task-operator/lock endpoints
- Related:
  - TASK-045.2, TASK-045.3, TASK-045.4: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for `POST /task-operator/callback` secret authentication.

**Definition of Done**: "Test cases are added that verify `POST /task-operator/callback` correctly handles webhook secret authentication from headers and query string, and returns 401 for missing or incorrect secrets. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify secret authentication works so that callbacks are secure.
   - **Acceptance Criteria**: 
     - Test verifies 401 for missing/incorrect secrets
     - Test verifies secrets from headers/query are accepted
     - Test passes consistently

### Automated Tests

Test cases should include:

```typescript
describe('POST /task-operator/callback', () => {
  beforeEach(() => {
    process.env.WEBHOOK_SECRET = 'test-secret';
  });
  
  afterEach(() => {
    delete process.env.WEBHOOK_SECRET;
  });
  
  it('should return 401 when secret is missing', async () => {
    // Arrange: No secret in headers or query
    // Act: POST /task-operator/callback
    // Assert: 401, "Unauthorized"
  });
  
  it('should return 401 when secret is incorrect', async () => {
    // Arrange: Wrong secret
    // Act & Assert: 401
  });
  
  it('should accept secret from headers', async () => {
    // Arrange: Secret in X-Webhook-Secret header
    // Act & Assert: Proceeds to requestId checks
  });
  
  it('should accept secret from query string', async () => {
    // Arrange: Secret in query string
    // Act & Assert: Proceeds to requestId checks
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify secret authentication
- [ ] Tests verify secret sources

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator/callback secret authentication tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify authentication
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

