# TASK-013: Test updateTaskStatus when old complete column exists

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.10
**Task ID**: TASK-013

## Description

Add a test case for the `updateTaskStatus` method to verify it correctly handles the case where the old `complete` column still exists in the `tasks` table. The test should verify that the method logs a warning about the deprecated column but still successfully updates the task status. This tests backward compatibility with legacy database schemas.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 142-198) - `updateTaskStatus()` method with complete column warning

## Current State

The `updateTaskStatus` method:
- Checks for the old `complete` column using `PRAGMA table_info`
- Logs a warning if `complete` column exists (should be removed by migration)
- Still updates task status successfully
- The warning is informational, not a blocker

The test file `tests/services/database-service.test.ts` exists with previous task tests.

**Important**: This task should be executed after TASK-012 (test updateTaskStatus with existing updatedat).

## Checklist

### Preparation and Setup

- [ ] Review `updateTaskStatus` complete column warning logic
- [ ] Understand how to add `complete` column to test table
- [ ] Review logger mocking patterns for warning verification
- [ ] Understand why `complete` column is deprecated

### Implementation Steps

- [ ] Step 1: Set up logger mock
  - [ ] Mock the logger module if needed
  - [ ] Set up spy on `logger.warn` to verify warning logging
- [ ] Step 2: Set up test database with complete column
  - [ ] Create `tasks` table with: `id`, `prompt`, `"order"`, `uuid`, `status`, `updatedat`, `complete`
  - [ ] Insert a test task row
- [ ] Step 3: Write test for complete column warning
  - [ ] Create test: `it('should log warning when old complete column exists', () => { ... })`
  - [ ] Arrange: 
    - [ ] Create `tasks` table with `complete` column
    - [ ] Insert a task with `id=1`, `status=0`
  - [ ] Act: Call `updateTaskStatus(1, 4)` (set to in_progress)
  - [ ] Assert: 
    - [ ] Method returns `true`
    - [ ] Task status is updated to 4
    - [ ] `logger.warn` was called with message about `complete` column
    - [ ] Warning message mentions migration should remove it

### Specific Requirements

- [ ] Requirement 1: Test must verify warning is logged
  - Acceptance: `logger.warn` is called when `complete` column exists
- [ ] Requirement 2: Test must verify status update still works
  - Acceptance: Task status is updated successfully despite warning
- [ ] Requirement 3: Test must verify method returns true
  - Acceptance: `updateTaskStatus` returns `true` on success
- [ ] Requirement 4: Test must use table with complete column
  - Acceptance: Table is created with `complete` column

### Error Handling and Edge Cases

- [ ] Handle case where complete column has data
- [ ] Verify warning doesn't prevent status update
- [ ] Test that method works normally otherwise
- [ ] Verify warning message is descriptive

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify warning is logged correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining complete column deprecation
- [ ] Document why warning is logged
- [ ] Note that this is for backward compatibility

### Verification

- [ ] Verify test passes consistently
- [ ] Verify warning is logged
- [ ] Verify status update works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-012
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-012: Test updateTaskStatus with existing updatedat
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create table with `complete` column to test warning
  - Warning is informational, not an error
  - The `complete` column should be removed by migrations but method handles its presence
- **Task Independence**: Can be completed independently after TASK-012
- **Current State**: Test file exists with previous task tests

## Related Tasks

- Previous: TASK-012 (Test updateTaskStatus when updatedat already exists)
- Next: TASK-014 (Test getTaskStatus and markTaskComplete)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-012: Test updateTaskStatus with existing updatedat
- Related:
  - TASK-011, TASK-012: Other updateTaskStatus tests
  - TASK-014: Will test task status reading

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `updateTaskStatus` when the old `complete` column exists.

**Definition of Done**: "A test case is written that verifies `updateTaskStatus` logs a warning when the old `complete` column exists but still successfully updates the task status. The test verifies the warning is logged and the status update works. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify backward compatibility works so that legacy databases continue to function.
   - **Acceptance Criteria**: 
     - Test verifies status update works with old `complete` column
     - Test verifies warning is logged for deprecation notice
     - Test verifies method returns true

2. **As a developer**, I want to verify deprecation warnings are logged so that I know when migrations are needed.
   - **Acceptance Criteria**:
     - Test verifies `logger.warn` is called
     - Warning message mentions `complete` column and migration

### Automated Tests

The test case should be:

```typescript
it('should log warning when old complete column exists', () => {
  // Arrange: Create tasks table with complete column
  const db = new Database(':memory:');
  db.exec(`
    CREATE TABLE tasks (
      id INTEGER PRIMARY KEY,
      prompt TEXT,
      "order" INTEGER,
      uuid TEXT,
      status INTEGER,
      updatedat DATETIME DEFAULT CURRENT_TIMESTAMP,
      complete INTEGER
    )
  `);
  db.prepare('INSERT INTO tasks (id, prompt, "order", uuid, status) VALUES (?, ?, ?, ?, ?)')
    .run(1, 'Test prompt', 0, 'test-uuid', 0);
  
  const service = new DatabaseService(':memory:');
  // Mock logger.warn
  
  // Act
  const result = service.updateTaskStatus(1, 4);
  
  // Assert
  expect(result).toBe(true);
  // Verify status was updated
  const task = db.prepare('SELECT status FROM tasks WHERE id = ?').get(1);
  expect(task.status).toBe(4);
  // Verify warning was logged
  expect(logger.warn).toHaveBeenCalledWith(
    expect.stringContaining('complete column'),
    expect.any(Object)
  );
});
```

- [ ] Test case written and passes
- [ ] Test verifies warning is logged
- [ ] Test verifies status update works
- [ ] Test verifies method returns true

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add updateTaskStatus with old complete column test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies warning logging
- [ ] Test verifies status update
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
