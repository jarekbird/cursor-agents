# TASK-039.1: Test /admin/queues/refresh - successful refresh

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.2.1
**Task ID**: TASK-039.1

## Description

Add a test case for the `/admin/queues/refresh` endpoint to verify it correctly refreshes the Bull Board dashboard and returns success with queue count. The test should verify the happy path.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/admin/queues/refresh` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/admin/queues/refresh` endpoint:
- Accepts POST requests
- Calls internal `updateBullBoard()` method (or refreshes via `queueManager.getQueues()`)
- Returns JSON: `{ success: true, queueCount: <number> }` on success

The test file `tests/app.test.ts` exists but may not have `/admin/queues/refresh` tests.

**Important**: This task should be executed after TASK-038. This is the first subtask of TASK-039.

## Checklist

### Preparation and Setup

- [ ] Review `/admin/queues/refresh` endpoint implementation
- [ ] Understand `updateBullBoard()` or queue refresh mechanism
- [ ] Review existing `app.test.ts` structure
- [ ] Understand how to spy on internal methods

### Implementation Steps

- [ ] Step 1: Write test for happy path
  - [ ] Create test: `it('should refresh Bull Board and return queue count', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Create app instance
    - [ ] Spy on `updateBullBoard` or instrument via `queueManager.getQueues()`
    - [ ] Mock queue manager to return queues
  - [ ] Act: POST to `/admin/queues/refresh` using `supertest`
  - [ ] Assert: 
    - [ ] Response status is 200
    - [ ] Response body is `{ success: true, queueCount: <number> }`
    - [ ] `updateBullBoard` or refresh method was called

### Specific Requirements

- [ ] Requirement 1: Test must verify successful refresh
  - Acceptance: Returns success with queue count
- [ ] Requirement 2: Test must verify queue count
  - Acceptance: Queue count reflects actual number of queues

### Error Handling and Edge Cases

- [ ] Handle case where no queues exist (queueCount = 0)
- [ ] Test with various queue counts

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining refresh endpoint
- [ ] Document queue count calculation

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify refresh works correctly
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-038
- **Dependencies**: 
  - TASK-038: Extend app.test.ts for Bull Board base path
- **Important Considerations**: 
  - Refresh endpoint allows manual dashboard updates
  - Queue count provides visibility into system state
  - This is the first of 2 subtasks for TASK-039
- **Task Independence**: Can be completed independently after TASK-038
- **Current State**: Test file exists but may not have refresh endpoint tests

## Related Tasks

- Parent: TASK-039 (Add tests for /admin/queues/refresh)
- Next: TASK-039.2 (Test /admin/queues/refresh - error handling)
- Dependencies:
  - TASK-038: Extend app.test.ts for Bull Board base path
- Related:
  - TASK-039.2: Will test error handling

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `/admin/queues/refresh` successful refresh.

**Definition of Done**: "A test case is written that verifies `/admin/queues/refresh` correctly refreshes Bull Board dashboard and returns success with queue count. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify refresh endpoint works so that Bull Board can be manually refreshed.
   - **Acceptance Criteria**: 
     - Test verifies refresh returns success with queue count
     - Test verifies refresh method is called
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('POST /admin/queues/refresh', () => {
  it('should refresh Bull Board and return queue count', async () => {
    // Arrange: Mock queue manager, spy on updateBullBoard
    const app = new CursorAgentsApp();
    const updateBullBoardSpy = jest.spyOn(app, 'updateBullBoard');
    // Or spy on queueManager.getQueues()
    
    // Act
    const response = await request(app.getApp())
      .post('/admin/queues/refresh')
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      success: true,
      queueCount: expect.any(Number),
    });
    expect(updateBullBoardSpy).toHaveBeenCalled();
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify successful refresh
- [ ] Tests verify queue count

### Git Commit and Push Requirements

- [ ] Test case added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /admin/queues/refresh successful refresh test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify refresh functionality
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

