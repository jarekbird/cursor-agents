# TASK-011: Test updateTaskStatus with updatedat column missing

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.8
**Task ID**: TASK-011

## Description

Add a test case for the `updateTaskStatus` method to verify it correctly handles the case where the `updatedat` column is missing from the `tasks` table. The test should verify that the method automatically adds the column via `ALTER TABLE` and then successfully updates the task status. This tests the schema migration capability of the method.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 142-198) - `updateTaskStatus()` method with schema migration

## Current State

The `updateTaskStatus` method:
- Checks if `updatedat` column exists using `PRAGMA table_info`
- Adds `updatedat` column if missing via `ALTER TABLE`
- Updates task status and `updatedat` timestamp
- Handles race conditions where column might be added by another process

The test file `tests/services/database-service.test.ts` exists with previous task tests.

**Important**: This task should be executed after TASK-010 (test getNextReadyTask).

## Checklist

### Preparation and Setup

- [ ] Review `updateTaskStatus` schema migration logic
- [ ] Understand `PRAGMA table_info` usage
- [ ] Understand `ALTER TABLE ADD COLUMN` in SQLite
- [ ] Review how to create tables without `updatedat` column

### Implementation Steps

- [ ] Step 1: Set up test database with tasks table (without updatedat)
  - [ ] Create `tasks` table with: `id`, `prompt`, `"order"`, `uuid`, `status`
  - [ ] Intentionally omit `updatedat` column
  - [ ] Insert a test task row
- [ ] Step 2: Write test for missing column
  - [ ] Create test: `it('should add updatedat column and update task status when column is missing', () => { ... })`
  - [ ] Arrange: 
    - [ ] Create `tasks` table without `updatedat` column
    - [ ] Insert a task with `id=1`, `status=0` (ready)
  - [ ] Act: Call `updateTaskStatus(1, 4)` (set to in_progress)
  - [ ] Assert: 
    - [ ] Method returns `true`
    - [ ] Task status is updated to 4
    - [ ] `updatedat` column exists after the call
    - [ ] Column can be queried (verify it was added)
- [ ] Step 3: Verify column was added
  - [ ] Query `PRAGMA table_info(tasks)` after update
  - [ ] Assert: `updatedat` column exists in table schema
  - [ ] Optionally verify column has correct type (DATETIME)

### Specific Requirements

- [ ] Requirement 1: Test must verify column is added
  - Acceptance: `updatedat` column exists after calling `updateTaskStatus`
- [ ] Requirement 2: Test must verify status is updated
  - Acceptance: Task status changes to the new value
- [ ] Requirement 3: Test must verify method returns true
  - Acceptance: `updateTaskStatus` returns `true` on success
- [ ] Requirement 4: Test must use table without updatedat initially
  - Acceptance: Table is created without `updatedat` column

### Error Handling and Edge Cases

- [ ] Handle case where `ALTER TABLE` fails (column already exists from race condition)
- [ ] Verify method handles race conditions gracefully
- [ ] Test that subsequent calls work correctly after column is added
- [ ] Verify column type is correct (DATETIME)

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify column is actually added to schema
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining schema migration test
- [ ] Document why `updatedat` column is added automatically
- [ ] Note any race condition handling

### Verification

- [ ] Verify test passes consistently
- [ ] Verify column is added correctly
- [ ] Verify status update works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-010
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-010: Test getNextReadyTask behavior
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create table without `updatedat` to test migration
  - Verify column is added via PRAGMA query
  - The method handles race conditions where column might be added concurrently
- **Task Independence**: Can be completed independently after TASK-010
- **Current State**: Test file exists with previous task tests

## Related Tasks

- Previous: TASK-010 (Test getNextReadyTask behavior)
- Next: TASK-012 (Test updateTaskStatus when updatedat already exists)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-010: Test getNextReadyTask behavior
- Related:
  - TASK-012: Will test the case where column already exists
  - TASK-013: Will test warning for old `complete` column

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `updateTaskStatus` when the `updatedat` column is missing.

**Definition of Done**: "A test case is written that verifies `updateTaskStatus` automatically adds the `updatedat` column when it's missing and successfully updates the task status. The test verifies the column is added and the status is updated correctly. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify schema migration works so that the system can handle legacy databases.
   - **Acceptance Criteria**: 
     - Test verifies `updatedat` column is added automatically
     - Test verifies status update works after column is added
     - Test verifies method returns true on success

2. **As a developer**, I want to verify backward compatibility so that existing databases continue to work.
   - **Acceptance Criteria**:
     - Test verifies migration doesn't break existing functionality
     - Test verifies column is added with correct type

### Automated Tests

The test case should be:

```typescript
it('should add updatedat column and update task status when column is missing', () => {
  // Arrange: Create tasks table without updatedat column
  const db = new Database(':memory:');
  db.exec(`
    CREATE TABLE tasks (
      id INTEGER PRIMARY KEY,
      prompt TEXT,
      "order" INTEGER,
      uuid TEXT,
      status INTEGER
    )
  `);
  db.prepare('INSERT INTO tasks (id, prompt, "order", uuid, status) VALUES (?, ?, ?, ?, ?)')
    .run(1, 'Test prompt', 0, 'test-uuid', 0);
  
  const service = new DatabaseService(':memory:');
  // Need to use same database instance or inject it
  
  // Act
  const result = service.updateTaskStatus(1, 4);
  
  // Assert
  expect(result).toBe(true);
  // Verify status was updated
  const task = db.prepare('SELECT status FROM tasks WHERE id = ?').get(1);
  expect(task.status).toBe(4);
  
  // Verify updatedat column exists
  const tableInfo = db.prepare('PRAGMA table_info(tasks)').all();
  const hasUpdatedAt = tableInfo.some((col: any) => col.name === 'updatedat');
  expect(hasUpdatedAt).toBe(true);
});
```

- [ ] Test case written and passes
- [ ] Test verifies column is added
- [ ] Test verifies status is updated
- [ ] Test verifies method returns true

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add updateTaskStatus with missing updatedat column test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies column addition
- [ ] Test verifies status update
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
