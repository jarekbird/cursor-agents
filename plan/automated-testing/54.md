# TASK-054: Measure coverage and identify remaining gaps

**Section**: 8. Coverage & CI Tightening
**Subsection**: 8.1
**Task ID**: TASK-054

## Description

Run test coverage analysis and identify files in `src/` (excluding entrypoints) with significantly low coverage. This task involves running the coverage command, analyzing results, and documenting gaps for targeted test development.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/jest.config.js` - coverage configuration
- `virtual-assistant/cursor-agents/package.json` - test:coverage script

## Current State

The project has Jest configured with coverage collection. The `npm run test:coverage` command should generate coverage reports showing line, branch, function, and statement coverage for all files in `src/`.

Coverage reports are generated in `coverage/` directory with HTML, LCOV, and text formats.

**Important**: This task should be executed after Phase 7 (TASK-050 through TASK-053).

## Checklist

### Preparation and Setup

- [ ] Review Jest coverage configuration
- [ ] Understand coverage report formats
- [ ] Review coverage exclusion patterns (entrypoints)
- [ ] Understand how to interpret coverage metrics

### Implementation Steps

- [ ] Step 1: Run coverage analysis
  - [ ] Run `npm run test:coverage`
  - [ ] Wait for coverage report generation
  - [ ] Review coverage output (text, HTML, LCOV)
- [ ] Step 2: Analyze coverage results
  - [ ] Identify files with low coverage (< 70% or project threshold)
  - [ ] Note specific uncovered lines/branches
  - [ ] Document complex branches that need testing
  - [ ] Identify error paths that aren't tested
- [ ] Step 3: Document coverage gaps
  - [ ] Create list of under-covered files
  - [ ] Note specific uncovered areas (functions, branches)
  - [ ] Prioritize gaps by importance
  - [ ] Document findings for TASK-055

### Specific Requirements

- [ ] Requirement 1: Test must run coverage analysis
  - Acceptance: Coverage report is generated successfully
- [ ] Requirement 2: Test must identify low coverage files
  - Acceptance: Files with < threshold coverage are identified
- [ ] Requirement 3: Test must document gaps
  - Acceptance: Coverage gaps are documented with specifics
- [ ] Requirement 4: Test must exclude entrypoints
  - Acceptance: Entrypoints are excluded from analysis

### Error Handling and Edge Cases

- [ ] Handle case where coverage command fails
- [ ] Verify coverage reports are generated correctly
- [ ] Check that entrypoints are properly excluded
- [ ] Verify coverage thresholds are reasonable

### Testing

- [ ] Run `npm run test:coverage` to verify it executes
- [ ] Verify coverage reports are generated
- [ ] Review HTML coverage report for visual analysis
- [ ] **DO NOT manually test by running the server** - use automated coverage analysis only

### Documentation

- [ ] Document coverage analysis results
- [ ] Create list of under-covered areas
- [ ] Note coverage thresholds and goals
- [ ] Document findings for next task

### Verification

- [ ] Verify coverage analysis completes successfully
- [ ] Verify coverage reports are generated
- [ ] Verify gaps are identified
- [ ] Confirm analysis follows project conventions

## Notes

- This task is part of **Phase 8 â€“ Coverage & CI Tightening**
- **Execution Timing**: Should be executed after Phase 7 (TASK-050 through TASK-053)
- **Dependencies**: 
  - TASK-050 through TASK-053: Phase 7 integration tests
- **Important Considerations**: 
  - Coverage analysis identifies untested code
  - Entrypoints are excluded (index.ts, mcp/index.ts)
  - Low coverage areas need targeted tests
  - Coverage metrics: lines, branches, functions, statements
  - HTML report provides visual coverage map
  - This is an analysis task, not a test writing task
- **Task Independence**: Can be completed independently after Phase 7
- **Current State**: Coverage command exists but gaps may not be documented

## Related Tasks

- Previous: TASK-053 (Add E2E-lite entrypoint tests) - Completes Phase 7
- Next: TASK-055 (Add targeted tests for uncovered branches)
- Dependencies:
  - TASK-050 through TASK-053: Phase 7 integration tests
- Related:
  - TASK-055: Will add tests based on coverage gaps identified here

## Definition of Done

### Task Type: TESTING TASK (Analysis)

**Description**: This task involves running coverage analysis and identifying gaps.

**Definition of Done**: "Coverage analysis is run successfully, under-covered files are identified, and gaps are documented with specifics. Coverage report shows current state. Findings are ready for TASK-055. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to know test coverage so that I can identify untested code.
   - **Acceptance Criteria**: 
     - Coverage analysis completes successfully
     - Coverage reports are generated
     - Under-covered files are identified

2. **As a developer**, I want to see coverage gaps so that I can prioritize test development.
   - **Acceptance Criteria**:
     - Coverage gaps are documented
     - Specific uncovered areas are noted
     - Gaps are prioritized

### Automated Tests

**Note**: This is an analysis task. Coverage analysis should be run:

```bash
npm run test:coverage
```

Coverage output should be reviewed:
- Text summary in terminal
- HTML report in `coverage/index.html`
- LCOV report in `coverage/lcov.info`

- [ ] Coverage analysis run successfully
- [ ] Coverage reports generated
- [ ] Under-covered files identified
- [ ] Gaps documented

### Git Commit and Push Requirements

- [ ] Coverage analysis results documented (may be in comments or separate file)
- [ ] Commit message follows project conventions (e.g., "test: analyze coverage and identify gaps")
- [ ] Changes are pushed to origin
- [ ] Commit includes coverage analysis findings

### Final Checklist

- [ ] Coverage analysis completed
- [ ] Under-covered files identified
- [ ] Gaps documented
- [ ] Findings ready for TASK-055
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
