# TASK-046.2: Enhance MCP tests - list_agents JSON structure assertions

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.1.2
**Task ID**: TASK-046.2

## Description

Enhance the existing test for the `list_agents` MCP tool to add comprehensive JSON payload assertions. The test should verify that `content[0].text` is valid JSON and assert the exact structure (keys, types) for the list_agents tool.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - `list_agents` tool handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The `list_agents` MCP tool:
- Lists all agents
- Returns MCP response with `content[0].text` containing JSON
- JSON should contain: `agents` array

The test file `tests/mcp/server.test.ts` exists with previous tests including TASK-046.1.

**Important**: This task should be executed after TASK-046.1.

## Checklist

### Preparation and Setup

- [ ] Review `list_agents` tool handler implementation
- [ ] Understand MCP response format (`content[0].text` as JSON)
- [ ] Review test setup from TASK-046.1

### Implementation Steps

- [ ] Step 1: Enhance existing list_agents test with JSON assertions
  - [ ] Find existing test for list_agents
  - [ ] Add JSON parsing: `const content = JSON.parse(response.content[0].text)`
  - [ ] Assert JSON contains: `agents` array
  - [ ] Assert agent objects have required fields
  - [ ] Assert array structure is correct

### Specific Requirements

- [ ] Requirement 1: Test must verify JSON is valid
  - Acceptance: `content[0].text` parses as valid JSON
- [ ] Requirement 2: Test must verify structure
  - Acceptance: All required keys are present with correct types
- [ ] Requirement 3: Test must verify array structure
  - Acceptance: Agents array has correct structure

### Error Handling and Edge Cases

- [ ] Handle case where no agents exist (empty array)
- [ ] Verify agent object structure
- [ ] Test with various agent configurations

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining JSON structure assertions
- [ ] Document expected JSON schema for list_agents

### Verification

- [ ] Verify test passes consistently
- [ ] Verify JSON parsing works
- [ ] Verify structure assertions work
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-046.1
- **Dependencies**: 
  - TASK-046.1: Enhance MCP tests - create_agent JSON structure assertions
- **Important Considerations**: 
  - This is the second of 7 subtasks for TASK-046
- **Task Independence**: Can be completed independently after TASK-046.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions)
- Previous: TASK-046.1 (Enhance MCP tests - create_agent JSON structure assertions)
- Next: TASK-046.3 (Enhance MCP tests - get_agent_status JSON structure assertions)
- Dependencies:
  - TASK-046.1: Enhance MCP tests - create_agent JSON structure assertions
- Related:
  - TASK-046.1, TASK-046.3 through TASK-046.7: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves enhancing the list_agents MCP tool test with JSON structure assertions.

**Definition of Done**: "The list_agents MCP tool test is enhanced with JSON parsing and structure assertions. Test verifies exact JSON structure (agents array, agent object fields). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify JSON structure is correct so that MCP clients receive expected data.
   - **Acceptance Criteria**: 
     - Test verifies JSON is valid
     - Test verifies agents array structure is correct
     - Test verifies agent objects have required fields

### Automated Tests

Test enhancements should include:

```typescript
describe('list_agents MCP tool', () => {
  it('should return valid JSON with agents array', async () => {
    // Arrange & Act
    // Assert
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('agents', expect.any(Array));
    content.agents.forEach(agent => {
      expect(agent).toHaveProperty('name');
      expect(agent).toHaveProperty('isActive');
    });
  });
});
```

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure

### Git Commit and Push Requirements

- [ ] Test enhancements added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance list_agents MCP tool with JSON structure assertions")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test enhancements

### Final Checklist

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

