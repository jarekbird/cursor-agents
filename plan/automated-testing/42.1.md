# TASK-042.1: Add tests for POST /agents endpoint

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.5.1
**Task ID**: TASK-042.1

## Description

Add comprehensive test cases for the `POST /agents` endpoint to verify validation, happy paths (one-time and recurring agents), and error handling. The tests should verify all validation rules and agent creation scenarios.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `POST /agents` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `POST /agents` endpoint:
- Creates one-time or recurring agents with validation
- Validates: name, targetUrl, schedule requirements (for recurring)
- Uses `addOneTimeAgent` or `addRecurringAgent` methods

The test file `tests/app.test.ts` exists but may not have comprehensive `POST /agents` endpoint tests.

**Important**: This task should be executed after TASK-041. This is the first subtask of TASK-042.

## Checklist

### Preparation and Setup

- [ ] Review `POST /agents` endpoint implementation
- [ ] Understand validation rules (name, targetUrl, schedule requirements)
- [ ] Review existing `app.test.ts` structure
- [ ] Understand agent creation methods (`addOneTimeAgent`, `addRecurringAgent`)

### Implementation Steps

- [ ] Step 1: Write tests for POST /agents validation
  - [ ] Create test: `it('should return 400 when name is missing', async () => { ... })`
  - [ ] Create test: `it('should return 400 when targetUrl is missing', async () => { ... })`
  - [ ] Create test: `it('should return 400 when oneTime=false and no schedule', async () => { ... })`
- [ ] Step 2: Write tests for POST /agents happy paths
  - [ ] Create test: `it('should create one-time agent with defaults', async () => { ... })`
  - [ ] Create test: `it('should create recurring agent with schedule', async () => { ... })`
- [ ] Step 3: Write tests for POST /agents error path
  - [ ] Create test: `it('should return 500 when queue method rejects', async () => { ... })`

### Specific Requirements

- [ ] Requirement 1: Test must verify POST validation
  - Acceptance: All validation errors return 400 with descriptive messages
- [ ] Requirement 2: Test must verify POST happy paths
  - Acceptance: One-time and recurring agents are created correctly
- [ ] Requirement 3: Test must verify error handling
  - Acceptance: Errors return 500 with descriptive messages

### Error Handling and Edge Cases

- [ ] Handle case where agent name contains special characters
- [ ] Test with various agent configurations
- [ ] Verify default values (method, timeout, queue)

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining agent endpoint behavior
- [ ] Document validation rules

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify validation works
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-041
- **Dependencies**: 
  - TASK-041: Add tests for /queues/:queueName DELETE
- **Important Considerations**: 
  - This is the first of 4 subtasks for TASK-042
  - Validation rules must match implementation exactly
  - Default values (method, timeout, queue) should be verified
- **Task Independence**: Can be completed independently after TASK-041
- **Current State**: Test file exists but may not have comprehensive POST /agents endpoint tests

## Related Tasks

- Parent: TASK-042 (Add tests for /agents endpoints)
- Next: TASK-042.2 (Add tests for GET /agents endpoint)
- Dependencies:
  - TASK-041: Add tests for /queues/:queueName DELETE
- Related:
  - TASK-042.2, TASK-042.3, TASK-042.4: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding comprehensive test cases for the `POST /agents` endpoint.

**Definition of Done**: "Test cases are added that verify `POST /agents` endpoint with validation, happy paths (one-time and recurring), and error handling. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent creation works so that agents can be created via API.
   - **Acceptance Criteria**: 
     - Test verifies validation works correctly
     - Test verifies one-time and recurring agents are created
     - Test passes consistently

### Automated Tests

Test cases should include:

```typescript
describe('POST /agents', () => {
  it('should return 400 when name is missing', async () => {
    // Arrange: Request without name
    // Act: POST /agents
    // Assert: 400, error message
  });
  
  it('should create one-time agent with defaults', async () => {
    // Arrange: Valid one-time agent request
    // Act: POST /agents
    // Assert: 200, addOneTimeAgent called with defaults
  });
  
  it('should create recurring agent with schedule', async () => {
    // Arrange: Valid recurring agent request
    // Act: POST /agents
    // Assert: 200, addRecurringAgent called with schedule
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify validation
- [ ] Tests verify happy paths
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add POST /agents endpoint comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify validation and happy paths
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

