# TASK-033: Add tests for removeAgent and checkAndCleanupEmptyQueue

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.6
**Task ID**: TASK-033

**NOTE**: This task has been split into granular subtasks:
- **TASK-033.1**: Test removeAgent - remove jobs
- **TASK-033.2**: Test removeAgent - error handling
- **TASK-033.3**: Test checkAndCleanupEmptyQueue - delete non-default queue
- **TASK-033.4**: Test checkAndCleanupEmptyQueue - don't delete default queue
- **TASK-033.5**: Test checkAndCleanupEmptyQueue - don't delete queue with jobs

Please execute the subtasks (33.1, 33.2, 33.3, 33.4, 33.5) instead of this parent task.

## Description

Add test cases for the `removeAgent` and `checkAndCleanupEmptyQueue` methods to verify they correctly remove agents and clean up empty queues. The tests should verify repeatable job removal, waiting/delayed job removal, error handling, and automatic queue cleanup when queues become empty.

**This task has been split into subtasks - see TASK-033.1 through TASK-033.5**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `removeAgent()` and `checkAndCleanupEmptyQueue()` methods
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `removeAgent` method:
- Finds the queue containing the agent
- Removes repeatable jobs matching the agent
- Removes waiting and delayed jobs matching the agent
- Logs errors for individual job removal failures but continues
- Calls `checkAndCleanupEmptyQueue` after removal

The `checkAndCleanupEmptyQueue` method:
- Checks if a queue has zero waiting/active/delayed/repeatable jobs
- For non-default queues with no jobs: calls `deleteQueue`
- For default queue or queues with jobs: does not call `deleteQueue`

The test file `tests/queue/queue-manager.test.ts` exists but may not have comprehensive tests for these methods.

**Important**: This task should be executed after TASK-032.

## Checklist

### Preparation and Setup

- [ ] Review `removeAgent` and `checkAndCleanupEmptyQueue` implementations
- [ ] Understand repeatable job removal (`removeRepeatableByKey`)
- [ ] Understand job removal from different states
- [ ] Review queue cleanup logic

### Implementation Steps

- [ ] Step 1: Write tests for `removeAgent`
  - [ ] Create test: `it('should remove repeatable and waiting/delayed jobs for agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock queue with repeatable jobs and waiting/delayed jobs
      - [ ] Set up spies on removal methods
    - [ ] Act: Call `removeAgent('test')`
    - [ ] Assert: 
      - [ ] Repeatable jobs removed
      - [ ] Waiting/delayed jobs removed
      - [ ] `checkAndCleanupEmptyQueue` called
  - [ ] Create test: `it('should continue when individual job removal fails', async () => { ... })`
    - [ ] Arrange: Some removal methods throw
    - [ ] Act: Call `removeAgent('test')`
    - [ ] Assert: 
      - [ ] Errors are logged
      - [ ] Process continues
      - [ ] Other jobs still removed
- [ ] Step 2: Write tests for `checkAndCleanupEmptyQueue`
  - [ ] Create test: `it('should delete non-default queue when empty', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Non-default queue with zero jobs
      - [ ] Mock `deleteQueue` method
    - [ ] Act: Call `checkAndCleanupEmptyQueue(queue)`
    - [ ] Assert: `deleteQueue` called
  - [ ] Create test: `it('should not delete default queue even when empty', async () => { ... })`
    - [ ] Arrange: Default queue with zero jobs
    - [ ] Act: Call `checkAndCleanupEmptyQueue(defaultQueue)`
    - [ ] Assert: `deleteQueue` not called
  - [ ] Create test: `it('should not delete queue with jobs', async () => { ... })`
    - [ ] Arrange: Queue with jobs
    - [ ] Act: Call `checkAndCleanupEmptyQueue(queue)`
    - [ ] Assert: `deleteQueue` not called

### Specific Requirements

- [ ] Requirement 1: Test must verify agent removal
  - Acceptance: Repeatable and waiting/delayed jobs are removed
- [ ] Requirement 2: Test must verify error handling
  - Acceptance: Individual failures don't abort process
- [ ] Requirement 3: Test must verify queue cleanup
  - Acceptance: Empty non-default queues are deleted
- [ ] Requirement 4: Test must verify default queue protection
  - Acceptance: Default queue is never deleted

### Error Handling and Edge Cases

- [ ] Handle case where agent not found
- [ ] Handle case where queue not found
- [ ] Verify cleanup is called even if removal fails
- [ ] Test with queues in various states

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining removal logic
- [ ] Document why default queue is protected
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify agent removal works
- [ ] Verify queue cleanup works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-032
- **Dependencies**: 
  - TASK-032: Add tests for getAgentStatus and findAgentQueue
- **Important Considerations**: 
  - Agent removal must clean up all job types
  - Error handling prevents one failure from blocking others
  - Queue cleanup prevents resource leaks
  - Default queue protection ensures system stability
  - `checkAndCleanupEmptyQueue` is called automatically after removal
- **Task Independence**: Can be completed independently after TASK-032
- **Current State**: Test file exists but may not have comprehensive removeAgent tests

## Related Tasks

- Previous: TASK-032 (Add tests for getAgentStatus and findAgentQueue)
- Next: TASK-034 (Add tests for deleteQueue)
- Dependencies:
  - TASK-032: Add tests for getAgentStatus and findAgentQueue
- Related:
  - TASK-034: Will test deleteQueue method used by cleanup

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `removeAgent` and `checkAndCleanupEmptyQueue` methods.

**Definition of Done**: "Test cases are added that verify `removeAgent` correctly removes all agent jobs, handles errors gracefully, and triggers queue cleanup. Tests verify `checkAndCleanupEmptyQueue` correctly deletes empty non-default queues and protects default queue. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent removal works so that agents can be deleted cleanly.
   - **Acceptance Criteria**: 
     - Test verifies all job types are removed
     - Test verifies errors don't abort process
     - Test passes consistently

2. **As a developer**, I want to verify queue cleanup works so that empty queues don't accumulate.
   - **Acceptance Criteria**:
     - Test verifies empty non-default queues are deleted
     - Test verifies default queue is protected
     - Test verifies queues with jobs are not deleted

### Automated Tests

Test cases should include:

```typescript
describe('removeAgent', () => {
  it('should remove repeatable and waiting/delayed jobs for agent', async () => {
    // Arrange: Mock queue with jobs
    const mockQueue = {
      removeRepeatableByKey: jest.fn().mockResolvedValue(undefined),
      getWaiting: jest.fn().mockResolvedValue([{ id: '1', name: 'agent:test' }]),
      getDelayed: jest.fn().mockResolvedValue([]),
      remove: jest.fn().mockResolvedValue(undefined),
    };
    // Act: removeAgent('test')
    // Assert: All removal methods called, checkAndCleanupEmptyQueue called
  });
  
  it('should continue when individual job removal fails', async () => {
    // Arrange: Some removals throw
    // Act & Assert: Errors logged, process continues
  });
});

describe('checkAndCleanupEmptyQueue', () => {
  it('should delete non-default queue when empty', async () => {
    // Arrange: Empty non-default queue
    // Act & Assert: deleteQueue called
  });
  
  it('should not delete default queue even when empty', async () => {
    // Arrange: Empty default queue
    // Act & Assert: deleteQueue not called
  });
  
  it('should not delete queue with jobs', async () => {
    // Arrange: Queue with jobs
    // Act & Assert: deleteQueue not called
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify agent removal
- [ ] Tests verify error handling
- [ ] Tests verify queue cleanup

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add removeAgent and checkAndCleanupEmptyQueue comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify agent removal
- [ ] Tests verify queue cleanup
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
