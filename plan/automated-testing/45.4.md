# TASK-045.4: Add tests for POST /task-operator/callback - error handling

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.8.4
**Task ID**: TASK-045.4

## Description

Add a test case for the `POST /task-operator/callback` endpoint to verify it correctly handles errors when `handleCallback` throws. The endpoint should return 200 with error in body (not 500) to prevent retries, and log the error.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator/callback` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `POST /task-operator/callback` endpoint:
- Returns 200 with error in body when handleCallback throws (doesn't return 500)
- Logs errors for debugging

The test file `tests/app.test.ts` exists with previous tests including TASK-045.1, TASK-045.2, and TASK-045.3.

**Important**: This task should be executed after TASK-045.3, completing TASK-045 and Phase 5.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator/callback` endpoint error handling
- [ ] Understand why 200 is returned instead of 500 (prevent retries)
- [ ] Review error logging patterns
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for internal error
  - [ ] Create test: `it('should return 200 with error when handleCallback throws', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Valid secret, requestId
      - [ ] `handleCallback` throws error
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: 
      - [ ] 200, `{ received: true, error: 'Internal error processing callback' }`
      - [ ] Error is logged

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: 200 returned with error in body (not 500), error logged
- [ ] Requirement 2: Test must verify error logging
  - Acceptance: Error is logged for debugging

### Error Handling and Edge Cases

- [ ] Verify error messages are descriptive
- [ ] Test with various error types
- [ ] Verify logging occurs correctly

### Testing

- [ ] Run `npm run test:http` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling approach
- [ ] Document why 200 is returned instead of 500

### Verification

- [ ] Verify test passes consistently
- [ ] Verify error handling works
- [ ] Verify error logging works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-045.3 (completes TASK-045 and Phase 5)
- **Dependencies**: 
  - TASK-045.3: Add tests for POST /task-operator/callback - successful processing
- **Important Considerations**: 
  - Internal errors return 200 with error in body (not 500) to prevent retries
  - Error logging is important for debugging
  - This is the fourth and final subtask for TASK-045
- **Task Independence**: Can be completed independently after TASK-045.3
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-045 (Add tests for /task-operator/callback endpoint)
- Previous: TASK-045.3 (Add tests for POST /task-operator/callback - successful processing)
- Next: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions) - Starts Phase 6
- Dependencies:
  - TASK-045.3: Add tests for POST /task-operator/callback - successful processing
- Related:
  - TASK-024, TASK-025: Tested handleCallback in unit tests
  - TASK-045.1, TASK-045.2, TASK-045.3: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding a test case for `POST /task-operator/callback` error handling.

**Definition of Done**: "A test case is written that verifies `POST /task-operator/callback` correctly handles errors when handleCallback throws, returning 200 with error in body (not 500) and logging the error. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that errors are handled gracefully without causing retries.
   - **Acceptance Criteria**:
     - Test verifies errors return 200 with error in body (not 500)
     - Test verifies errors are logged

### Automated Tests

The test case should be:

```typescript
describe('POST /task-operator/callback', () => {
  it('should return 200 with error when handleCallback throws', async () => {
    // Arrange: handleCallback throws
    mockTaskOperatorService.handleCallback.mockRejectedValue(new Error('Processing failed'));
    
    // Act
    const response = await request(app.getApp())
      .post('/task-operator/callback')
      .set('X-Webhook-Secret', 'test-secret')
      .send({ requestId: 'req-123' })
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      received: true,
      error: 'Internal error processing callback',
    });
    // Verify error logged
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies error handling
- [ ] Test verifies error logging

### Git Commit and Push Requirements

- [ ] Test case added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator/callback error handling test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies error handling
- [ ] Test verifies error logging
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-045 (all subtasks) is complete**
- [ ] **Phase 5 (HTTP/API Black-box Tests) is complete**

