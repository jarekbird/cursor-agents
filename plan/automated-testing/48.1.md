# TASK-048.1: Add tests for MCP resources - resource listing

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.3.1
**Task ID**: TASK-048.1

## Description

Add test cases for MCP resources functionality to verify resource listing returns URIs in the form `agent://{name}`. The tests should verify that the resource list handler correctly discovers all agents and returns them with the correct URI format.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - MCP resource list handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The MCP server implements resources:
- Resource listing: Returns list of agent URIs (`agent://{name}`)

The test file `tests/mcp/server.test.ts` exists but may not have comprehensive resource tests.

**Important**: This task should be executed after TASK-047. This is the first subtask of TASK-048.

## Checklist

### Preparation and Setup

- [ ] Review MCP resource list handler implementation
- [ ] Understand resource URI format (`agent://{name}`)
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand resource list handler access

### Implementation Steps

- [ ] Step 1: Write test for resource listing
  - [ ] Create test: `it('should list agent resources with correct URIs', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `listQueues` to return queue names
      - [ ] Set up resource list handler access (may need test-only access)
    - [ ] Act: Invoke resource list handler
    - [ ] Assert: 
      - [ ] URIs are of form `agent://{name}`
      - [ ] `resourceCount` equals number of queues
      - [ ] All queue names are represented

### Specific Requirements

- [ ] Requirement 1: Test must verify resource listing
  - Acceptance: URIs are correct format, resourceCount is correct
- [ ] Requirement 2: Test must verify URI format
  - Acceptance: URIs follow `agent://{name}` pattern

### Error Handling and Edge Cases

- [ ] Handle case where no agents exist (empty list)
- [ ] Verify URI parsing works correctly
- [ ] Test with various agent configurations

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining resource functionality
- [ ] Document URI format

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify resource listing works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-047
- **Dependencies**: 
  - TASK-047: Add tests for queue-related MCP tools
- **Important Considerations**: 
  - MCP resources provide structured access to agents
  - URI format `agent://{name}` is standard MCP pattern
  - Resource listing discovers available agents
  - May need test-only access to resource handlers or thin wrapper
  - This is the first of 2 subtasks for TASK-048
- **Task Independence**: Can be completed independently after TASK-047
- **Current State**: Test file exists but may not have comprehensive resource tests

## Related Tasks

- Parent: TASK-048 (Add tests for MCP resources (agents))
- Next: TASK-048.2 (Add tests for MCP resources - resource reading)
- Dependencies:
  - TASK-047: Add tests for queue-related MCP tools
- Related:
  - TASK-048.2: Will test resource reading

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for MCP resource listing.

**Definition of Done**: "Test cases are added that verify MCP resource listing returns correct URIs in the form `agent://{name}` with correct resourceCount. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify resource listing works so that MCP clients can discover agents.
   - **Acceptance Criteria**: 
     - Test verifies URIs are in correct format
     - Test verifies resourceCount is correct
     - Test passes consistently

### Automated Tests

Test cases should include:

```typescript
describe('MCP resources (agents)', () => {
  it('should list agent resources with correct URIs', async () => {
    // Arrange: Mock listQueues
    mockQueueManager.listQueues.mockReturnValue(['q1', 'q2', 'q3']);
    
    // Act: Invoke resource list handler
    const resources = await resourceListHandler();
    
    // Assert
    expect(resources.resourceCount).toBe(3);
    resources.resources.forEach(resource => {
      expect(resource.uri).toMatch(/^agent:\/\//);
      expect(resource.uri).toBe(`agent://${resource.name}`);
    });
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify resource listing

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add MCP resource listing tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify resource listing
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

