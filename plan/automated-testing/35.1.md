# TASK-035.1: Test re-enqueueing - trigger and delay extraction

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.1.1
**Task ID**: TASK-035.1

## Description

Add a test case for the `PromptProcessor.process()` method to verify it correctly triggers re-enqueueing when HTTP response includes `requeue: true` and extracts the delay value. The test should verify that `addDelayedAgent` is called with the correct delay.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - re-enqueueing logic
- `virtual-assistant/cursor-agents/tests/queue/prompt-processor.test.ts` - existing test structure

## Current State

The `PromptProcessor.process()` method:
- Checks HTTP response for `requeue: true` flag
- If requeue is true, extracts `delay` from response
- Calls `QueueManager.addDelayedAgent()` with agent config and delay

The test file `tests/queue/prompt-processor.test.ts` already exists with some tests but may not cover re-enqueueing.

**Important**: This task should be executed after Phase 3 (TASK-028 through TASK-034). This is the first subtask of TASK-035.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` re-enqueueing implementation
- [ ] Understand HTTP response structure for requeue
- [ ] Review existing `prompt-processor.test.ts` structure
- [ ] Understand `QueueManager.addDelayedAgent` usage

### Implementation Steps

- [ ] Step 1: Set up test infrastructure
  - [ ] Inject mock `QueueManager` into `PromptProcessor` constructor
  - [ ] Set up spy on `addDelayedAgent` method
- [ ] Step 2: Write test for re-enqueueing trigger and delay
  - [ ] Create test: `it('should re-enqueue agent when response has requeue: true and extract delay', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Agent job data
    - [ ] Mock HTTP response with `{ requeue: true, delay: 5000, condition: 'retry after delay' }`
    - [ ] Mock `fetch` to return this response
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with agent config
    - [ ] `addDelayedAgent` called with `delay: 5000`

### Specific Requirements

- [ ] Requirement 1: Test must verify re-enqueueing trigger
  - Acceptance: `addDelayedAgent` called when `requeue: true`
- [ ] Requirement 2: Test must verify delay extraction
  - Acceptance: Delay from response is used

### Error Handling and Edge Cases

- [ ] Handle case where delay is missing
- [ ] Verify requeue flag is checked correctly
- [ ] Test with various delay values

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining re-enqueueing logic
- [ ] Document response structure requirements

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify re-enqueueing works
- [ ] Verify delay extraction works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after Phase 3 (TASK-028 through TASK-034)
- **Dependencies**: 
  - TASK-028 through TASK-034: Phase 3 QueueManager tests
- **Important Considerations**: 
  - Re-enqueueing allows agents to retry after delays
  - Delay is extracted from response JSON
  - This is the first of 2 subtasks for TASK-035
- **Task Independence**: Can be completed independently after Phase 3
- **Current State**: Test file exists but may not cover re-enqueueing

## Related Tasks

- Parent: TASK-035 (Extend prompt-processor.test.ts for re-enqueueing)
- Next: TASK-035.2 (Test re-enqueueing - config preservation)
- Dependencies:
  - TASK-028 through TASK-034: Phase 3 tests
- Related:
  - TASK-035.2: Will test config preservation

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for re-enqueueing trigger and delay extraction.

**Definition of Done**: "A test case is written that verifies re-enqueueing is triggered when HTTP response includes `requeue: true` and delay is extracted correctly. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify re-enqueueing works so that agents can retry after delays.
   - **Acceptance Criteria**: 
     - Test verifies `addDelayedAgent` is called when requeue is true
     - Test verifies delay is extracted correctly
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('re-enqueueing', () => {
  it('should re-enqueue agent when response has requeue: true and extract delay', async () => {
    // Arrange: Mock QueueManager, HTTP response with requeue
    const mockQueueManager = {
      addDelayedAgent: jest.fn().mockResolvedValue({ id: 'job-1' }),
    };
    const processor = new PromptProcessor(mockQueueManager);
    const jobData = {
      name: 'test-agent',
      targetUrl: 'http://example.com',
      method: 'GET',
    };
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve({
        requeue: true,
        delay: 5000,
        condition: 'retry after delay',
      }),
    });
    
    // Act
    await processor.process({ data: jobData });
    
    // Assert
    expect(mockQueueManager.addDelayedAgent).toHaveBeenCalledWith(
      expect.anything(), // queue
      jobData, // same config
      5000 // delay from response
    );
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify re-enqueueing trigger
- [ ] Tests verify delay extraction

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add re-enqueueing trigger and delay extraction test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify re-enqueueing
- [ ] Tests verify delay extraction
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

