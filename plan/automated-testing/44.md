# TASK-044: Add tests for /task-operator/lock endpoints

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.7
**Task ID**: TASK-044

**NOTE**: This task has been split into granular subtasks:
- **TASK-044.1**: Add tests for GET /task-operator/lock endpoint
- **TASK-044.2**: Add tests for DELETE /task-operator/lock endpoint

Please execute the subtasks (44.1, 44.2) instead of this parent task.

## Description

Add test cases for the `/task-operator/lock` endpoints (`GET /task-operator/lock` and `DELETE /task-operator/lock`) to verify they correctly check and clear the task operator lock. The tests should verify lock status checking and lock clearing with various scenarios.

**This task has been split into subtasks - see TASK-044.1 and TASK-044.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator/lock` endpoints
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/task-operator/lock` endpoints:
- `GET /task-operator/lock`: Checks if task operator is processing (lock exists)
- `DELETE /task-operator/lock`: Clears the task operator lock

The test file `tests/app.test.ts` exists but may not have comprehensive `/task-operator/lock` endpoint tests.

**Important**: This task should be executed after TASK-043.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator/lock` endpoint implementations
- [ ] Understand `isProcessing` and `clearLock` methods (from TASK-026)
- [ ] Review existing `app.test.ts` structure
- [ ] Understand lock status response format

### Implementation Steps

- [ ] Step 1: Write tests for `GET /task-operator/lock`
  - [ ] Create test: `it('should return lock status when processing', async () => { ... })`
    - [ ] Arrange: Mock `isProcessing` to return `true`
    - [ ] Act: GET `/task-operator/lock`
    - [ ] Assert: 200, `{ isLocked: true, message: <string> }`
  - [ ] Create test: `it('should return lock status when not processing', async () => { ... })`
    - [ ] Arrange: Mock `isProcessing` to return `false`
    - [ ] Act: GET `/task-operator/lock`
    - [ ] Assert: 200, `{ isLocked: false, message: <string> }`
  - [ ] Create test: `it('should return 500 when isProcessing throws', async () => { ... })`
    - [ ] Arrange: Mock `isProcessing` to throw
    - [ ] Act: GET `/task-operator/lock`
    - [ ] Assert: 500, error "Failed to check task operator lock status"
- [ ] Step 2: Write tests for `DELETE /task-operator/lock`
  - [ ] Create test: `it('should clear lock and return lockCleared: true', async () => { ... })`
    - [ ] Arrange: Mock `clearLock` to return `true`
    - [ ] Act: DELETE `/task-operator/lock`
    - [ ] Assert: 200, `{ lockCleared: true }`
  - [ ] Create test: `it('should return lockCleared: false when lock did not exist', async () => { ... })`
    - [ ] Arrange: Mock `clearLock` to return `false`
    - [ ] Act: DELETE `/task-operator/lock`
    - [ ] Assert: 200, `{ lockCleared: false }`
  - [ ] Create test: `it('should return 500 when clearLock throws', async () => { ... })`
    - [ ] Arrange: Mock `clearLock` to throw
    - [ ] Act: DELETE `/task-operator/lock`
    - [ ] Assert: 500, error "Failed to clear task operator lock"

### Specific Requirements

- [ ] Requirement 1: Test must verify GET lock status
  - Acceptance: Returns lock status correctly (true/false)
- [ ] Requirement 2: Test must verify DELETE lock clearing
  - Acceptance: Clears lock and returns appropriate status
- [ ] Requirement 3: Test must verify error handling
  - Acceptance: Errors return 500 with descriptive messages
- [ ] Requirement 4: Test must verify message strings
  - Acceptance: Response includes descriptive message strings

### Error Handling and Edge Cases

- [ ] Handle case where lock state changes between calls
- [ ] Verify message strings are descriptive
- [ ] Test with various lock states
- [ ] Verify error messages match implementation

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining lock endpoints
- [ ] Document lock status response format
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify lock status checking works
- [ ] Verify lock clearing works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-043
- **Dependencies**: 
  - TASK-043: Add tests for /task-operator endpoints
- **Important Considerations**: 
  - Lock endpoints provide visibility and control over task operator processing
  - GET endpoint is read-only, DELETE endpoint modifies state
  - Lock status messages should be descriptive
  - clearLock returning false is not an error (lock didn't exist)
  - Error messages must match implementation exactly
- **Task Independence**: Can be completed independently after TASK-043
- **Current State**: Test file exists but may not have comprehensive /task-operator/lock endpoint tests

## Related Tasks

- Previous: TASK-043 (Add tests for /task-operator endpoints)
- Next: TASK-045 (Add tests for /task-operator/callback endpoint)
- Dependencies:
  - TASK-043: Add tests for /task-operator endpoints
- Related:
  - TASK-026: Tested isProcessing and clearLock in unit tests
  - TASK-045: Will test callback endpoint

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `/task-operator/lock` endpoints.

**Definition of Done**: "Test cases are added that verify `GET /task-operator/lock` correctly returns lock status and `DELETE /task-operator/lock` correctly clears locks, with proper error handling. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify lock status checking works so that I can see if task operator is processing.
   - **Acceptance Criteria**: 
     - Test verifies lock status is returned correctly
     - Test verifies message strings are descriptive
     - Test passes consistently

2. **As a developer**, I want to verify lock clearing works so that stuck locks can be manually cleared.
   - **Acceptance Criteria**:
     - Test verifies lock is cleared successfully
     - Test verifies lockCleared status is returned
     - Test verifies errors are handled gracefully

### Automated Tests

Test cases should include:

```typescript
describe('GET /task-operator/lock', () => {
  it('should return lock status when processing', async () => {
    // Arrange: isProcessing returns true
    mockTaskOperatorService.isProcessing.mockResolvedValue(true);
    
    // Act
    const response = await request(app.getApp())
      .get('/task-operator/lock')
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      isLocked: true,
      message: expect.any(String),
    });
  });
  
  it('should return lock status when not processing', async () => {
    // Arrange: isProcessing returns false
    // Act & Assert: isLocked: false
  });
  
  it('should return 500 when isProcessing throws', async () => {
    // Arrange: isProcessing throws
    // Act & Assert: 500, "Failed to check task operator lock status"
  });
});

describe('DELETE /task-operator/lock', () => {
  it('should clear lock and return lockCleared: true', async () => {
    // Arrange: clearLock returns true
    // Act: DELETE /task-operator/lock
    // Assert: 200, lockCleared: true
  });
  
  it('should return lockCleared: false when lock did not exist', async () => {
    // Arrange: clearLock returns false
    // Act & Assert: 200, lockCleared: false
  });
  
  it('should return 500 when clearLock throws', async () => {
    // Arrange: clearLock throws
    // Act & Assert: 500, "Failed to clear task operator lock"
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify lock status checking
- [ ] Tests verify lock clearing
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator/lock endpoints tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify lock status checking
- [ ] Tests verify lock clearing
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
