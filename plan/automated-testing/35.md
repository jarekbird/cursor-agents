# TASK-035: Extend prompt-processor.test.ts for re-enqueueing

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.1
**Task ID**: TASK-035

**NOTE**: This task has been split into granular subtasks:
- **TASK-035.1**: Test re-enqueueing - trigger and delay extraction
- **TASK-035.2**: Test re-enqueueing - config preservation

Please execute the subtasks (35.1, 35.2) instead of this parent task.

## Description

Extend the existing `tests/queue/prompt-processor.test.ts` file to add test cases for conditional re-enqueueing. The tests should verify that when an HTTP response includes `{ requeue: true, delay: 5000, condition: '...' }`, the `addDelayedAgent` method is called with the same agent config and specified delay.

**This task has been split into subtasks - see TASK-035.1 and TASK-035.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - re-enqueueing logic
- `virtual-assistant/cursor-agents/tests/queue/prompt-processor.test.ts` - existing test structure

## Current State

The `PromptProcessor.process()` method:
- Processes HTTP agent jobs
- Checks HTTP response for `requeue: true` flag
- If requeue is true, extracts `delay` and `condition` from response
- Calls `QueueManager.addDelayedAgent()` with agent config and delay
- Logs condition information

The test file `tests/queue/prompt-processor.test.ts` already exists with some tests but may not cover re-enqueueing.

**Important**: This task should be executed after Phase 3 (TASK-028 through TASK-034).

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` re-enqueueing implementation
- [ ] Understand HTTP response structure for requeue
- [ ] Review existing `prompt-processor.test.ts` structure
- [ ] Understand `QueueManager.addDelayedAgent` usage

### Implementation Steps

- [ ] Step 1: Set up test infrastructure
  - [ ] Inject mock `QueueManager` into `PromptProcessor` constructor
  - [ ] Set up spy on `addDelayedAgent` method
- [ ] Step 2: Write test for re-enqueueing
  - [ ] Create test: `it('should re-enqueue agent when response has requeue: true', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Agent job data
    - [ ] Mock HTTP response with `{ requeue: true, delay: 5000, condition: 'retry after delay' }`
    - [ ] Mock `fetch` to return this response
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with agent config
    - [ ] `addDelayedAgent` called with `delay: 5000`
    - [ ] Condition is logged (if testable)
- [ ] Step 3: Verify agent config preservation
  - [ ] Assert: Original agent config is passed to `addDelayedAgent`
  - [ ] Assert: No modifications to config

### Specific Requirements

- [ ] Requirement 1: Test must verify re-enqueueing trigger
  - Acceptance: `addDelayedAgent` called when `requeue: true`
- [ ] Requirement 2: Test must verify delay extraction
  - Acceptance: Delay from response is used
- [ ] Requirement 3: Test must verify config preservation
  - Acceptance: Original agent config is preserved
- [ ] Requirement 4: Test must verify condition logging
  - Acceptance: Condition is logged (if testable)

### Error Handling and Edge Cases

- [ ] Handle case where `addDelayedAgent` fails
- [ ] Handle case where delay is missing
- [ ] Verify requeue flag is checked correctly
- [ ] Test with various delay values

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining re-enqueueing logic
- [ ] Document response structure requirements
- [ ] Note condition logging behavior

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify re-enqueueing works
- [ ] Verify delay extraction works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after Phase 3 (TASK-028 through TASK-034)
- **Dependencies**: 
  - TASK-028 through TASK-034: Phase 3 QueueManager tests
- **Important Considerations**: 
  - Re-enqueueing allows agents to retry after delays
  - Delay is extracted from response JSON
  - Condition provides context for why requeue occurred
  - Agent config must be preserved exactly
  - Existing test file should be extended, not replaced
- **Task Independence**: Can be completed independently after Phase 3
- **Current State**: Test file exists but may not cover re-enqueueing

## Related Tasks

- Previous: TASK-034 (Add tests for deleteQueue) - Completes Phase 3
- Next: TASK-036 (Add tests for no re-enqueue conditions)
- Dependencies:
  - TASK-028 through TASK-034: Phase 3 tests
- Related:
  - TASK-036: Will test cases where requeue is false
  - TASK-037: Will test task-operator internal jobs

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves extending existing tests for conditional re-enqueueing.

**Definition of Done**: "Test cases are added to `tests/queue/prompt-processor.test.ts` that verify re-enqueueing works when HTTP response includes `requeue: true`, with correct delay extraction and agent config preservation. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify re-enqueueing works so that agents can retry after delays.
   - **Acceptance Criteria**: 
     - Test verifies `addDelayedAgent` is called when requeue is true
     - Test verifies delay is extracted correctly
     - Test passes consistently

2. **As a developer**, I want to verify config preservation works so that agent settings are maintained.
   - **Acceptance Criteria**:
     - Test verifies original agent config is preserved
     - Test verifies no modifications to config

### Automated Tests

Test cases should include:

```typescript
describe('re-enqueueing', () => {
  it('should re-enqueue agent when response has requeue: true', async () => {
    // Arrange: Mock QueueManager, HTTP response with requeue
    const mockQueueManager = {
      addDelayedAgent: jest.fn().mockResolvedValue({ id: 'job-1' }),
    };
    const processor = new PromptProcessor(mockQueueManager);
    const jobData = {
      name: 'test-agent',
      targetUrl: 'http://example.com',
      method: 'GET',
    };
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve({
        requeue: true,
        delay: 5000,
        condition: 'retry after delay',
      }),
    });
    
    // Act
    await processor.process({ data: jobData });
    
    // Assert
    expect(mockQueueManager.addDelayedAgent).toHaveBeenCalledWith(
      expect.anything(), // queue
      jobData, // same config
      5000 // delay from response
    );
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify re-enqueueing trigger
- [ ] Tests verify delay extraction
- [ ] Tests verify config preservation

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add re-enqueueing tests to prompt-processor")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify re-enqueueing
- [ ] Tests verify delay extraction
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
