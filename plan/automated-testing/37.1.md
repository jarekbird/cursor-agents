# TASK-037.1: Test task-operator internal jobs - disabled case

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.3.1
**Task ID**: TASK-037.1

## Description

Add a test case for task-operator internal jobs to verify that when the task operator is disabled, no processing occurs and no re-enqueueing happens. This verifies the disabled state handling.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - task-operator internal job handling

## Current State

The `PromptProcessor.process()` method:
- Detects task-operator internal jobs via `targetUrl: 'task-operator://internal'`
- Checks if task operator is enabled via `TaskOperatorService.isTaskOperatorEnabled()`
- If disabled: no processing, no re-enqueue

The test file `tests/queue/prompt-processor.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-036. This is the first subtask of TASK-037.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` task-operator handling
- [ ] Understand `TaskOperatorService.isTaskOperatorEnabled()` usage
- [ ] Review existing test structure

### Implementation Steps

- [ ] Step 1: Write test for task operator disabled
  - [ ] Create test: `it('should not process when task operator is disabled', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Job with `targetUrl: 'task-operator://internal'`
    - [ ] Mock `isTaskOperatorEnabled` to return `false`
    - [ ] Set up spies on `processNextTask` and `addDelayedAgent`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `processNextTask` not called
    - [ ] `addDelayedAgent` not called

### Specific Requirements

- [ ] Requirement 1: Test must verify disabled case
  - Acceptance: No processing when task operator disabled
- [ ] Requirement 2: Test must verify no re-enqueue
  - Acceptance: `addDelayedAgent` is not called

### Error Handling and Edge Cases

- [ ] Verify task-operator detection works correctly
- [ ] Test with various job configurations

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining disabled state handling

### Verification

- [ ] Verify test passes consistently
- [ ] Verify disabled state handling works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after TASK-036
- **Dependencies**: 
  - TASK-036: Add tests for no re-enqueue conditions
- **Important Considerations**: 
  - Task-operator internal jobs use special `targetUrl: 'task-operator://internal'`
  - This is the first of 5 subtasks for TASK-037
- **Task Independence**: Can be completed independently after TASK-036
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-037 (Add tests for task-operator internal jobs)
- Next: TASK-037.2 (Test task-operator internal jobs - processed task case)
- Dependencies:
  - TASK-036: Add tests for no re-enqueue conditions
- Related:
  - TASK-037.2 through TASK-037.5: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for task-operator internal jobs when disabled.

**Definition of Done**: "A test case is written that verifies task-operator internal jobs are not processed when the task operator is disabled. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify disabled state handling works so that task operator can be safely disabled.
   - **Acceptance Criteria**: 
     - Test verifies no processing occurs when disabled
     - Test verifies no re-enqueue occurs
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('task-operator internal jobs', () => {
  it('should not process when task operator is disabled', async () => {
    // Arrange: isTaskOperatorEnabled returns false
    // Act: promptProcessor.process(job)
    // Assert: No calls to processNextTask or addDelayedAgent
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies disabled state handling

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add task-operator disabled case test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies disabled state handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

