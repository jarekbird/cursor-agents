# TASK-045: Add tests for /task-operator/callback endpoint

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.8
**Task ID**: TASK-045

**NOTE**: This task has been split into granular subtasks:
- **TASK-045.1**: Add tests for POST /task-operator/callback - secret authentication
- **TASK-045.2**: Add tests for POST /task-operator/callback - requestId validation
- **TASK-045.3**: Add tests for POST /task-operator/callback - successful processing
- **TASK-045.4**: Add tests for POST /task-operator/callback - error handling

Please execute the subtasks (45.1, 45.2, 45.3, 45.4) instead of this parent task.

## Description

Add comprehensive test cases for the `POST /task-operator/callback` endpoint to verify it correctly handles webhook callbacks from cursor-runner. The tests should verify secret authentication, requestId validation, successful callback processing, and error handling.

**This task has been split into subtasks - see TASK-045.1 through TASK-045.4**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator/callback` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `POST /task-operator/callback` endpoint:
- Accepts POST requests with callback data
- Validates webhook secret from headers or query string
- Validates requestId in body (checks both `requestId` and `request_id`)
- Calls `TaskOperatorService.handleCallback()` with requestId and callback data
- Returns 200 with `{ received: true, requestId }` on success
- Returns 401 when secret is missing or incorrect
- Returns 400 when requestId is missing
- Returns 200 with error in body when handleCallback throws (doesn't return 500)

The test file `tests/app.test.ts` exists but may not have comprehensive callback endpoint tests.

**Important**: This task should be executed after TASK-044, completing Phase 5.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator/callback` endpoint implementation
- [ ] Understand webhook secret validation (headers vs query string)
- [ ] Review existing `app.test.ts` structure
- [ ] Understand requestId validation (requestId vs request_id)

### Implementation Steps

- [ ] Step 1: Write tests for secret handling
  - [ ] Create test: `it('should return 401 when secret is missing', async () => { ... })`
  - [ ] Create test: `it('should return 401 when secret is incorrect', async () => { ... })`
  - [ ] Create test: `it('should accept secret from headers', async () => { ... })`
  - [ ] Create test: `it('should accept secret from query string', async () => { ... })`
- [ ] Step 2: Write tests for requestId validation
  - [ ] Create test: `it('should return 400 when requestId is missing', async () => { ... })`
  - [ ] Create test: `it('should accept requestId from body', async () => { ... })`
  - [ ] Create test: `it('should accept request_id from body', async () => { ... })`
- [ ] Step 3: Write test for happy path
  - [ ] Create test: `it('should process callback successfully', async () => { ... })`
    - [ ] Arrange: Valid secret, requestId, mock `handleCallback` to resolve
    - [ ] Act: POST `/task-operator/callback` with body
    - [ ] Assert: 200, `{ received: true, requestId }`
- [ ] Step 4: Write test for internal error
  - [ ] Create test: `it('should return 200 with error when handleCallback throws', async () => { ... })`
    - [ ] Arrange: `handleCallback` throws
    - [ ] Act: POST `/task-operator/callback`
    - [ ] Assert: 200, `{ received: true, error: 'Internal error processing callback' }`, error logged

### Specific Requirements

- [ ] Requirement 1: Test must verify secret authentication
  - Acceptance: 401 returned for missing/incorrect secrets, accepts from headers/query
- [ ] Requirement 2: Test must verify requestId validation
  - Acceptance: 400 returned when missing, accepts requestId or request_id
- [ ] Requirement 3: Test must verify successful processing
  - Acceptance: 200 returned with received: true
- [ ] Requirement 4: Test must verify error handling
  - Acceptance: 200 returned with error in body (not 500), error logged

### Error Handling and Edge Cases

- [ ] Handle case where both requestId and request_id are present
- [ ] Handle case where secret is in both headers and query
- [ ] Verify error logging occurs
- [ ] Test with various callback data structures

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining callback endpoint
- [ ] Document secret validation approach
- [ ] Note requestId field name flexibility

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify authentication works
- [ ] Verify validation works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-044 (completes Phase 5)
- **Dependencies**: 
  - TASK-044: Add tests for /task-operator/lock endpoints
- **Important Considerations**: 
  - Webhook secret provides security for callback endpoint
  - Secret can be in headers (`X-Webhook-Secret` or similar) or query string (`?secret=...`)
  - requestId field name flexibility (requestId vs request_id) provides compatibility
  - Internal errors return 200 with error in body (not 500) to prevent retries
  - Error logging is important for debugging
- **Task Independence**: Can be completed independently after TASK-044
- **Current State**: Test file exists but may not have comprehensive callback endpoint tests

## Related Tasks

- Previous: TASK-044 (Add tests for /task-operator/lock endpoints)
- Next: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions) - Starts Phase 6
- Dependencies:
  - TASK-044: Add tests for /task-operator/lock endpoints
- Related:
  - TASK-024, TASK-025: Tested handleCallback in unit tests
  - TASK-046: Will start MCP server tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding comprehensive test cases for the `/task-operator/callback` endpoint.

**Definition of Done**: "Test cases are added that verify `/task-operator/callback` correctly handles secret authentication, requestId validation, successful callback processing, and error handling. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify secret authentication works so that callbacks are secure.
   - **Acceptance Criteria**: 
     - Test verifies 401 for missing/incorrect secrets
     - Test verifies secrets from headers/query are accepted
     - Test passes consistently

2. **As a developer**, I want to verify requestId validation works so that callbacks are properly identified.
   - **Acceptance Criteria**:
     - Test verifies 400 when requestId is missing
     - Test verifies requestId or request_id are accepted

3. **As a developer**, I want to verify callback processing works so that task results are handled correctly.
   - **Acceptance Criteria**:
     - Test verifies successful callbacks return 200
     - Test verifies errors are handled gracefully (200 with error, not 500)

### Automated Tests

Test cases should include:

```typescript
describe('POST /task-operator/callback', () => {
  beforeEach(() => {
    process.env.WEBHOOK_SECRET = 'test-secret';
  });
  
  afterEach(() => {
    delete process.env.WEBHOOK_SECRET;
  });
  
  it('should return 401 when secret is missing', async () => {
    // Arrange: No secret in headers or query
    // Act: POST /task-operator/callback
    // Assert: 401, "Unauthorized"
  });
  
  it('should return 401 when secret is incorrect', async () => {
    // Arrange: Wrong secret
    // Act & Assert: 401
  });
  
  it('should accept secret from headers', async () => {
    // Arrange: Secret in X-Webhook-Secret header
    // Act & Assert: Proceeds to requestId checks
  });
  
  it('should return 400 when requestId is missing', async () => {
    // Arrange: Valid secret, no requestId
    // Act & Assert: 400, "requestId is required"
  });
  
  it('should process callback successfully', async () => {
    // Arrange: Valid secret, requestId, handleCallback resolves
    mockTaskOperatorService.handleCallback.mockResolvedValue(undefined);
    
    // Act
    const response = await request(app.getApp())
      .post('/task-operator/callback')
      .set('X-Webhook-Secret', 'test-secret')
      .send({ requestId: 'req-123', success: true })
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      received: true,
      requestId: 'req-123',
    });
  });
  
  it('should return 200 with error when handleCallback throws', async () => {
    // Arrange: handleCallback throws
    // Act & Assert: 200, { received: true, error: 'Internal error...' }, error logged
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify secret authentication
- [ ] Tests verify requestId validation
- [ ] Tests verify callback processing

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator/callback endpoint comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify authentication
- [ ] Tests verify validation
- [ ] Tests verify callback processing
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 5 (HTTP/API Black-box Tests) is complete**
