# TASK-032: Add tests for getAgentStatus and findAgentQueue

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.5
**Task ID**: TASK-032

**NOTE**: This task has been split into granular subtasks:
- **TASK-032.1**: Test getAgentStatus - agent not found
- **TASK-032.2**: Test getAgentStatus - agent found with complete status
- **TASK-032.3**: Test getAgentStatus - job name matching
- **TASK-032.4**: Test getAgentStatus - agentName in data matching
- **TASK-032.5**: Test findAgentQueue helper method

Please execute the subtasks (32.1, 32.2, 32.3, 32.4, 32.5) instead of this parent task.

## Description

Add test cases for the `getAgentStatus` and `findAgentQueue` methods to verify they correctly locate agents across queues and return comprehensive status information. The tests should verify queue discovery, job matching (by name or agentName in data), and status object construction with all required fields.

**This task has been split into subtasks - see TASK-032.1 through TASK-032.5**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `getAgentStatus()` and `findAgentQueue()` methods
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `getAgentStatus` method:
- Searches across all queues for an agent by name
- Looks for repeatable jobs with keys matching `agent:{name}`
- Looks for waiting/active/completed jobs with `job.name` or `job.data.agentName` matching
- Returns `AgentStatus` object with queue name, targetUrl, method, headers, body, timeout, schedule, isActive, lastRun, nextRun
- Returns `null` if agent not found

The `findAgentQueue` method:
- Helper method that finds which queue contains the agent
- Used by `getAgentStatus`

The test file `tests/queue/queue-manager.test.ts` exists but may not have comprehensive tests for these methods.

**Important**: This task should be executed after TASK-031.

## Checklist

### Preparation and Setup

- [ ] Review `getAgentStatus` and `findAgentQueue` implementations
- [ ] Understand agent matching logic (name vs agentName in data)
- [ ] Review `AgentStatus` interface structure
- [ ] Understand repeatable job pattern matching

### Implementation Steps

- [ ] Step 1: Write test for agent not found
  - [ ] Create test: `it('should return null when agent is not found', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock queues with no matching jobs
  - [ ] Act: Call `getAgentStatus('non-existent-agent')`
  - [ ] Assert: Returns `null`
- [ ] Step 2: Write test for agent found with complete status
  - [ ] Create test: `it('should return complete AgentStatus when agent is found', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock queues with matching jobs:
      - [ ] Repeatable job with key matching `agent:test`
      - [ ] Recent job with `job.name === 'agent:test'` or `job.data.agentName === 'test'`
    - [ ] Mock job data with targetUrl, method, headers, body, timeout
    - [ ] Mock repeatable job with schedule pattern
  - [ ] Act: Call `getAgentStatus('test')`
  - [ ] Assert: 
    - [ ] Returns `AgentStatus` object
    - [ ] Contains queue name
    - [ ] Contains targetUrl, method, headers, body, timeout from recent job
    - [ ] Contains schedule from repeatable job
    - [ ] Contains isActive, lastRun, nextRun
- [ ] Step 3: Write test for job name matching
  - [ ] Create test: `it('should find agent by job name', async () => { ... })`
  - [ ] Arrange: Job with `name === 'agent:test'`
  - [ ] Act: Call `getAgentStatus('test')`
  - [ ] Assert: Agent found
- [ ] Step 4: Write test for agentName in data matching
  - [ ] Create test: `it('should find agent by agentName in job data', async () => { ... })`
  - [ ] Arrange: Job with `data.agentName === 'test'`
  - [ ] Act: Call `getAgentStatus('test')`
  - [ ] Assert: Agent found

### Specific Requirements

- [ ] Requirement 1: Test must verify agent discovery
  - Acceptance: Agent is found across queues correctly
- [ ] Requirement 2: Test must verify status object completeness
  - Acceptance: All required fields are present in status
- [ ] Requirement 3: Test must verify job matching
  - Acceptance: Both job.name and job.data.agentName are checked
- [ ] Requirement 4: Test must verify not found case
  - Acceptance: Returns `null` when agent doesn't exist

### Error Handling and Edge Cases

- [ ] Handle case where queue methods throw errors
- [ ] Handle case where job data is incomplete
- [ ] Verify schedule extraction from repeatable jobs
- [ ] Test with various job states (waiting, active, completed)

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining agent discovery logic
- [ ] Document job matching strategies
- [ ] Note status object field sources

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify agent discovery works
- [ ] Verify status object construction works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-031
- **Dependencies**: 
  - TASK-031: Add tests for addDelayedAgent
- **Important Considerations**: 
  - Agent discovery searches across all queues
  - Job matching uses both name and agentName for flexibility
  - Status object aggregates data from multiple sources (recent job + repeatable job)
  - Schedule comes from repeatable job pattern
  - isActive, lastRun, nextRun require job state analysis
- **Task Independence**: Can be completed independently after TASK-031
- **Current State**: Test file exists but may not have comprehensive getAgentStatus tests

## Related Tasks

- Previous: TASK-031 (Add tests for addDelayedAgent)
- Next: TASK-033 (Add tests for removeAgent and checkAndCleanupEmptyQueue)
- Dependencies:
  - TASK-031: Add tests for addDelayedAgent
- Related:
  - TASK-033 through TASK-034: Will add more QueueManager tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `getAgentStatus` and `findAgentQueue` methods.

**Definition of Done**: "Test cases are added that verify `getAgentStatus` correctly discovers agents across queues, matches jobs by name or agentName, and returns complete status objects. Tests verify `findAgentQueue` helper method. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent discovery works so that agent status can be retrieved.
   - **Acceptance Criteria**: 
     - Test verifies agent is found across queues
     - Test verifies status object is complete
     - Test passes consistently

2. **As a developer**, I want to verify job matching works so that agents can be found by various identifiers.
   - **Acceptance Criteria**:
     - Test verifies job.name matching works
     - Test verifies job.data.agentName matching works
     - Test verifies not found case returns null

### Automated Tests

Test cases should include:

```typescript
describe('getAgentStatus', () => {
  it('should return null when agent is not found', async () => {
    // Arrange: No matching jobs
    // Act: getAgentStatus('non-existent')
    // Assert: Returns null
  });
  
  it('should return complete AgentStatus when agent is found', async () => {
    // Arrange: Mock queues with matching jobs
    const mockQueues = [
      {
        name: 'queue1',
        getRepeatableJobs: jest.fn().mockResolvedValue([
          { key: 'agent:test::*::*', pattern: '0 * * * *' },
        ]),
        getWaiting: jest.fn().mockResolvedValue([
          { id: '1', name: 'agent:test', data: { agentName: 'test', targetUrl: 'http://example.com' } },
        ]),
      },
    ];
    // Act: getAgentStatus('test')
    // Assert: Returns complete status object
  });
  
  it('should find agent by job name', async () => {
    // Arrange: Job with name === 'agent:test'
    // Act & Assert: Agent found
  });
  
  it('should find agent by agentName in job data', async () => {
    // Arrange: Job with data.agentName === 'test'
    // Act & Assert: Agent found
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify agent discovery
- [ ] Tests verify status object completeness
- [ ] Tests verify job matching strategies

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getAgentStatus and findAgentQueue comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify agent discovery
- [ ] Tests verify status object construction
- [ ] Tests verify job matching
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
