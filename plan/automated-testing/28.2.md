# TASK-028.2: Test Redis scan discovery - error handling

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.1.2
**Task ID**: TASK-028.2

## Description

Add a test case for the `initialize()` method to verify it correctly handles errors when individual queue recreation fails, continuing to process other queues without aborting. The test should verify error logging and that other queues are still created successfully.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `initialize()` method error handling
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `QueueManager.initialize()` method:
- Should handle errors when recreating specific queues without aborting others

The test file `tests/queue/queue-manager.test.ts` exists with previous tests including TASK-028.1.

**Important**: This task should be executed after TASK-028.1, completing TASK-028.

## Checklist

### Preparation and Setup

- [ ] Review `QueueManager.initialize()` error handling implementation
- [ ] Understand how errors are logged
- [ ] Review test setup from TASK-028.1

### Implementation Steps

- [ ] Step 1: Write test for error handling
  - [ ] Create test: `it('should continue processing when individual queue recreation fails', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock Redis `scan` to return multiple queue keys
    - [ ] Make `queueFactory` throw for one queue but succeed for others
  - [ ] Act: Call `queueManager.initialize()`
  - [ ] Assert: 
    - [ ] Error is logged for failed queue
    - [ ] Other queues are still created successfully
    - [ ] Process doesn't abort

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: Errors in one queue don't abort processing of others
- [ ] Requirement 2: Test must verify error logging
  - Acceptance: Errors are logged appropriately

### Error Handling and Edge Cases

- [ ] Test with various error types
- [ ] Verify all queues are attempted even if some fail
- [ ] Test with multiple failures

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling behavior
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-028.1 (completes TASK-028)
- **Dependencies**: 
  - TASK-028.1: Test Redis scan discovery - successful queue discovery
- **Important Considerations**: 
  - Error handling is critical for resilience
  - This is the second and final subtask for TASK-028
- **Task Independence**: Can be completed independently after TASK-028.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-028 (Extend queue-manager.test.ts for Redis scan discovery)
- Previous: TASK-028.1 (Test Redis scan discovery - successful queue discovery)
- Next: TASK-029 (Add tests for getOrCreateQueue)
- Dependencies:
  - TASK-028.1: Test Redis scan discovery - successful queue discovery
- Related:
  - TASK-028.1: Other subtask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for Redis scan-based queue discovery error handling.

**Definition of Done**: "A test case is written that verifies `initialize()` correctly handles errors when individual queue recreation fails, continuing to process other queues and logging errors appropriately. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that one failed queue doesn't break others.
   - **Acceptance Criteria**:
     - Test verifies errors are handled gracefully
     - Test verifies other queues are still created
     - Test verifies process doesn't abort

### Automated Tests

The test case should be:

```typescript
describe('initialize - Redis scan discovery', () => {
  it('should continue processing when individual queue recreation fails', async () => {
    // Arrange: One queue fails, others succeed
    // Act: initialize()
    // Assert: Error logged, other queues created
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add Redis scan discovery error handling test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-028 (all subtasks) is complete**

