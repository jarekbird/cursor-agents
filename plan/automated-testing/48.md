# TASK-048: Add tests for MCP resources (agents)

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.3
**Task ID**: TASK-048

**NOTE**: This task has been split into granular subtasks:
- **TASK-048.1**: Add tests for MCP resources - resource listing
- **TASK-048.2**: Add tests for MCP resources - resource reading

Please execute the subtasks (48.1, 48.2) instead of this parent task.

## Description

Add test cases for MCP resources functionality, specifically agent resources. The tests should verify resource listing (returns URIs in form `agent://{name}`) and resource reading (returns agent status JSON or throws for non-existent agents).

**This task has been split into subtasks - see TASK-048.1 and TASK-048.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - MCP resource handlers
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The MCP server implements resources:
- Resource listing: Returns list of agent URIs (`agent://{name}`)
- Resource reading: Returns agent status JSON for `agent://{name}` URI

The test file `tests/mcp/server.test.ts` exists but may not have comprehensive resource tests.

**Important**: This task should be executed after TASK-047.

## Checklist

### Preparation and Setup

- [ ] Review MCP resource handler implementations
- [ ] Understand resource URI format (`agent://{name}`)
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand resource list and read handlers

### Implementation Steps

- [ ] Step 1: Write test for resource listing
  - [ ] Create test: `it('should list agent resources with correct URIs', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `listQueues` to return queue names
      - [ ] Set up resource list handler access (may need test-only access)
    - [ ] Act: Invoke resource list handler
    - [ ] Assert: 
      - [ ] URIs are of form `agent://{name}`
      - [ ] `resourceCount` equals number of queues
      - [ ] All queue names are represented
- [ ] Step 2: Write test for resource reading (existing agent)
  - [ ] Create test: `it('should return agent status JSON for existing agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `getAgentStatus` to return status object
      - [ ] URI: `agent://test-agent`
    - [ ] Act: Invoke resource read handler with URI
    - [ ] Assert: 
      - [ ] Returns `contents[0].text` as JSON
      - [ ] JSON represents agent status
      - [ ] All status fields are present
- [ ] Step 3: Write test for resource reading (non-existent agent)
  - [ ] Create test: `it('should throw error for non-existent agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `getAgentStatus` to return `null`
      - [ ] URI: `agent://non-existent`
    - [ ] Act: Invoke resource read handler with URI
    - [ ] Assert: 
      - [ ] Handler throws error
      - [ ] Error message: `"Agent \"non-existent\" not found"`

### Specific Requirements

- [ ] Requirement 1: Test must verify resource listing
  - Acceptance: URIs are correct format, resourceCount is correct
- [ ] Requirement 2: Test must verify resource reading (existing)
  - Acceptance: Returns agent status JSON correctly
- [ ] Requirement 3: Test must verify resource reading (non-existent)
  - Acceptance: Throws error with descriptive message
- [ ] Requirement 4: Test must verify URI format
  - Acceptance: URIs follow `agent://{name}` pattern

### Error Handling and Edge Cases

- [ ] Handle case where no agents exist (empty list)
- [ ] Handle case where agent name contains special characters
- [ ] Verify URI parsing works correctly
- [ ] Test with various agent states

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining resource functionality
- [ ] Document URI format
- [ ] Note resource handler access patterns

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify resource listing works
- [ ] Verify resource reading works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-047
- **Dependencies**: 
  - TASK-047: Add tests for queue-related MCP tools
- **Important Considerations**: 
  - MCP resources provide structured access to agents
  - URI format `agent://{name}` is standard MCP pattern
  - Resource listing discovers available agents
  - Resource reading provides detailed agent information
  - May need test-only access to resource handlers or thin wrapper
- **Task Independence**: Can be completed independently after TASK-047
- **Current State**: Test file exists but may not have comprehensive resource tests

## Related Tasks

- Previous: TASK-047 (Add tests for queue-related MCP tools)
- Next: TASK-049 (Add logging expectation tests)
- Dependencies:
  - TASK-047: Add tests for queue-related MCP tools
- Related:
  - TASK-049: Will test logging behavior

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for MCP agent resources.

**Definition of Done**: "Test cases are added that verify MCP resource listing returns correct URIs and resource reading returns agent status JSON or throws for non-existent agents. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify resource listing works so that MCP clients can discover agents.
   - **Acceptance Criteria**: 
     - Test verifies URIs are in correct format
     - Test verifies resourceCount is correct
     - Test passes consistently

2. **As a developer**, I want to verify resource reading works so that MCP clients can get agent details.
   - **Acceptance Criteria**:
     - Test verifies existing agents return status JSON
     - Test verifies non-existent agents throw errors

### Automated Tests

Test cases should include:

```typescript
describe('MCP resources (agents)', () => {
  it('should list agent resources with correct URIs', async () => {
    // Arrange: Mock listQueues
    mockQueueManager.listQueues.mockReturnValue(['q1', 'q2', 'q3']);
    
    // Act: Invoke resource list handler
    const resources = await resourceListHandler();
    
    // Assert
    expect(resources.resourceCount).toBe(3);
    resources.resources.forEach(resource => {
      expect(resource.uri).toMatch(/^agent:\/\//);
      expect(resource.uri).toBe(`agent://${resource.name}`);
    });
  });
  
  it('should return agent status JSON for existing agent', async () => {
    // Arrange: getAgentStatus returns status
    const status = { name: 'test', isActive: true, targetUrl: 'http://example.com' };
    mockQueueManager.getAgentStatus.mockReturnValue(status);
    
    // Act: Invoke resource read handler
    const content = await resourceReadHandler('agent://test');
    
    // Assert
    const json = JSON.parse(content.contents[0].text);
    expect(json).toEqual(status);
  });
  
  it('should throw error for non-existent agent', async () => {
    // Arrange: getAgentStatus returns null
    // Act & Assert: Throws "Agent \"non-existent\" not found"
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify resource listing
- [ ] Tests verify resource reading
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add MCP agent resources tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify resource listing
- [ ] Tests verify resource reading
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
