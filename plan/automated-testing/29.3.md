# TASK-029.3: Test getOrCreateQueue - existing queue

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.2.3
**Task ID**: TASK-029.3

## Description

Add a test case for the `getOrCreateQueue` method to verify it correctly returns existing queues without creating duplicates. The test should verify that when a queue already exists, the same instance is returned and no duplicate workers or events are created.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `getOrCreateQueue()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `getOrCreateQueue` method:
- Checks if queue already exists in internal map
- Returns existing queue if already created
- Prevents duplicate workers/events for same queue

The test file `tests/queue/queue-manager.test.ts` exists with previous tests including TASK-029.1 and TASK-029.2.

**Important**: This task should be executed after TASK-029.2, completing TASK-029.

## Checklist

### Preparation and Setup

- [ ] Review `getOrCreateQueue` duplicate prevention logic
- [ ] Understand how existing queues are tracked
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for existing queue
  - [ ] Create test: `it('should return existing queue without creating duplicates', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Create queue first via `getOrCreateQueue('existing-queue')`
    - [ ] Clear factory spies
  - [ ] Act: Call `getOrCreateQueue('existing-queue')` again
  - [ ] Assert: 
    - [ ] Same queue instance returned
    - [ ] Factories not called again (no duplicates)
    - [ ] No new workers or events created

### Specific Requirements

- [ ] Requirement 1: Test must verify no duplicates
  - Acceptance: Existing queues don't create duplicate workers/events
- [ ] Requirement 2: Test must verify return value
  - Acceptance: Same queue instance is returned

### Error Handling and Edge Cases

- [ ] Verify queue instances are reused correctly
- [ ] Test with various queue names

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining duplicate prevention logic
- [ ] Note that queue instances should be reused

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify duplicate prevention works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-029.2 (completes TASK-029)
- **Dependencies**: 
  - TASK-029.2: Test getOrCreateQueue - task-operator queue
- **Important Considerations**: 
  - Duplicate prevention is critical for resource management
  - Queue instances should be reused, not recreated
  - This is the third and final subtask for TASK-029
- **Task Independence**: Can be completed independently after TASK-029.2
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-029 (Add tests for getOrCreateQueue)
- Previous: TASK-029.2 (Test getOrCreateQueue - task-operator queue)
- Next: TASK-030 (Add tests for hasExistingJobs)
- Dependencies:
  - TASK-029.2: Test getOrCreateQueue - task-operator queue
- Related:
  - TASK-029.1, TASK-029.2: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `getOrCreateQueue` when queue already exists.

**Definition of Done**: "A test case is written that verifies `getOrCreateQueue` correctly returns existing queues without creating duplicate workers or events. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify duplicate prevention works so that resources aren't wasted.
   - **Acceptance Criteria**:
     - Test verifies existing queues don't create duplicates
     - Test verifies same instance is returned

### Automated Tests

The test case should be:

```typescript
describe('getOrCreateQueue', () => {
  it('should return existing queue without creating duplicates', async () => {
    // Arrange: Create queue first
    const queue1 = await queueManager.getOrCreateQueue('existing-queue');
    const queueFactorySpy = jest.spyOn(queueManager, 'queueFactory');
    queueFactorySpy.mockClear();
    
    // Act: Call getOrCreateQueue again
    const queue2 = await queueManager.getOrCreateQueue('existing-queue');
    
    // Assert
    expect(queue2).toBe(queue1); // Same instance
    expect(queueFactorySpy).not.toHaveBeenCalled(); // No duplicates
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify duplicate prevention

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getOrCreateQueue existing queue test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify duplicate prevention
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-029 (all subtasks) is complete**

