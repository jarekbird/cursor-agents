# TASK-046.1: Enhance MCP tests - create_agent JSON structure assertions

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.1.1
**Task ID**: TASK-046.1

## Description

Enhance the existing test for the `create_agent` MCP tool to add comprehensive JSON payload assertions. The test should verify that `content[0].text` is valid JSON and assert the exact structure (keys, types, and important messages) for the create_agent tool.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - `create_agent` tool handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The `create_agent` MCP tool:
- Creates one-time or recurring agents
- Returns MCP response with `content[0].text` containing JSON
- JSON should contain: `success`, `agentName`, `jobId` (or similar)

The test file `tests/mcp/server.test.ts` already exists with some tests but may not have comprehensive JSON structure assertions for create_agent.

**Important**: This task should be executed after Phase 5 (TASK-038 through TASK-045). This is the first subtask of TASK-046.

## Checklist

### Preparation and Setup

- [ ] Review `create_agent` tool handler implementation
- [ ] Understand MCP response format (`content[0].text` as JSON)
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand expected JSON structure for create_agent

### Implementation Steps

- [ ] Step 1: Enhance existing create_agent test with JSON assertions
  - [ ] Find existing test for create_agent
  - [ ] Add JSON parsing: `const content = JSON.parse(response.content[0].text)`
  - [ ] Assert JSON contains: `success`, `agentName`, `jobId` (or similar)
  - [ ] Assert types are correct (e.g., `typeof content.agentName === 'string'`)
  - [ ] Assert error structure when creation fails

### Specific Requirements

- [ ] Requirement 1: Test must verify JSON is valid
  - Acceptance: `content[0].text` parses as valid JSON
- [ ] Requirement 2: Test must verify structure
  - Acceptance: All required keys are present with correct types
- [ ] Requirement 3: Test must verify important messages
  - Acceptance: Success/error messages are correct

### Error Handling and Edge Cases

- [ ] Handle case where JSON is malformed (shouldn't happen but test edge case)
- [ ] Verify error JSON structures are consistent
- [ ] Test with various agent configurations

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining JSON structure assertions
- [ ] Document expected JSON schema for create_agent

### Verification

- [ ] Verify test passes consistently
- [ ] Verify JSON parsing works
- [ ] Verify structure assertions work
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after Phase 5 (TASK-038 through TASK-045)
- **Dependencies**: 
  - TASK-038 through TASK-045: Phase 5 HTTP/API tests
- **Important Considerations**: 
  - JSON structure assertions ensure MCP clients receive expected data
  - Type assertions prevent regressions
  - This is the first of 7 subtasks for TASK-046
- **Task Independence**: Can be completed independently after Phase 5
- **Current State**: Test file exists but may not have comprehensive JSON structure assertions

## Related Tasks

- Parent: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions)
- Next: TASK-046.2 (Enhance MCP tests - list_agents JSON structure assertions)
- Dependencies:
  - TASK-038 through TASK-045: Phase 5 tests
- Related:
  - TASK-046.2 through TASK-046.7: Other subtasks for MCP tools

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves enhancing the create_agent MCP tool test with JSON structure assertions.

**Definition of Done**: "The create_agent MCP tool test is enhanced with JSON parsing and structure assertions. Test verifies exact JSON structure (keys, types, messages). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify JSON structure is correct so that MCP clients receive expected data.
   - **Acceptance Criteria**: 
     - Test verifies JSON is valid
     - Test verifies all required keys are present
     - Test verifies types are correct

### Automated Tests

Test enhancements should include:

```typescript
describe('create_agent MCP tool', () => {
  it('should return valid JSON with correct structure', async () => {
    // Arrange: Mock successful agent creation
    // Act: Call create_agent tool
    // Assert
    const response = await toolHandler(...);
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('success', true);
    expect(content).toHaveProperty('agentName', expect.any(String));
    expect(content).toHaveProperty('jobId', expect.any(String));
    expect(typeof content.agentName).toBe('string');
  });
});
```

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure

### Git Commit and Push Requirements

- [ ] Test enhancements added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance create_agent MCP tool with JSON structure assertions")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test enhancements

### Final Checklist

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

