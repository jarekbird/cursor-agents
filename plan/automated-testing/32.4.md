# TASK-032.4: Test getAgentStatus - agentName in data matching

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.5.4
**Task ID**: TASK-032.4

## Description

Add a test case for the `getAgentStatus` method to verify it correctly finds agents by matching `job.data.agentName` against the agent name. This verifies the alternative job matching strategy.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `getAgentStatus()` method

## Current State

The `getAgentStatus` method:
- Matches jobs by `job.data.agentName === '{name}'` as an alternative to job name matching
- Uses this as a fallback strategy to find agents

The test file `tests/queue/queue-manager.test.ts` exists with previous tests including TASK-032.1, TASK-032.2, and TASK-032.3.

**Important**: This task should be executed after TASK-032.3.

## Checklist

### Preparation and Setup

- [ ] Review `getAgentStatus` agentName matching implementation
- [ ] Understand agentName in job data structure
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for agentName in data matching
  - [ ] Create test: `it('should find agent by agentName in job data', async () => { ... })`
  - [ ] Arrange: Job with `data.agentName === 'test'`
  - [ ] Act: Call `getAgentStatus('test')`
  - [ ] Assert: Agent found

### Specific Requirements

- [ ] Requirement 1: Test must verify agentName matching
  - Acceptance: Jobs with `data.agentName === '{name}'` are matched
- [ ] Requirement 2: Test must verify data structure
  - Acceptance: agentName is correctly extracted from job data

### Error Handling and Edge Cases

- [ ] Handle case where job data doesn't have agentName
- [ ] Verify case sensitivity (if applicable)
- [ ] Test with various data structures

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining agentName matching
- [ ] Document job data structure

### Verification

- [ ] Verify test passes consistently
- [ ] Verify agentName matching works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-032.3
- **Dependencies**: 
  - TASK-031: Add tests for addDelayedAgent
  - TASK-032.3: Test getAgentStatus - job name matching
- **Important Considerations**: 
  - agentName matching uses `job.data.agentName`
  - This is an alternative to job name matching
  - This is the fourth of 5 subtasks for TASK-032
- **Task Independence**: Can be completed independently after TASK-032.3
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-032 (Add tests for getAgentStatus and findAgentQueue)
- Previous: TASK-032.3 (Test getAgentStatus - job name matching)
- Next: TASK-032.5 (Test findAgentQueue helper method)
- Dependencies:
  - TASK-032.3: Test getAgentStatus - job name matching
- Related:
  - TASK-032.1, TASK-032.2, TASK-032.3, TASK-032.5: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `getAgentStatus` agentName in data matching.

**Definition of Done**: "A test case is written that verifies `getAgentStatus` correctly finds agents by matching `job.data.agentName` against the agent name. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agentName matching works so that agents can be found by agentName in job data.
   - **Acceptance Criteria**: 
     - Test verifies jobs with `data.agentName === '{name}'` are matched
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('getAgentStatus', () => {
  it('should find agent by agentName in job data', async () => {
    // Arrange: Job with data.agentName === 'test'
    const mockQueues = [{
      getWaiting: jest.fn().mockResolvedValue([
        { id: '1', name: 'other-name', data: { agentName: 'test' } },
      ]),
    }];
    // Act: getAgentStatus('test')
    // Assert: Agent found
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies agentName matching

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getAgentStatus agentName matching test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies agentName matching
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

