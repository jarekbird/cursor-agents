# TASK-039: Add tests for /admin/queues/refresh

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.2
**Task ID**: TASK-039

**NOTE**: This task has been split into granular subtasks:
- **TASK-039.1**: Test /admin/queues/refresh - successful refresh
- **TASK-039.2**: Test /admin/queues/refresh - error handling

Please execute the subtasks (39.1, 39.2) instead of this parent task.

## Description

Add test cases for the `/admin/queues/refresh` endpoint to verify it correctly refreshes the Bull Board dashboard. The tests should verify the happy path (successful refresh with queue count) and error path (failed refresh with error response).

**This task has been split into subtasks - see TASK-039.1 and TASK-039.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/admin/queues/refresh` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/admin/queues/refresh` endpoint:
- Accepts POST requests
- Calls internal `updateBullBoard()` method (or refreshes via `queueManager.getQueues()`)
- Returns JSON: `{ success: true, queueCount: <number> }` on success
- Returns JSON: `{ error: 'Failed to refresh Bull Board' }` with status 500 on error

The test file `tests/app.test.ts` exists but may not have `/admin/queues/refresh` tests.

**Important**: This task should be executed after TASK-038.

## Checklist

### Preparation and Setup

- [ ] Review `/admin/queues/refresh` endpoint implementation
- [ ] Understand `updateBullBoard()` or queue refresh mechanism
- [ ] Review existing `app.test.ts` structure
- [ ] Understand how to spy on internal methods

### Implementation Steps

- [ ] Step 1: Write test for happy path
  - [ ] Create test: `it('should refresh Bull Board and return queue count', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Create app instance
    - [ ] Spy on `updateBullBoard` or instrument via `queueManager.getQueues()`
    - [ ] Mock queue manager to return queues
  - [ ] Act: POST to `/admin/queues/refresh` using `supertest`
  - [ ] Assert: 
    - [ ] Response status is 200
    - [ ] Response body is `{ success: true, queueCount: <number> }`
    - [ ] `updateBullBoard` or refresh method was called
- [ ] Step 2: Write test for error path
  - [ ] Create test: `it('should return 500 when refresh fails', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Force `updateBullBoard` to throw (via mock or temporary modification)
  - [ ] Act: POST to `/admin/queues/refresh`
  - [ ] Assert: 
    - [ ] Response status is 500
    - [ ] Response body is `{ error: 'Failed to refresh Bull Board' }`

### Specific Requirements

- [ ] Requirement 1: Test must verify successful refresh
  - Acceptance: Returns success with queue count
- [ ] Requirement 2: Test must verify error handling
  - Acceptance: Returns 500 with error message on failure
- [ ] Requirement 3: Test must verify endpoint method
  - Acceptance: Endpoint accepts POST requests
- [ ] Requirement 4: Test must verify queue count
  - Acceptance: Queue count reflects actual number of queues

### Error Handling and Edge Cases

- [ ] Handle case where no queues exist (queueCount = 0)
- [ ] Handle case where queue manager is unavailable
- [ ] Verify error message is descriptive
- [ ] Test with various queue counts

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining refresh endpoint
- [ ] Document queue count calculation
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify refresh works correctly
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-038
- **Dependencies**: 
  - TASK-038: Extend app.test.ts for Bull Board base path
- **Important Considerations**: 
  - Refresh endpoint allows manual dashboard updates
  - Queue count provides visibility into system state
  - Error handling ensures graceful failure
  - May need to spy on internal methods or use dependency injection
- **Task Independence**: Can be completed independently after TASK-038
- **Current State**: Test file exists but may not have refresh endpoint tests

## Related Tasks

- Previous: TASK-038 (Extend app.test.ts for Bull Board base path)
- Next: TASK-040 (Add tests for /queues/:queueName)
- Dependencies:
  - TASK-038: Extend app.test.ts for Bull Board base path
- Related:
  - TASK-040 through TASK-045: Will add more HTTP/API tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `/admin/queues/refresh` endpoint.

**Definition of Done**: "Test cases are added that verify `/admin/queues/refresh` correctly refreshes Bull Board dashboard, returns success with queue count, and handles errors gracefully. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify refresh endpoint works so that Bull Board can be manually refreshed.
   - **Acceptance Criteria**: 
     - Test verifies refresh returns success with queue count
     - Test verifies refresh method is called
     - Test passes consistently

2. **As a developer**, I want to verify error handling works so that failures are handled gracefully.
   - **Acceptance Criteria**:
     - Test verifies 500 error is returned on failure
     - Test verifies error message is descriptive

### Automated Tests

Test cases should include:

```typescript
describe('POST /admin/queues/refresh', () => {
  it('should refresh Bull Board and return queue count', async () => {
    // Arrange: Mock queue manager, spy on updateBullBoard
    const app = new CursorAgentsApp();
    const updateBullBoardSpy = jest.spyOn(app, 'updateBullBoard');
    // Or spy on queueManager.getQueues()
    
    // Act
    const response = await request(app.getApp())
      .post('/admin/queues/refresh')
      .expect(200);
    
    // Assert
    expect(response.body).toEqual({
      success: true,
      queueCount: expect.any(Number),
    });
    expect(updateBullBoardSpy).toHaveBeenCalled();
  });
  
  it('should return 500 when refresh fails', async () => {
    // Arrange: Force updateBullBoard to throw
    // Act: POST /admin/queues/refresh
    // Assert: 500, error message
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify successful refresh
- [ ] Tests verify error handling
- [ ] Tests verify queue count

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /admin/queues/refresh endpoint tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify refresh functionality
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
