# TASK-051: Add task-operator lifecycle integration test

**Section**: 7. Integration & E2E-lite Scenarios
**Subsection**: 7.2
**Task ID**: TASK-051

## Description

Add a comprehensive integration test for the task-operator lifecycle. The test should use fakes/mocks for SQLite and Redis but keep `TaskOperatorService` real where possible, and verify the complete flow: insert task, enable task operator, trigger job, simulate callback, verify completion.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - TaskOperatorService
- `virtual-assistant/cursor-agents/src/app.ts` - task-operator endpoints
- `virtual-assistant/cursor-agents/tests/integration.test.ts` - existing test structure

## Current State

The task-operator lifecycle involves:
- Tasks stored in SQLite database
- Task operator enabled via system setting
- Task operator job enqueued via `/task-operator` endpoint
- Task processed by TaskOperatorService
- Callback received from cursor-runner via `/task-operator/callback`
- Task marked complete, lock released

The test file `tests/integration.test.ts` exists but may not have comprehensive task-operator lifecycle test.

**Important**: This task should be executed after TASK-050.

## Checklist

### Preparation and Setup

- [ ] Review task-operator lifecycle flow
- [ ] Understand how to create fake SQLite database
- [ ] Understand how to mock Redis for TaskOperatorService
- [ ] Review existing `integration.test.ts` structure
- [ ] Understand callback simulation

### Implementation Steps

- [ ] Step 1: Set up fake database and Redis
  - [ ] Create fake SQLite database with tasks table
  - [ ] Insert one ready task (status = 0)
  - [ ] Mock Redis for TaskOperatorService
  - [ ] Mock fetch for cursor-runner API calls
- [ ] Step 2: Write comprehensive lifecycle test
  - [ ] Create test: `it('should handle complete task-operator lifecycle', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Fake database with ready task
    - [ ] Mock Redis
    - [ ] Mock fetch for conversation creation and async iterate
    - [ ] Create app instance with fake database
  - [ ] Act & Assert Steps:
    - [ ] Step 1: Enable task operator via POST `/task-operator`
      - [ ] Assert: 200, task operator enabled
    - [ ] Step 2: Trigger task-operator job (may happen automatically or via endpoint)
      - [ ] Assert: Job is enqueued
    - [ ] Step 3: Simulate task processing (mock fetch responses)
      - [ ] Assert: Task status updated to IN_PROGRESS
    - [ ] Step 4: Simulate callback via POST `/task-operator/callback`
      - [ ] Assert: 200, callback received
    - [ ] Step 5: Verify task completion
      - [ ] Assert: Task status is COMPLETE
      - [ ] Assert: Lock is released

### Specific Requirements

- [ ] Requirement 1: Test must use fake database
  - Acceptance: SQLite database is faked/mocked
- [ ] Requirement 2: Test must use real TaskOperatorService where possible
  - Acceptance: TaskOperatorService logic is tested, not fully mocked
- [ ] Requirement 3: Test must verify complete lifecycle
  - Acceptance: All steps from task insertion to completion work
- [ ] Requirement 4: Test must verify state changes
  - Acceptance: Task status changes, lock is released

### Error Handling and Edge Cases

- [ ] Handle case where callback fails
- [ ] Handle case where task processing fails
- [ ] Verify lock is released even on errors
- [ ] Test with various task states

### Testing

- [ ] Run `npm run test:http` or `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining task-operator lifecycle
- [ ] Document fake database setup
- [ ] Note callback simulation approach

### Verification

- [ ] Verify test passes consistently
- [ ] Verify complete lifecycle works
- [ ] Verify state changes are correct
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 7 â€“ Integration & E2E-lite Scenarios**
- **Execution Timing**: Should be executed after TASK-050
- **Dependencies**: 
  - TASK-050: Enhance integration.test.ts for richer agent lifecycle
- **Important Considerations**: 
  - Integration test verifies multiple components working together
  - Fake database allows testing without real SQLite file
  - Mock Redis allows testing without real Redis instance
  - Real TaskOperatorService ensures actual logic is tested
  - Callback simulation requires careful mock setup
  - Lock release verification is critical
- **Task Independence**: Can be completed independently after TASK-050
- **Current State**: Test file exists but may not have comprehensive task-operator lifecycle test

## Related Tasks

- Previous: TASK-050 (Enhance integration.test.ts for richer agent lifecycle)
- Next: TASK-052 (Add failure-injection integration tests)
- Dependencies:
  - TASK-050: Enhance integration.test.ts for richer agent lifecycle
- Related:
  - TASK-018 through TASK-027: Tested TaskOperatorService in unit tests
  - TASK-052: Will test failure scenarios

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding a comprehensive integration test for the task-operator lifecycle.

**Definition of Done**: "A comprehensive task-operator lifecycle integration test is added that uses fake database and Redis but real TaskOperatorService, and verifies complete flow from task insertion to completion. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify task-operator lifecycle works end-to-end so that I can trust task processing.
   - **Acceptance Criteria**: 
     - Test verifies task can be inserted and processed
     - Test verifies callback is handled correctly
     - Test verifies task is marked complete
     - Test passes consistently

2. **As a developer**, I want to verify lock management works so that distributed processing is safe.
   - **Acceptance Criteria**:
     - Test verifies lock is acquired and released
     - Test verifies lock state is correct

### Automated Tests

The test case should be:

```typescript
describe('Task-operator lifecycle integration', () => {
  it('should handle complete task-operator lifecycle', async () => {
    // Arrange: Fake database, mock Redis, mock fetch
    const fakeDb = createFakeDatabase();
    fakeDb.insertTask({ id: 1, prompt: 'test', status: 0, order: 0, uuid: 'test-uuid' });
    const mockRedis = createMockRedis();
    global.fetch = jest.fn()
      .mockResolvedValueOnce({ // Conversation creation
        ok: true,
        text: () => Promise.resolve(JSON.stringify({ conversationId: 'conv-123' })),
      })
      .mockResolvedValueOnce({ // Async iterate
        ok: true,
        json: () => Promise.resolve({ success: true }),
      });
    
    const app = new CursorAgentsApp(undefined, fakeDb, mockRedis);
    
    // Step 1: Enable task operator
    await request(app.getApp())
      .post('/task-operator')
      .expect(200);
    
    // Step 2: Trigger processing (may need to wait or trigger manually)
    // Task should be processed
    
    // Step 3: Simulate callback
    const requestId = 'req-123'; // From processing
    await request(app.getApp())
      .post('/task-operator/callback')
      .set('X-Webhook-Secret', process.env.WEBHOOK_SECRET)
      .send({ requestId, success: true })
      .expect(200);
    
    // Step 4: Verify completion
    const task = fakeDb.getTask(1);
    expect(task.status).toBe(1); // COMPLETE
    // Verify lock is released
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies complete lifecycle
- [ ] Test uses fake database and Redis
- [ ] Test uses real TaskOperatorService logic

### Git Commit and Push Requirements

- [ ] Test case added to `tests/integration.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add task-operator lifecycle integration test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies complete lifecycle
- [ ] Test verifies state changes
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
