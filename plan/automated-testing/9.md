# TASK-009: Test setSystemSetting error path

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.6
**Task ID**: TASK-009

## Description

Add a test case for the `setSystemSetting` method to verify it properly handles database write errors. The test should verify that when the underlying database operation fails, the method returns `false` and logs the error appropriately. This ensures robust error handling for system setting writes.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 68-91) - `setSystemSetting()` error handling

## Current State

The `setSystemSetting` method:
- Catches database errors
- Returns `false` on error (fail-closed behavior)
- Logs errors with context (setting name, value, error message)

The test file `tests/services/database-service.test.ts` exists with happy path tests from TASK-008.

**Important**: This task should be executed after TASK-008 (test setSystemSetting happy path).

## Checklist

### Preparation and Setup

- [ ] Review `setSystemSetting` error handling implementation
- [ ] Understand how to mock database operations to throw errors
- [ ] Review logger mocking patterns
- [ ] Understand `better-sqlite3` error types

### Implementation Steps

- [ ] Step 1: Set up logger mock
  - [ ] Mock the logger module if needed
  - [ ] Set up spy on `logger.error` to verify error logging
- [ ] Step 2: Write error path test
  - [ ] Create test: `it('should return false and log error when database write fails', () => { ... })`
  - [ ] Arrange: Mock database `prepare` or `run` to throw an error
    - [ ] Option 1: Use a spy to intercept and throw
    - [ ] Option 2: Create invalid database state that causes write to fail
    - [ ] Option 3: Use a read-only database if possible
  - [ ] Act: Call `setSystemSetting('test_setting', true)`
  - [ ] Assert: Returns `false`
- [ ] Step 3: Verify error logging
  - [ ] Assert: `logger.error` was called
  - [ ] Assert: Error log contains relevant context (setting name, value, error details)
  - [ ] Verify error object structure if possible

### Specific Requirements

- [ ] Requirement 1: Test must verify error returns false
  - Acceptance: Calling `setSystemSetting` when database write fails returns `false`
- [ ] Requirement 2: Test must verify error is logged
  - Acceptance: `logger.error` is called with appropriate context
- [ ] Requirement 3: Test must simulate database error
  - Acceptance: Database operation actually fails (mocked or real failure)
- [ ] Requirement 4: Test must not leave invalid state
  - Acceptance: Test cleans up and doesn't affect other tests

### Error Handling and Edge Cases

- [ ] Handle different types of database errors (constraint violations, connection errors, etc.)
- [ ] Verify error message is descriptive
- [ ] Ensure test doesn't create invalid database state
- [ ] Handle case where error type varies

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes (error handling works as expected)
- [ ] Verify logger mock works correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error simulation strategy
- [ ] Document why fail-closed behavior is important
- [ ] Note any limitations of error simulation

### Verification

- [ ] Verify test passes consistently
- [ ] Verify error is properly handled (returns false)
- [ ] Verify error is properly logged
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-008
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-008: Test setSystemSetting happy path
- **Important Considerations**: 
  - Mocking database operations may require careful setup
  - Error simulation should be realistic but not destructive
  - Fail-closed behavior (returns false) is intentional for safety
- **Task Independence**: Can be completed independently after TASK-008
- **Current State**: Test file exists with happy path tests

## Related Tasks

- Previous: TASK-008 (Test setSystemSetting happy path)
- Next: TASK-010 (Test getNextReadyTask behavior)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-008: Test setSystemSetting happy path
- Related:
  - TASK-010: Will test task retrieval functionality

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for the `setSystemSetting` method error path.

**Definition of Done**: "A test case is written that verifies `setSystemSetting` properly handles database write errors by returning `false` and logging the error. The test passes consistently and verifies both error handling and logging. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that the system handles write failures gracefully.
   - **Acceptance Criteria**: 
     - Test verifies error returns `false` (fail-closed)
     - Test passes consistently
     - Error is descriptive

2. **As a developer**, I want to verify errors are logged so that I can debug issues in production.
   - **Acceptance Criteria**:
     - Test verifies `logger.error` is called
     - Error log contains relevant context (setting name, value, error message)

### Automated Tests

The test case should be:

```typescript
it('should return false and log error when database write fails', () => {
  // Arrange: Mock database to throw error
  // Option 1: Spy on prepare/run methods
  // Option 2: Create invalid database state
  const service = new DatabaseService(':memory:');
  // Mock or cause database error
  
  // Act
  const result = service.setSystemSetting('test_setting', true);
  
  // Assert
  expect(result).toBe(false);
  // Verify logger.error was called with appropriate context
});
```

- [ ] Test case written and passes
- [ ] Test verifies error returns false
- [ ] Test verifies error is logged
- [ ] Test simulates database error appropriately

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add setSystemSetting error path test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies error handling
- [ ] Test verifies error logging
- [ ] Test simulates database error
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
