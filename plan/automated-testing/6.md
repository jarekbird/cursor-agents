# TASK-006: Test database connection failure

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.3
**Task ID**: TASK-006

## Description

Add a test case to verify that `DatabaseService` properly handles database connection failures. The test should verify that when an invalid or unwritable database path is provided, the service throws an error and logs the failure appropriately. This ensures robust error handling for database connectivity issues.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 19-35) - `getDatabase()` error handling
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` (lines 87-94) - error test pattern

## Current State

The `DatabaseService.getDatabase()` method:
- Catches connection errors
- Logs errors with context
- Throws the error to the caller

The test file `tests/services/database-service.test.ts` exists and has a connection success test from TASK-005.

**Important**: This task should be executed after TASK-005 (test connection success).

## Checklist

### Preparation and Setup

- [ ] Review `DatabaseService.getDatabase()` error handling
- [ ] Understand how to create invalid database paths for testing
- [ ] Review logger mocking patterns in existing tests
- [ ] Understand error types thrown by `better-sqlite3`

### Implementation Steps

- [ ] Step 1: Set up logger mock
  - [ ] Mock the logger module if needed
  - [ ] Set up spy on `logger.error` to verify error logging
- [ ] Step 2: Write connection failure test
  - [ ] Create test: `it('should throw error on database connection failure', () => { ... })`
  - [ ] Arrange: Create `DatabaseService` with invalid path (e.g., `/invalid/path/that/does/not/exist/db.sqlite3`)
  - [ ] Act: Call a method that triggers `getDatabase()` (e.g., `isSystemSettingEnabled('test')`)
  - [ ] Assert: Error is thrown
- [ ] Step 3: Verify error logging
  - [ ] Assert: `logger.error` was called
  - [ ] Assert: Error message contains relevant context (path, error details)
  - [ ] Verify error object structure if possible

### Specific Requirements

- [ ] Requirement 1: Test must verify error is thrown
  - Acceptance: Calling a method with invalid DB path throws an error
- [ ] Requirement 2: Test must verify error is logged
  - Acceptance: `logger.error` is called with appropriate context
- [ ] Requirement 3: Test must use invalid path
  - Acceptance: Database path is clearly invalid (non-existent directory or unwritable location)
- [ ] Requirement 4: Test must not leave resources
  - Acceptance: No database files are created in invalid locations

### Error Handling and Edge Cases

- [ ] Handle different types of invalid paths (non-existent directory, permission denied, etc.)
- [ ] Verify error message is descriptive
- [ ] Ensure test doesn't create actual files
- [ ] Handle case where error type varies by platform

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes (error is thrown as expected)
- [ ] Verify logger mock works correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining invalid path strategy
- [ ] Document why error logging verification is important
- [ ] Note any platform-specific considerations

### Verification

- [ ] Verify test passes consistently
- [ ] Verify error is properly thrown
- [ ] Verify error is properly logged
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-005
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005: Test database connection success
- **Important Considerations**: 
  - Invalid paths should be clearly invalid (deep non-existent paths work well)
  - Logger mocking may require module mocking depending on logger implementation
  - Error types may vary by platform (Windows vs Unix)
- **Task Independence**: Can be completed independently after TASK-005
- **Current State**: Test file exists with connection success test

## Related Tasks

- Previous: TASK-005 (Test database connection success)
- Next: TASK-007 (Test isSystemSettingEnabled behavior)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005: Test database connection success
- Related:
  - TASK-007: Will test system settings functionality

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for database connection failure handling.

**Definition of Done**: "A test case is written that verifies `DatabaseService` properly throws errors and logs failures when database connection cannot be established. The test passes consistently and verifies both error throwing and logging. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that I can trust the system handles failures gracefully.
   - **Acceptance Criteria**: 
     - Test verifies error is thrown on connection failure
     - Test passes consistently
     - Error is descriptive

2. **As a developer**, I want to verify errors are logged so that I can debug issues in production.
   - **Acceptance Criteria**:
     - Test verifies `logger.error` is called
     - Error log contains relevant context (path, error message)

### Automated Tests

The test case should be:

```typescript
it('should throw error on database connection failure', () => {
  // Arrange
  const invalidPath = '/invalid/path/that/does/not/exist/db.sqlite3';
  const service = new DatabaseService(invalidPath);
  
  // Act & Assert
  expect(() => {
    service.isSystemSettingEnabled('test'); // Triggers getDatabase()
  }).toThrow();
  
  // Verify error was logged
  // (May require logger mock setup)
});
```

- [ ] Test case written and passes
- [ ] Test verifies error is thrown
- [ ] Test verifies error is logged
- [ ] Test uses invalid database path

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add database connection failure test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies error throwing
- [ ] Test verifies error logging
- [ ] Test uses invalid path
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
