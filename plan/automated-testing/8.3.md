# TASK-008.3: Test setSystemSetting - updating existing setting

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.5.3
**Task ID**: TASK-008.3

## Description

Add a test case for the `setSystemSetting` method to verify it correctly updates an existing system setting. The test should verify that when a setting already exists, it can be updated to a new value using the `INSERT ... ON CONFLICT` mechanism.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 68-91) - `setSystemSetting()` method

## Current State

The `setSystemSetting` method:
- Uses `INSERT ... ON CONFLICT` to handle both insert and update
- Updates `updated_at` timestamp

The test file `tests/services/database-service.test.ts` exists with previous tests including TASK-008.1 and TASK-008.2.

**Important**: This task should be executed after TASK-008.2, completing TASK-008.

## Checklist

### Preparation and Setup

- [ ] Review `setSystemSetting` update logic
- [ ] Understand `INSERT ... ON CONFLICT` update behavior
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for updating existing setting
  - [ ] Create test: `it('should update existing system setting', () => { ... })`
  - [ ] Arrange: Insert setting with value 0
  - [ ] Act: Call `setSystemSetting('test_setting', true)`
  - [ ] Assert: Returns `true`
  - [ ] Assert: Setting now has value 1
  - [ ] Assert: `updated_at` timestamp changed (if verifiable)

### Specific Requirements

- [ ] Requirement 1: Test must verify updates work
  - Acceptance: Updating existing setting changes value correctly
- [ ] Requirement 2: Test must verify return value
  - Acceptance: Method returns `true` on success

### Error Handling and Edge Cases

- [ ] Handle case where setting is updated multiple times
- [ ] Verify `created_at` is preserved on updates (if applicable)
- [ ] Test with various setting names

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify tests are isolated
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining update scenario
- [ ] Document why `ON CONFLICT` is used
- [ ] Note any timestamp verification limitations

### Verification

- [ ] Verify test passes consistently
- [ ] Verify database writes are correct
- [ ] Verify reads after writes work
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-008.2 (completes TASK-008)
- **Dependencies**: 
  - TASK-008.2: Test setSystemSetting - setting to false
- **Important Considerations**: 
  - Verify both insert (new) and update (existing) paths
  - Timestamp verification may be limited by test timing
  - This is the third and final subtask for TASK-008
- **Task Independence**: Can be completed independently after TASK-008.2
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-008 (Test setSystemSetting happy path)
- Previous: TASK-008.2 (Test setSystemSetting - setting to false)
- Next: TASK-009 (Test setSystemSetting error path)
- Dependencies:
  - TASK-008.2: Test setSystemSetting - setting to false
- Related:
  - TASK-008.1, TASK-008.2: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `setSystemSetting` when updating an existing setting.

**Definition of Done**: "A test case is written that verifies `setSystemSetting` correctly updates an existing system setting using `INSERT ... ON CONFLICT`. The test verifies the value is updated correctly. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify settings can be updated so that values can be changed.
   - **Acceptance Criteria**:
     - Test verifies updating existing setting works
     - Test verifies updated value is correct
     - Test verifies round-trip (write then read) works

### Automated Tests

The test case should be:

```typescript
describe('setSystemSetting', () => {
  it('should update existing system setting', () => {
    // Arrange: Setting exists with value 0
    // Act: setSystemSetting('test', true)
    // Assert: Returns true, setting now has value 1
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify database writes
- [ ] Tests verify round-trip (write then read)

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add setSystemSetting updating existing setting test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify database writes
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-008 (all subtasks) is complete**

