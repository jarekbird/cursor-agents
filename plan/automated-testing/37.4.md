# TASK-037.4: Test task-operator internal jobs - error case (10000ms delay)

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.3.4
**Task ID**: TASK-037.4

## Description

Add a test case for task-operator internal jobs to verify that when `processNextTask` throws an error, the job is re-enqueued with a 10000ms delay and the error is logged. This verifies error handling and longer retry delay for errors.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - task-operator internal job handling

## Current State

The `PromptProcessor.process()` method:
- Based on result, re-enqueues with appropriate delay:
  - Error: ~10000ms delay

The test file `tests/queue/prompt-processor.test.ts` exists with previous tests including TASK-037.1, TASK-037.2, and TASK-037.3.

**Important**: This task should be executed after TASK-037.3.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` task-operator error handling
- [ ] Understand delay logic (10000ms for errors)
- [ ] Review error logging patterns
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Write test for error in processNextTask
  - [ ] Create test: `it('should re-enqueue with 10000ms delay when processNextTask throws', async () => { ... })`
  - [ ] Arrange: 
    - [ ] `processNextTask` throws error
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with delay ~10000ms
    - [ ] Error is logged

### Specific Requirements

- [ ] Requirement 1: Test must verify error case
  - Acceptance: Re-enqueue with 10000ms delay, error logged
- [ ] Requirement 2: Test must verify delay value
  - Acceptance: Delay is approximately 10000ms (allow small variance)
- [ ] Requirement 3: Test must verify error logging
  - Acceptance: Error is logged appropriately

### Error Handling and Edge Cases

- [ ] Verify delay values are approximately correct (allow small variance)
- [ ] Test with various error types
- [ ] Verify logging occurs correctly

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling
- [ ] Document why 10000ms delay is used for errors

### Verification

- [ ] Verify test passes consistently
- [ ] Verify delay logic works
- [ ] Verify error logging works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after TASK-037.3
- **Dependencies**: 
  - TASK-037.3: Test task-operator internal jobs - no tasks/lock held case
- **Important Considerations**: 
  - Delay of 10000ms for errors (longer than normal retry)
  - Error logging is important for debugging
  - This is the fourth of 5 subtasks for TASK-037
- **Task Independence**: Can be completed independently after TASK-037.3
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-037 (Add tests for task-operator internal jobs)
- Previous: TASK-037.3 (Test task-operator internal jobs - no tasks/lock held case)
- Next: TASK-037.5 (Test task-operator internal jobs - addDelayedAgent returns null)
- Dependencies:
  - TASK-037.3: Test task-operator internal jobs - no tasks/lock held case
- Related:
  - TASK-037.1, TASK-037.2, TASK-037.3, TASK-037.5: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for task-operator internal jobs when processNextTask throws an error.

**Definition of Done**: "A test case is written that verifies task-operator internal jobs are re-enqueued with 10000ms delay when processNextTask throws an error, and the error is logged. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that errors are handled gracefully with longer retry delays.
   - **Acceptance Criteria**: 
     - Test verifies re-enqueue occurs with 10000ms delay
     - Test verifies error is logged
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('task-operator internal jobs', () => {
  it('should re-enqueue with 10000ms delay when processNextTask throws', async () => {
    // Arrange: processNextTask throws
    // Act: promptProcessor.process(job)
    // Assert: addDelayedAgent called with delay ~10000ms, error logged
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies delay logic
- [ ] Test verifies error logging

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add task-operator error case test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies delay logic
- [ ] Test verifies error logging
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

