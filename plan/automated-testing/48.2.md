# TASK-048.2: Add tests for MCP resources - resource reading

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.3.2
**Task ID**: TASK-048.2

## Description

Add test cases for MCP resources functionality to verify resource reading returns agent status JSON for `agent://{name}` URIs or throws for non-existent agents. The tests should verify that the resource read handler correctly retrieves agent status.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - MCP resource read handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The MCP server implements resources:
- Resource reading: Returns agent status JSON for `agent://{name}` URI

The test file `tests/mcp/server.test.ts` exists with previous tests including TASK-048.1.

**Important**: This task should be executed after TASK-048.1, completing TASK-048.

## Checklist

### Preparation and Setup

- [ ] Review MCP resource read handler implementation
- [ ] Understand resource URI format (`agent://{name}`)
- [ ] Review test setup from TASK-048.1

### Implementation Steps

- [ ] Step 1: Write test for resource reading (existing agent)
  - [ ] Create test: `it('should return agent status JSON for existing agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `getAgentStatus` to return status object
      - [ ] URI: `agent://test-agent`
    - [ ] Act: Invoke resource read handler with URI
    - [ ] Assert: 
      - [ ] Returns `contents[0].text` as JSON
      - [ ] JSON represents agent status
      - [ ] All status fields are present
- [ ] Step 2: Write test for resource reading (non-existent agent)
  - [ ] Create test: `it('should throw error for non-existent agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock `getAgentStatus` to return `null`
      - [ ] URI: `agent://non-existent`
    - [ ] Act: Invoke resource read handler with URI
    - [ ] Assert: 
      - [ ] Handler throws error
      - [ ] Error message: `"Agent \"non-existent\" not found"`

### Specific Requirements

- [ ] Requirement 1: Test must verify resource reading (existing)
  - Acceptance: Returns agent status JSON correctly
- [ ] Requirement 2: Test must verify resource reading (non-existent)
  - Acceptance: Throws error with descriptive message
- [ ] Requirement 3: Test must verify URI format
  - Acceptance: URIs follow `agent://{name}` pattern

### Error Handling and Edge Cases

- [ ] Handle case where agent name contains special characters
- [ ] Verify URI parsing works correctly
- [ ] Test with various agent states

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining resource reading behavior
- [ ] Document URI format

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify resource reading works
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-048.1 (completes TASK-048)
- **Dependencies**: 
  - TASK-048.1: Add tests for MCP resources - resource listing
- **Important Considerations**: 
  - Resource reading provides detailed agent information
  - URI format `agent://{name}` is standard MCP pattern
  - This is the second and final subtask for TASK-048
- **Task Independence**: Can be completed independently after TASK-048.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-048 (Add tests for MCP resources (agents))
- Previous: TASK-048.1 (Add tests for MCP resources - resource listing)
- Next: TASK-049 (Add logging expectation tests)
- Dependencies:
  - TASK-048.1: Add tests for MCP resources - resource listing
- Related:
  - TASK-048.1: Other subtask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for MCP resource reading.

**Definition of Done**: "Test cases are added that verify MCP resource reading returns agent status JSON for existing agents or throws for non-existent agents. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify resource reading works so that MCP clients can get agent details.
   - **Acceptance Criteria**:
     - Test verifies existing agents return status JSON
     - Test verifies non-existent agents throw errors

### Automated Tests

Test cases should include:

```typescript
describe('MCP resources (agents)', () => {
  it('should return agent status JSON for existing agent', async () => {
    // Arrange: getAgentStatus returns status
    const status = { name: 'test', isActive: true, targetUrl: 'http://example.com' };
    mockQueueManager.getAgentStatus.mockReturnValue(status);
    
    // Act: Invoke resource read handler
    const content = await resourceReadHandler('agent://test');
    
    // Assert
    const json = JSON.parse(content.contents[0].text);
    expect(json).toEqual(status);
  });
  
  it('should throw error for non-existent agent', async () => {
    // Arrange: getAgentStatus returns null
    // Act & Assert: Throws "Agent \"non-existent\" not found"
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify resource reading
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add MCP resource reading tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify resource reading
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-048 (all subtasks) is complete**

