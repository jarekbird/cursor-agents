# TASK-019: Test processNextTask with no tasks available

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.4
**Task ID**: TASK-019

## Description

Add a test case for the `processNextTask` method to verify it correctly handles the case where no tasks are available in the database. The test should verify that the method acquires the lock successfully, checks for tasks, finds none, releases the lock, and returns the appropriate result.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `processNextTask()` method with no tasks handling

## Current State

The `processNextTask` method:
- Acquires Redis lock successfully
- Calls `DatabaseService.getNextReadyTask()` to get next task
- If no tasks are available (returns `null`), releases the lock
- Returns `{ processed: false, reason: 'no_tasks' }`

The test file `tests/services/task-operator-service.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-018.

## Checklist

### Preparation and Setup

- [ ] Review `processNextTask` no tasks handling implementation
- [ ] Understand how `releaseLock()` works
- [ ] Review DatabaseService mocking patterns
- [ ] Understand Redis lock release mechanism

### Implementation Steps

- [ ] Step 1: Set up Redis mock
  - [ ] Mock Redis `set` to return `'OK'` (lock acquired)
  - [ ] Mock Redis `del` or `releaseLock` method
  - [ ] Create spy on lock release
- [ ] Step 2: Set up DatabaseService mock
  - [ ] Mock `DatabaseService.getNextReadyTask` to return `null`
  - [ ] Verify method is called
- [ ] Step 3: Write test for no tasks
  - [ ] Create test: `it('should return no_tasks when no tasks are available', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock Redis `set` to return `'OK'` (lock acquired)
    - [ ] Mock `getNextReadyTask` to return `null`
    - [ ] Set up spy on `releaseLock` or Redis `del`
  - [ ] Act: Call `processNextTask()`
  - [ ] Assert: 
    - [ ] Result is `{ processed: false, reason: 'no_tasks' }`
    - [ ] `releaseLock()` was called
    - [ ] `getNextReadyTask` was called

### Specific Requirements

- [ ] Requirement 1: Test must verify no tasks handling
  - Acceptance: Method returns `{ processed: false, reason: 'no_tasks' }` when no tasks exist
- [ ] Requirement 2: Test must verify lock is released
  - Acceptance: `releaseLock()` is called when no tasks are available
- [ ] Requirement 3: Test must verify database query
  - Acceptance: `getNextReadyTask` is called to check for tasks
- [ ] Requirement 4: Test must verify lock acquisition
  - Acceptance: Lock is acquired before checking for tasks

### Error Handling and Edge Cases

- [ ] Handle case where `getNextReadyTask` throws an error (covered in other tests)
- [ ] Verify lock is always released even if database query fails
- [ ] Test that no task processing occurs

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining no tasks scenario
- [ ] Document why lock is released immediately
- [ ] Note any cleanup considerations

### Verification

- [ ] Verify test passes consistently
- [ ] Verify no tasks handling works correctly
- [ ] Verify lock is released
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-018
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-018: Test lock acquisition failure
- **Important Considerations**: 
  - Lock must be acquired before checking for tasks
  - Lock must be released when no tasks are found
  - This is a common scenario (no work to do)
  - Method should return quickly when no tasks exist
- **Task Independence**: Can be completed independently after TASK-018
- **Current State**: Test file exists with previous tests

## Related Tasks

- Previous: TASK-018 (Test lock acquisition failure)
- Next: TASK-020 (Test happy path processNextTask)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-018: Test lock acquisition failure
- Related:
  - TASK-020: Will test the happy path with tasks available

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `processNextTask` when no tasks are available.

**Definition of Done**: "A test case is written that verifies `processNextTask` correctly handles the no tasks scenario by returning `{ processed: false, reason: 'no_tasks' }` and releasing the lock. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify no tasks handling works so that the system handles empty queues correctly.
   - **Acceptance Criteria**: 
     - Test verifies method returns no_tasks when no tasks exist
     - Test verifies lock is released
     - Test passes consistently

2. **As a developer**, I want to verify lock cleanup works so that locks don't leak when no work is available.
   - **Acceptance Criteria**:
     - Test verifies `releaseLock()` is called
     - Test verifies lock is properly released

### Automated Tests

The test case should be:

```typescript
it('should return no_tasks when no tasks are available', async () => {
  // Arrange: Mock Redis lock success, DatabaseService returns null
  const mockRedis = {
    set: jest.fn().mockResolvedValue('OK'), // Lock acquired
    del: jest.fn().mockResolvedValue(1), // Lock released
  };
  const mockDbService = {
    getNextReadyTask: jest.fn().mockReturnValue(null), // No tasks
  };
  const service = TaskOperatorService.getInstance(mockRedis);
  // Inject mockDbService or spy on actual instance
  
  // Act
  const result = await service.processNextTask();
  
  // Assert
  expect(result).toEqual({ processed: false, reason: 'no_tasks' });
  expect(mockDbService.getNextReadyTask).toHaveBeenCalled();
  // Verify releaseLock was called
});
```

- [ ] Test case written and passes
- [ ] Test verifies no tasks handling
- [ ] Test verifies lock release
- [ ] Test verifies database query

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add processNextTask no tasks test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies no tasks handling
- [ ] Test verifies lock release
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
