# TASK-036: Add tests for no re-enqueue conditions

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.2
**Task ID**: TASK-036

**NOTE**: This task has been split into granular subtasks:
- **TASK-036.1**: Test no re-enqueue - missing requeue flag
- **TASK-036.2**: Test no re-enqueue - requeue: false

Please execute the subtasks (36.1, 36.2) instead of this parent task.

## Description

Add test cases to verify that re-enqueueing does NOT occur when the HTTP response lacks the `requeue` flag or has `requeue: false`. The tests should verify that `addDelayedAgent` is not called in these cases.

**This task has been split into subtasks - see TASK-036.1 and TASK-036.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - re-enqueueing conditional logic
- `virtual-assistant/cursor-agents/tests/queue/prompt-processor.test.ts` - existing test structure

## Current State

The `PromptProcessor.process()` method:
- Only calls `addDelayedAgent` when response has `requeue: true`
- Does not re-enqueue when `requeue` is missing
- Does not re-enqueue when `requeue: false`
- Normal processing continues without re-enqueueing

The test file `tests/queue/prompt-processor.test.ts` exists with re-enqueueing tests from TASK-035.

**Important**: This task should be executed after TASK-035.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` conditional logic
- [ ] Understand when requeue flag is checked
- [ ] Review existing re-enqueueing tests
- [ ] Understand normal processing flow

### Implementation Steps

- [ ] Step 1: Write test for missing requeue flag
  - [ ] Create test: `it('should not re-enqueue when requeue flag is missing', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock HTTP response without `requeue` field
    - [ ] Set up spy on `addDelayedAgent`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` not called
    - [ ] Normal processing completes
- [ ] Step 2: Write test for requeue: false
  - [ ] Create test: `it('should not re-enqueue when requeue is false', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock HTTP response with `{ requeue: false }`
    - [ ] Set up spy on `addDelayedAgent`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` not called
    - [ ] Normal processing completes

### Specific Requirements

- [ ] Requirement 1: Test must verify no re-enqueue when flag missing
  - Acceptance: `addDelayedAgent` not called
- [ ] Requirement 2: Test must verify no re-enqueue when flag false
  - Acceptance: `addDelayedAgent` not called
- [ ] Requirement 3: Test must verify normal processing
  - Acceptance: Processing completes normally
- [ ] Requirement 4: Test must verify flag check
  - Acceptance: Only `requeue: true` triggers re-enqueue

### Error Handling and Edge Cases

- [ ] Handle case where response is not JSON
- [ ] Handle case where response is empty
- [ ] Verify flag is checked as boolean, not truthy
- [ ] Test with various response structures

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining conditional logic
- [ ] Document when re-enqueue does not occur
- [ ] Note flag checking behavior

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify no false positives (re-enqueue when shouldn't)
- [ ] Verify normal processing works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after TASK-035
- **Dependencies**: 
  - TASK-035: Extend prompt-processor.test.ts for re-enqueueing
- **Important Considerations**: 
  - Negative test cases are important for ensuring correct behavior
  - Flag must be explicitly `true` to trigger re-enqueue
  - Normal processing should continue regardless of requeue flag
  - Tests complement TASK-035 positive cases
- **Task Independence**: Can be completed independently after TASK-035
- **Current State**: Test file exists with re-enqueueing tests

## Related Tasks

- Previous: TASK-035 (Extend prompt-processor.test.ts for re-enqueueing)
- Next: TASK-037 (Add tests for task-operator internal jobs)
- Dependencies:
  - TASK-035: Extend prompt-processor.test.ts for re-enqueueing
- Related:
  - TASK-035: Tested positive re-enqueue cases
  - TASK-037: Will test task-operator specific logic

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for when re-enqueueing does NOT occur.

**Definition of Done**: "Test cases are added that verify re-enqueueing does not occur when `requeue` flag is missing or `false`. Tests verify `addDelayedAgent` is not called and normal processing continues. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify re-enqueue only occurs when explicitly requested so that agents don't re-enqueue unnecessarily.
   - **Acceptance Criteria**: 
     - Test verifies no re-enqueue when flag missing
     - Test verifies no re-enqueue when flag false
     - Test passes consistently

2. **As a developer**, I want to verify normal processing continues so that non-requeue responses work correctly.
   - **Acceptance Criteria**:
     - Test verifies processing completes normally
     - Test verifies no side effects from missing flag

### Automated Tests

Test cases should include:

```typescript
describe('no re-enqueue conditions', () => {
  it('should not re-enqueue when requeue flag is missing', async () => {
    // Arrange: Response without requeue field
    const mockQueueManager = {
      addDelayedAgent: jest.fn(),
    };
    const processor = new PromptProcessor(mockQueueManager);
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve({ success: true }), // No requeue field
    });
    
    // Act
    await processor.process({ data: jobData });
    
    // Assert
    expect(mockQueueManager.addDelayedAgent).not.toHaveBeenCalled();
  });
  
  it('should not re-enqueue when requeue is false', async () => {
    // Arrange: Response with requeue: false
    // Act & Assert: addDelayedAgent not called
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify no re-enqueue when flag missing
- [ ] Tests verify no re-enqueue when flag false
- [ ] Tests verify normal processing

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add no re-enqueue conditions tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify no false positives
- [ ] Tests verify normal processing
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
