# TASK-031.1: Test addDelayedAgent - non-task-operator queue

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.4.1
**Task ID**: TASK-031.1

## Description

Add a test case for the `addDelayedAgent` method to verify it correctly adds delayed jobs for non-task-operator queues. The test should verify job creation with correct delay, name, and data.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `addDelayedAgent()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `addDelayedAgent` method:
- Adds a delayed job to a queue with specified delay
- For non-task-operator queues: always adds the job
- Sets correct job name and data

The test file `tests/queue/queue-manager.test.ts` exists but may not have `addDelayedAgent` tests.

**Important**: This task should be executed after TASK-030. This is the first subtask of TASK-031.

## Checklist

### Preparation and Setup

- [ ] Review `addDelayedAgent` implementation
- [ ] Understand delayed job creation in BullMQ
- [ ] Review existing test structure

### Implementation Steps

- [ ] Step 1: Write test for non-task-operator queue
  - [ ] Create test: `it('should add delayed job for non-task-operator queue', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Queue name that's not `'task-operator'` (e.g., `'default'`)
    - [ ] Mock queue `add` method
    - [ ] Agent config with delay
  - [ ] Act: Call `addDelayedAgent(queue, config, delay)`
  - [ ] Assert: 
    - [ ] Queue `add` called with correct delay, name, and data
    - [ ] Job metadata returned

### Specific Requirements

- [ ] Requirement 1: Test must verify non-task-operator behavior
  - Acceptance: Delayed job is added for non-task-operator queues
- [ ] Requirement 2: Test must verify job parameters
  - Acceptance: Delay, name, and data are set correctly

### Error Handling and Edge Cases

- [ ] Handle case where queue `add` fails
- [ ] Verify job name format is correct
- [ ] Test with various delay values

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining job creation behavior
- [ ] Note job name and data structure

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify job creation works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-030
- **Dependencies**: 
  - TASK-030: Add tests for hasExistingJobs
- **Important Considerations**: 
  - Non-task-operator queues can have multiple delayed jobs
  - Job name format: `agent:{name}` for agents
  - This is the first of 3 subtasks for TASK-031
- **Task Independence**: Can be completed independently after TASK-030
- **Current State**: Test file exists but may not have addDelayedAgent tests

## Related Tasks

- Parent: TASK-031 (Add tests for addDelayedAgent)
- Next: TASK-031.2 (Test addDelayedAgent - task-operator with existing jobs)
- Dependencies:
  - TASK-030: Add tests for hasExistingJobs
- Related:
  - TASK-031.2, TASK-031.3: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `addDelayedAgent` when adding to non-task-operator queue.

**Definition of Done**: "A test case is written that verifies `addDelayedAgent` correctly adds delayed jobs for non-task-operator queues with correct parameters. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify delayed job creation works so that agents can be scheduled.
   - **Acceptance Criteria**: 
     - Test verifies delayed job is added with correct parameters
     - Test verifies job metadata is returned
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('addDelayedAgent', () => {
  it('should add delayed job for non-task-operator queue', async () => {
    // Arrange: Non-task-operator queue
    const mockQueue = {
      add: jest.fn().mockResolvedValue({ id: 'job-1', name: 'agent:test' }),
    };
    const config = { name: 'test', targetUrl: 'http://example.com' };
    const delay = 5000;
    
    // Act
    const result = await queueManager.addDelayedAgent(mockQueue, config, delay);
    
    // Assert
    expect(mockQueue.add).toHaveBeenCalledWith(
      'agent:test',
      expect.objectContaining(config),
      expect.objectContaining({ delay })
    );
    expect(result).toBeDefined();
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify non-task-operator behavior

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add addDelayedAgent non-task-operator queue test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify job creation
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

