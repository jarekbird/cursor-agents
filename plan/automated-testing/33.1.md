# TASK-033.1: Test removeAgent - remove jobs

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.6.1
**Task ID**: TASK-033.1

## Description

Add a test case for the `removeAgent` method to verify it correctly removes repeatable jobs and waiting/delayed jobs for an agent, and calls `checkAndCleanupEmptyQueue` after removal.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `removeAgent()` method

## Current State

The `removeAgent` method:
- Removes repeatable jobs using `removeRepeatableByKey`
- Removes waiting/delayed jobs
- Calls `checkAndCleanupEmptyQueue` after removal

The test file `tests/queue/queue-manager.test.ts` exists but may not have comprehensive `removeAgent` tests.

**Important**: This task should be executed after TASK-032. This is the first subtask of TASK-033.

## Checklist

### Preparation and Setup

- [ ] Review `removeAgent` implementation
- [ ] Understand repeatable job removal (`removeRepeatableByKey`)
- [ ] Understand job removal from different states
- [ ] Review existing test structure

### Implementation Steps

- [ ] Step 1: Write test for removeAgent
  - [ ] Create test: `it('should remove repeatable and waiting/delayed jobs for agent', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Mock queue with repeatable jobs and waiting/delayed jobs
      - [ ] Set up spies on removal methods
    - [ ] Act: Call `removeAgent('test')`
    - [ ] Assert: 
      - [ ] Repeatable jobs removed
      - [ ] Waiting/delayed jobs removed
      - [ ] `checkAndCleanupEmptyQueue` called

### Specific Requirements

- [ ] Requirement 1: Test must verify agent removal
  - Acceptance: Repeatable and waiting/delayed jobs are removed
- [ ] Requirement 2: Test must verify cleanup is called
  - Acceptance: `checkAndCleanupEmptyQueue` is called after removal

### Error Handling and Edge Cases

- [ ] Handle case where no jobs exist for agent
- [ ] Verify all job types are removed

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining agent removal logic

### Verification

- [ ] Verify test passes consistently
- [ ] Verify agent removal works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-032
- **Dependencies**: 
  - TASK-032: Add tests for getAgentStatus and findAgentQueue
- **Important Considerations**: 
  - This is the first of 5 subtasks for TASK-033
- **Task Independence**: Can be completed independently after TASK-032
- **Current State**: Test file exists but may not have comprehensive removeAgent tests

## Related Tasks

- Parent: TASK-033 (Add tests for removeAgent and checkAndCleanupEmptyQueue)
- Next: TASK-033.2 (Test removeAgent - error handling)
- Dependencies:
  - TASK-032: Add tests for getAgentStatus and findAgentQueue
- Related:
  - TASK-033.2 through TASK-033.5: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `removeAgent` to verify job removal.

**Definition of Done**: "A test case is written that verifies `removeAgent` correctly removes repeatable and waiting/delayed jobs for an agent and calls `checkAndCleanupEmptyQueue`. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent removal works so that agents can be deleted correctly.
   - **Acceptance Criteria**: 
     - Test verifies repeatable and waiting/delayed jobs are removed
     - Test verifies cleanup is called
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('removeAgent', () => {
  it('should remove repeatable and waiting/delayed jobs for agent', async () => {
    // Arrange: Mock queue with jobs
    // Act: removeAgent('test')
    // Assert: Jobs removed, cleanup called
  });
});
```

- [ ] Test case written and passes
- [ ] Test verifies job removal

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add removeAgent job removal test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies job removal
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

