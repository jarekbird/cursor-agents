# TASK-046.3: Enhance MCP tests - get_agent_status JSON structure assertions

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.1.3
**Task ID**: TASK-046.3

## Description

Enhance the existing test for the `get_agent_status` MCP tool to add comprehensive JSON payload assertions. The test should verify that `content[0].text` is valid JSON and assert the exact structure (keys, types) for the get_agent_status tool, including all AgentStatus fields.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - `get_agent_status` tool handler
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The `get_agent_status` MCP tool:
- Gets status for specific agent
- Returns MCP response with `content[0].text` containing JSON
- JSON should contain: `name`, `isActive`, `targetUrl`, etc. (all AgentStatus fields)

The test file `tests/mcp/server.test.ts` exists with previous tests including TASK-046.1 and TASK-046.2.

**Important**: This task should be executed after TASK-046.2.

## Checklist

### Preparation and Setup

- [ ] Review `get_agent_status` tool handler implementation
- [ ] Understand AgentStatus interface structure
- [ ] Review test setup from previous subtasks

### Implementation Steps

- [ ] Step 1: Enhance existing get_agent_status test with JSON assertions
  - [ ] Find existing test for get_agent_status
  - [ ] Add JSON parsing: `const content = JSON.parse(response.content[0].text)`
  - [ ] Assert JSON contains: `name`, `isActive`, `targetUrl`, etc.
  - [ ] Assert all AgentStatus fields are present
  - [ ] Assert error structure when agent not found

### Specific Requirements

- [ ] Requirement 1: Test must verify JSON is valid
  - Acceptance: `content[0].text` parses as valid JSON
- [ ] Requirement 2: Test must verify structure
  - Acceptance: All required keys are present with correct types
- [ ] Requirement 3: Test must verify AgentStatus fields
  - Acceptance: All AgentStatus fields are present

### Error Handling and Edge Cases

- [ ] Assert error structure when agent not found
- [ ] Verify all status fields are present
- [ ] Test with various agent states

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining JSON structure assertions
- [ ] Document expected JSON schema for get_agent_status

### Verification

- [ ] Verify test passes consistently
- [ ] Verify JSON parsing works
- [ ] Verify structure assertions work
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after TASK-046.2
- **Dependencies**: 
  - TASK-046.2: Enhance MCP tests - list_agents JSON structure assertions
- **Important Considerations**: 
  - This is the third of 7 subtasks for TASK-046
- **Task Independence**: Can be completed independently after TASK-046.2
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-046 (Extend mcp/server.test.ts for JSON payload assertions)
- Previous: TASK-046.2 (Enhance MCP tests - list_agents JSON structure assertions)
- Next: TASK-046.4 (Enhance MCP tests - delete_agent JSON structure assertions)
- Dependencies:
  - TASK-046.2: Enhance MCP tests - list_agents JSON structure assertions
- Related:
  - TASK-046.1, TASK-046.2, TASK-046.4 through TASK-046.7: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves enhancing the get_agent_status MCP tool test with JSON structure assertions.

**Definition of Done**: "The get_agent_status MCP tool test is enhanced with JSON parsing and structure assertions. Test verifies exact JSON structure (all AgentStatus fields). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify JSON structure is correct so that MCP clients receive expected data.
   - **Acceptance Criteria**: 
     - Test verifies JSON is valid
     - Test verifies all AgentStatus fields are present
     - Test verifies types are correct

### Automated Tests

Test enhancements should include:

```typescript
describe('get_agent_status MCP tool', () => {
  it('should return valid JSON with complete AgentStatus', async () => {
    // Arrange & Act
    // Assert
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('name', expect.any(String));
    expect(content).toHaveProperty('isActive', expect.any(Boolean));
    expect(content).toHaveProperty('targetUrl', expect.any(String));
    // ... all AgentStatus fields
  });
});
```

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure

### Git Commit and Push Requirements

- [ ] Test enhancements added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance get_agent_status MCP tool with JSON structure assertions")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test enhancements

### Final Checklist

- [ ] Test enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

