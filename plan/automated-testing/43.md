# TASK-043: Add tests for /task-operator endpoints

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.6
**Task ID**: TASK-043

**NOTE**: This task has been split into granular subtasks:
- **TASK-043.1**: Add tests for POST /task-operator endpoint
- **TASK-043.2**: Add tests for DELETE /task-operator endpoint

Please execute the subtasks (43.1, 43.2) instead of this parent task.

## Description

Add test cases for the `/task-operator` endpoints (`POST /task-operator` and `DELETE /task-operator`) to verify they correctly enable/disable the task operator and handle various success and error scenarios.

**This task has been split into subtasks - see TASK-043.1 and TASK-043.2**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/task-operator` endpoints
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/task-operator` endpoints:
- `POST /task-operator`: Enables task operator by setting system setting and enqueueing one-time agent
- `DELETE /task-operator`: Disables task operator by setting system setting and removing agent

The test file `tests/app.test.ts` exists but may not have comprehensive `/task-operator` endpoint tests.

**Important**: This task should be executed after TASK-042.

## Checklist

### Preparation and Setup

- [ ] Review `/task-operator` endpoint implementations
- [ ] Understand `setSystemSetting` and `addOneTimeAgent` / `removeAgent` usage
- [ ] Review existing `app.test.ts` structure
- [ ] Understand task operator enable/disable flow

### Implementation Steps

- [ ] Step 1: Write tests for `POST /task-operator`
  - [ ] Create test: `it('should enable task operator successfully', async () => { ... })`
    - [ ] Arrange: Mock `setSystemSetting` to return `true`, `addOneTimeAgent` to return job
    - [ ] Act: POST `/task-operator`
    - [ ] Assert: 200, success JSON with agent info
  - [ ] Create test: `it('should still succeed when setSystemSetting returns false', async () => { ... })`
    - [ ] Arrange: `setSystemSetting` returns `false` but `addOneTimeAgent` succeeds
    - [ ] Act: POST `/task-operator`
    - [ ] Assert: 200, warning logged
  - [ ] Create test: `it('should return 500 when addOneTimeAgent throws', async () => { ... })`
    - [ ] Arrange: `addOneTimeAgent` throws
    - [ ] Act: POST `/task-operator`
    - [ ] Assert: 500, error "Failed to enqueue task operator"
- [ ] Step 2: Write tests for `DELETE /task-operator`
  - [ ] Create test: `it('should disable task operator successfully', async () => { ... })`
    - [ ] Arrange: `setSystemSetting` returns `true`, `removeAgent` resolves
    - [ ] Act: DELETE `/task-operator`
    - [ ] Assert: 200, success JSON
  - [ ] Create test: `it('should handle removeAgent not found error', async () => { ... })`
    - [ ] Arrange: `removeAgent` throws "not found" error (should be ignored)
    - [ ] Act: DELETE `/task-operator`
    - [ ] Assert: 200, success (error ignored)
  - [ ] Create test: `it('should return 500 when setSystemSetting returns false', async () => { ... })`
    - [ ] Arrange: `setSystemSetting` returns `false`
    - [ ] Act: DELETE `/task-operator`
    - [ ] Assert: 500, error "Failed to disable task operator", `removeAgent` not called

### Specific Requirements

- [ ] Requirement 1: Test must verify POST success cases
  - Acceptance: Task operator is enabled successfully
- [ ] Requirement 2: Test must verify POST error handling
  - Acceptance: Errors return 500 with descriptive message
- [ ] Requirement 3: Test must verify DELETE success cases
  - Acceptance: Task operator is disabled successfully
- [ ] Requirement 4: Test must verify DELETE error handling
  - Acceptance: Errors return 500, not found errors are ignored

### Error Handling and Edge Cases

- [ ] Handle case where setSystemSetting fails but addOneTimeAgent succeeds
- [ ] Handle case where removeAgent throws "not found" (should be ignored)
- [ ] Verify warning logging when setSystemSetting returns false
- [ ] Test with various error types

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining task operator enable/disable flow
- [ ] Document why setSystemSetting false is handled differently in POST vs DELETE
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify enable/disable works correctly
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-042
- **Dependencies**: 
  - TASK-042: Add tests for /agents endpoints
- **Important Considerations**: 
  - POST endpoint enables task operator and enqueues agent
  - DELETE endpoint disables task operator and removes agent
  - setSystemSetting false in POST is warning, in DELETE is error
  - removeAgent "not found" error should be ignored (agent may not exist)
  - Error messages must match implementation exactly
- **Task Independence**: Can be completed independently after TASK-042
- **Current State**: Test file exists but may not have comprehensive /task-operator endpoint tests

## Related Tasks

- Previous: TASK-042 (Add tests for /agents endpoints)
- Next: TASK-044 (Add tests for /task-operator/lock endpoints)
- Dependencies:
  - TASK-042: Add tests for /agents endpoints
- Related:
  - TASK-044, TASK-045: Will add more task-operator endpoint tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `/task-operator` endpoints.

**Definition of Done**: "Test cases are added that verify `POST /task-operator` and `DELETE /task-operator` correctly enable/disable task operator, handle various success scenarios, and handle errors gracefully. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify task operator enablement works so that task processing can be started.
   - **Acceptance Criteria**: 
     - Test verifies task operator is enabled successfully
     - Test verifies agent is enqueued
     - Test passes consistently

2. **As a developer**, I want to verify task operator disablement works so that task processing can be stopped.
   - **Acceptance Criteria**:
     - Test verifies task operator is disabled successfully
     - Test verifies agent is removed
     - Test verifies not found errors are ignored

### Automated Tests

Test cases should include:

```typescript
describe('POST /task-operator', () => {
  it('should enable task operator successfully', async () => {
    // Arrange: setSystemSetting returns true, addOneTimeAgent returns job
    // Act: POST /task-operator
    // Assert: 200, success JSON with agent info
  });
  
  it('should still succeed when setSystemSetting returns false', async () => {
    // Arrange: setSystemSetting false, addOneTimeAgent succeeds
    // Act & Assert: 200, warning logged
  });
  
  it('should return 500 when addOneTimeAgent throws', async () => {
    // Arrange: addOneTimeAgent throws
    // Act & Assert: 500, "Failed to enqueue task operator"
  });
});

describe('DELETE /task-operator', () => {
  it('should disable task operator successfully', async () => {
    // Arrange: setSystemSetting true, removeAgent resolves
    // Act: DELETE /task-operator
    // Assert: 200, success
  });
  
  it('should handle removeAgent not found error', async () => {
    // Arrange: removeAgent throws "not found"
    // Act & Assert: 200, error ignored
  });
  
  it('should return 500 when setSystemSetting returns false', async () => {
    // Arrange: setSystemSetting false
    // Act & Assert: 500, "Failed to disable task operator"
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify enable/disable functionality
- [ ] Tests verify error handling
- [ ] Tests verify edge cases

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /task-operator endpoints tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify enable/disable
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
