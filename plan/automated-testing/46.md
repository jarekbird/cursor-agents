# TASK-046: Extend mcp/server.test.ts for JSON payload assertions

**Section**: 6. MCP Server Black-box Tests
**Subsection**: 6.1
**Task ID**: TASK-046

**NOTE**: This task has been split into granular subtasks:
- **TASK-046.1**: Enhance MCP tests - create_agent JSON structure assertions
- **TASK-046.2**: Enhance MCP tests - list_agents JSON structure assertions
- **TASK-046.3**: Enhance MCP tests - get_agent_status JSON structure assertions
- **TASK-046.4**: Enhance MCP tests - delete_agent JSON structure assertions
- **TASK-046.5**: Enhance MCP tests - list_queues JSON structure assertions
- **TASK-046.6**: Enhance MCP tests - get_queue_info JSON structure assertions
- **TASK-046.7**: Enhance MCP tests - delete_queue JSON structure assertions

Please execute the subtasks (46.1, 46.2, 46.3, 46.4, 46.5, 46.6, 46.7) instead of this parent task.

## Description

Extend the existing `tests/mcp/server.test.ts` file to add comprehensive JSON payload assertions for all MCP tool handlers. The tests should verify that `content[0].text` is valid JSON and assert the exact structure (keys, types, and important messages) for each tool, not just the presence of content.

**This task has been split into subtasks - see TASK-046.1 through TASK-046.7**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/mcp/server.ts` - MCP tool handlers
- `virtual-assistant/cursor-agents/tests/mcp/server.test.ts` - existing test structure

## Current State

The MCP server implements tools:
- `create_agent`: Creates one-time or recurring agents
- `list_agents`: Lists all agents
- `get_agent_status`: Gets status for specific agent
- `delete_agent`: Deletes an agent
- `list_queues`: Lists all queues
- `get_queue_info`: Gets info for specific queue
- `delete_queue`: Deletes a queue

Each tool returns MCP response with `content[0].text` containing JSON.

The test file `tests/mcp/server.test.ts` already exists with some tests but may not have comprehensive JSON structure assertions.

**Important**: This task should be executed after Phase 5 (TASK-038 through TASK-045).

## Checklist

### Preparation and Setup

- [ ] Review all MCP tool handler implementations
- [ ] Understand MCP response format (`content[0].text` as JSON)
- [ ] Review existing `mcp/server.test.ts` structure
- [ ] Understand expected JSON structures for each tool

### Implementation Steps

- [ ] Step 1: Enhance existing tests with JSON assertions
  - [ ] For each tool test, add JSON parsing and structure assertions
  - [ ] Parse `content[0].text` as JSON
  - [ ] Assert exact keys and types
  - [ ] Assert important message strings
- [ ] Step 2: Write comprehensive assertions for `create_agent`
  - [ ] Assert JSON contains: `success`, `agentName`, `jobId` (or similar)
  - [ ] Assert types are correct
  - [ ] Assert error structure when creation fails
- [ ] Step 3: Write comprehensive assertions for `list_agents`
  - [ ] Assert JSON contains: `agents` array
  - [ ] Assert agent objects have required fields
  - [ ] Assert array structure is correct
- [ ] Step 4: Write comprehensive assertions for `get_agent_status`
  - [ ] Assert JSON contains: `name`, `isActive`, `targetUrl`, etc.
  - [ ] Assert all AgentStatus fields are present
  - [ ] Assert error structure when agent not found
- [ ] Step 5: Write comprehensive assertions for remaining tools
  - [ ] `delete_agent`: Assert success/error structure
  - [ ] `list_queues`: Assert queues array structure
  - [ ] `get_queue_info`: Assert queue info structure
  - [ ] `delete_queue`: Assert success/error structure

### Specific Requirements

- [ ] Requirement 1: Test must verify JSON is valid
  - Acceptance: `content[0].text` parses as valid JSON
- [ ] Requirement 2: Test must verify structure
  - Acceptance: All required keys are present with correct types
- [ ] Requirement 3: Test must verify important messages
  - Acceptance: Error messages, success messages are correct
- [ ] Requirement 4: Test must cover all tools
  - Acceptance: All 7 tools have comprehensive JSON assertions

### Error Handling and Edge Cases

- [ ] Handle case where JSON is malformed (shouldn't happen but test edge case)
- [ ] Verify error JSON structures are consistent
- [ ] Test with various response scenarios
- [ ] Verify type assertions are strict

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining JSON structure assertions
- [ ] Document expected JSON schemas
- [ ] Note any JSON structure variations

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify JSON parsing works
- [ ] Verify structure assertions work
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 6 â€“ MCP Server Black-box Tests**
- **Execution Timing**: Should be executed after Phase 5 (TASK-038 through TASK-045)
- **Dependencies**: 
  - TASK-038 through TASK-045: Phase 5 HTTP/API tests
- **Important Considerations**: 
  - JSON structure assertions ensure MCP clients receive expected data
  - Type assertions prevent regressions
  - Error message assertions ensure user-friendly errors
  - Existing test file should be enhanced, not replaced
  - All 7 tools must have comprehensive assertions
- **Task Independence**: Can be completed independently after Phase 5
- **Current State**: Test file exists but may not have comprehensive JSON structure assertions

## Related Tasks

- Previous: TASK-045 (Add tests for /task-operator/callback endpoint) - Completes Phase 5
- Next: TASK-047 (Add tests for queue-related MCP tools)
- Dependencies:
  - TASK-038 through TASK-045: Phase 5 tests
- Related:
  - TASK-047 through TASK-049: Will add more MCP tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves extending existing MCP tests with comprehensive JSON payload assertions.

**Definition of Done**: "All MCP tool tests are enhanced with JSON parsing and structure assertions. Tests verify exact JSON structure (keys, types, messages) for all 7 tools. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify JSON structure is correct so that MCP clients receive expected data.
   - **Acceptance Criteria**: 
     - Test verifies JSON is valid
     - Test verifies all required keys are present
     - Test verifies types are correct

2. **As a developer**, I want to verify error messages are correct so that users see helpful errors.
   - **Acceptance Criteria**:
     - Test verifies error JSON structure
     - Test verifies error messages are descriptive

### Automated Tests

Test enhancements should include:

```typescript
describe('MCP tools - JSON structure', () => {
  it('create_agent should return valid JSON with correct structure', async () => {
    // Arrange: Mock successful agent creation
    // Act: Call create_agent tool
    // Assert
    const response = await toolHandler(...);
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('success', true);
    expect(content).toHaveProperty('agentName', expect.any(String));
    expect(content).toHaveProperty('jobId', expect.any(String));
    expect(typeof content.agentName).toBe('string');
  });
  
  it('list_agents should return valid JSON with agents array', async () => {
    // Arrange & Act
    // Assert
    const content = JSON.parse(response.content[0].text);
    expect(content).toHaveProperty('agents', expect.any(Array));
    content.agents.forEach(agent => {
      expect(agent).toHaveProperty('name');
      expect(agent).toHaveProperty('isActive');
    });
  });
  
  // Similar assertions for all 7 tools
});
```

- [ ] All tool tests enhanced with JSON assertions
- [ ] Tests verify JSON validity
- [ ] Tests verify structure for all tools
- [ ] Tests verify error structures

### Git Commit and Push Requirements

- [ ] Test enhancements added to `tests/mcp/server.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: enhance MCP tests with JSON structure assertions")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test enhancements

### Final Checklist

- [ ] All tool tests enhanced with JSON assertions
- [ ] Tests verify JSON validity and structure
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
