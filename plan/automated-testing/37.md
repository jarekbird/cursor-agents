# TASK-037: Add tests for task-operator internal jobs

**Section**: 4. PromptProcessor Enhancements
**Subsection**: 4.3
**Task ID**: TASK-037

**NOTE**: This task has been split into granular subtasks:
- **TASK-037.1**: Test task-operator internal jobs - disabled case
- **TASK-037.2**: Test task-operator internal jobs - processed task case (5000ms delay)
- **TASK-037.3**: Test task-operator internal jobs - no tasks/lock held case (5000ms delay)
- **TASK-037.4**: Test task-operator internal jobs - error case (10000ms delay)
- **TASK-037.5**: Test task-operator internal jobs - addDelayedAgent returns null

Please execute the subtasks (37.1, 37.2, 37.3, 37.4, 37.5) instead of this parent task.

## Description

Add comprehensive test cases for task-operator internal jobs processing. The tests should verify all scenarios: task operator disabled, processed task, no tasks/lock held, error in processNextTask, and addDelayedAgent returns null. The tests should verify correct delays and re-enqueueing behavior.

**This task has been split into subtasks - see TASK-037.1 through TASK-037.5**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/prompt-processor.ts` - task-operator internal job handling
- `virtual-assistant/cursor-agents/tests/queue/prompt-processor.test.ts` - existing test structure

## Current State

The `PromptProcessor.process()` method:
- Detects task-operator internal jobs via `targetUrl: 'task-operator://internal'`
- Checks if task operator is enabled via `TaskOperatorService.isTaskOperatorEnabled()`
- If disabled: no processing, no re-enqueue
- If enabled: calls `TaskOperatorService.processNextTask()`
- Based on result, re-enqueues with appropriate delay:
  - Processed: ~5000ms delay
  - No tasks/lock held: ~5000ms delay
  - Error: ~10000ms delay
- If `addDelayedAgent` returns null, logs skip

The test file `tests/queue/prompt-processor.test.ts` exists with previous tests.

**Important**: This task should be executed after TASK-036, completing Phase 4.

## Checklist

### Preparation and Setup

- [ ] Review `PromptProcessor.process()` task-operator handling
- [ ] Understand `TaskOperatorService.processNextTask()` return values
- [ ] Review delay logic (5000ms vs 10000ms)
- [ ] Understand `addDelayedAgent` return value handling

### Implementation Steps

- [ ] Step 1: Write test for task operator disabled
  - [ ] Create test: `it('should not process when task operator is disabled', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Job with `targetUrl: 'task-operator://internal'`
    - [ ] Mock `isTaskOperatorEnabled` to return `false`
    - [ ] Set up spies on `processNextTask` and `addDelayedAgent`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `processNextTask` not called
    - [ ] `addDelayedAgent` not called
- [ ] Step 2: Write test for processed task
  - [ ] Create test: `it('should re-enqueue with 5000ms delay when task is processed', async () => { ... })`
  - [ ] Arrange: 
    - [ ] `isTaskOperatorEnabled` returns `true`
    - [ ] `processNextTask` returns `{ processed: true, taskId: 1 }`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with delay ~5000ms
- [ ] Step 3: Write test for no tasks/lock held
  - [ ] Create test: `it('should re-enqueue with 5000ms delay when no tasks or lock held', async () => { ... })`
  - [ ] Arrange: 
    - [ ] `processNextTask` returns `{ processed: false, reason: 'no_tasks' }` or `'lock_held'`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with delay ~5000ms
- [ ] Step 4: Write test for error in processNextTask
  - [ ] Create test: `it('should re-enqueue with 10000ms delay when processNextTask throws', async () => { ... })`
  - [ ] Arrange: 
    - [ ] `processNextTask` throws error
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] `addDelayedAgent` called with delay ~10000ms
    - [ ] Error is logged
- [ ] Step 5: Write test for addDelayedAgent returns null
  - [ ] Create test: `it('should log skip when addDelayedAgent returns null', async () => { ... })`
  - [ ] Arrange: 
    - [ ] `addDelayedAgent` returns `null`
  - [ ] Act: Call `promptProcessor.process(job)`
  - [ ] Assert: 
    - [ ] Skip message logged

### Specific Requirements

- [ ] Requirement 1: Test must verify disabled case
  - Acceptance: No processing when task operator disabled
- [ ] Requirement 2: Test must verify processed task case
  - Acceptance: Re-enqueue with 5000ms delay
- [ ] Requirement 3: Test must verify no tasks/lock held case
  - Acceptance: Re-enqueue with 5000ms delay
- [ ] Requirement 4: Test must verify error case
  - Acceptance: Re-enqueue with 10000ms delay, error logged
- [ ] Requirement 5: Test must verify addDelayedAgent null case
  - Acceptance: Skip message logged

### Error Handling and Edge Cases

- [ ] Handle case where processNextTask returns unexpected result
- [ ] Verify delay values are approximately correct (allow small variance)
- [ ] Test with various processNextTask return values
- [ ] Verify logging occurs correctly

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining task-operator internal job flow
- [ ] Document delay logic (5000ms vs 10000ms)
- [ ] Note skip behavior when addDelayedAgent returns null

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify all scenarios are covered
- [ ] Verify delay logic works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 4 â€“ PromptProcessor Enhancements**
- **Execution Timing**: Should be executed after TASK-036 (completes Phase 4)
- **Dependencies**: 
  - TASK-036: Add tests for no re-enqueue conditions
- **Important Considerations**: 
  - Task-operator internal jobs use special `targetUrl: 'task-operator://internal'`
  - Delay of 5000ms for normal cases, 10000ms for errors
  - Re-enqueueing ensures task operator keeps checking for work
  - Skip logging when addDelayedAgent returns null (e.g., task-operator has existing jobs)
  - Requires mocking both QueueManager and TaskOperatorService
- **Task Independence**: Can be completed independently after TASK-036
- **Current State**: Test file exists with previous tests

## Related Tasks

- Previous: TASK-036 (Add tests for no re-enqueue conditions)
- Next: TASK-038 (Extend app.test.ts for Bull Board base path) - Starts Phase 5
- Dependencies:
  - TASK-036: Add tests for no re-enqueue conditions
- Related:
  - TASK-018 through TASK-027: Tested TaskOperatorService.processNextTask
  - TASK-035, TASK-036: Tested re-enqueueing logic

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding comprehensive test cases for task-operator internal jobs processing.

**Definition of Done**: "Test cases are added that verify all task-operator internal job scenarios: disabled, processed task, no tasks/lock held, error, and addDelayedAgent returns null. Tests verify correct delays and re-enqueueing behavior. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify task-operator processing works so that tasks are processed correctly.
   - **Acceptance Criteria**: 
     - Test verifies all scenarios are handled
     - Test verifies correct delays are used
     - Test passes consistently

2. **As a developer**, I want to verify re-enqueueing works so that task operator keeps checking for work.
   - **Acceptance Criteria**:
     - Test verifies re-enqueue occurs with correct delays
     - Test verifies skip is logged when addDelayedAgent returns null

### Automated Tests

Test cases should include:

```typescript
describe('task-operator internal jobs', () => {
  it('should not process when task operator is disabled', async () => {
    // Arrange: isTaskOperatorEnabled returns false
    // Act & Assert: No calls to processNextTask or addDelayedAgent
  });
  
  it('should re-enqueue with 5000ms delay when task is processed', async () => {
    // Arrange: processNextTask returns { processed: true }
    // Act & Assert: addDelayedAgent called with delay ~5000ms
  });
  
  it('should re-enqueue with 5000ms delay when no tasks or lock held', async () => {
    // Arrange: processNextTask returns { processed: false, reason: 'no_tasks' }
    // Act & Assert: addDelayedAgent called with delay ~5000ms
  });
  
  it('should re-enqueue with 10000ms delay when processNextTask throws', async () => {
    // Arrange: processNextTask throws
    // Act & Assert: addDelayedAgent called with delay ~10000ms, error logged
  });
  
  it('should log skip when addDelayedAgent returns null', async () => {
    // Arrange: addDelayedAgent returns null
    // Act & Assert: Skip message logged
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests cover all scenarios
- [ ] Tests verify delay logic
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/queue/prompt-processor.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add task-operator internal jobs comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover all scenarios
- [ ] Tests verify delay logic
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 4 (PromptProcessor Enhancements) is complete**
