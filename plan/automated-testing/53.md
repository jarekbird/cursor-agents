# TASK-053: Add E2E-lite entrypoint tests (optional but recommended)

**Section**: 7. Integration & E2E-lite Scenarios
**Subsection**: 7.4
**Task ID**: TASK-053

## Description

Add E2E-lite tests for application entrypoints using `child_process.spawn`. The tests should verify that `src/index.js` (main app) and `src/mcp/index.js` (MCP server) start correctly, log startup messages, and shut down gracefully on SIGTERM/SIGINT. These tests should be in a dedicated suite gated by `test:e2e-lite`.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/index.ts` - main app entrypoint
- `virtual-assistant/cursor-agents/src/mcp/index.ts` - MCP server entrypoint
- Create new file: `tests/e2e/entrypoints.test.ts`

## Current State

The application has two entrypoints:
- `src/index.ts` (compiled to `dist/index.js`): Main Express app
- `src/mcp/index.ts` (compiled to `dist/mcp/index.js`): MCP server

No E2E-lite entrypoint tests currently exist. The `tests/e2e/` directory may not exist.

**Important**: This task should be executed after TASK-052. This is optional but recommended.

## Checklist

### Preparation and Setup

- [ ] Review entrypoint implementations
- [ ] Understand `child_process.spawn` usage
- [ ] Understand how to detect startup logs
- [ ] Understand graceful shutdown behavior
- [ ] Review Jest configuration for E2E tests

### Implementation Steps

- [ ] Step 1: Create E2E test directory and file
  - [ ] Create `tests/e2e/` directory if it doesn't exist
  - [ ] Create `tests/e2e/entrypoints.test.ts`
  - [ ] Set up test structure with `child_process` imports
- [ ] Step 2: Write test for main app entrypoint
  - [ ] Create test: `it('should start main app and shut down gracefully', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Set up environment variables (Redis URL, etc.)
      - [ ] Build project if needed (`npm run build`)
    - [ ] Act: 
      - [ ] Spawn `node dist/index.js`
      - [ ] Wait for startup log (e.g., "Server listening on port...")
      - [ ] Send SIGTERM
    - [ ] Assert: 
      - [ ] Process exits with code 0
      - [ ] Startup log was present
- [ ] Step 3: Write test for MCP server entrypoint
  - [ ] Create test: `it('should start MCP server and handle Redis failure', async () => { ... })`
    - [ ] Arrange: 
      - [ ] Set invalid Redis URL to test failure handling
    - [ ] Act: 
      - [ ] Spawn `node dist/mcp/index.js`
      - [ ] Wait for log or exit
    - [ ] Assert: 
      - [ ] Process logs startup or logs error and exits
      - [ ] Exit code is appropriate

### Specific Requirements

- [ ] Requirement 1: Test must verify startup
  - Acceptance: Entrypoints start and log startup messages
- [ ] Requirement 2: Test must verify graceful shutdown
  - Acceptance: SIGTERM/SIGINT cause clean exit (code 0)
- [ ] Requirement 3: Test must verify error handling
  - Acceptance: Entrypoints handle errors gracefully
- [ ] Requirement 4: Test must be gated by test:e2e-lite
  - Acceptance: Tests only run with `npm run test:e2e-lite`

### Error Handling and Edge Cases

- [ ] Handle case where entrypoint fails to start
- [ ] Handle case where startup log doesn't appear
- [ ] Verify timeout handling for startup detection
- [ ] Test with various environment configurations

### Testing

- [ ] Run `npm run test:e2e-lite` to verify tests execute
- [ ] Verify all test cases pass
- [ ] Verify tests are skipped with regular test commands
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining E2E-lite approach
- [ ] Document why entrypoint tests are important
- [ ] Note test execution requirements (build, etc.)

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify startup detection works
- [ ] Verify graceful shutdown works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 7 â€“ Integration & E2E-lite Scenarios**
- **Execution Timing**: Should be executed after TASK-052 (completes Phase 7)
- **Dependencies**: 
  - TASK-052: Add failure-injection integration tests
- **Important Considerations**: 
  - E2E-lite tests verify actual process behavior
  - Entrypoint tests ensure applications start correctly
  - Graceful shutdown tests ensure clean process termination
  - Tests should be gated to avoid slowing down regular test runs
  - May require project to be built before running tests
  - Timeout handling is important for startup detection
- **Task Independence**: Can be completed independently after TASK-052
- **Current State**: E2E test directory and file do not exist

## Related Tasks

- Previous: TASK-052 (Add failure-injection integration tests)
- Next: TASK-054 (Measure coverage and identify remaining gaps) - Starts Phase 8
- Dependencies:
  - TASK-052: Add failure-injection integration tests
- Related:
  - TASK-054: Will analyze test coverage

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding E2E-lite tests for application entrypoints.

**Definition of Done**: "E2E-lite entrypoint tests are added that verify main app and MCP server start correctly, log startup messages, and shut down gracefully on SIGTERM/SIGINT. Tests are in dedicated suite gated by test:e2e-lite. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify entrypoints start correctly so that applications can be launched.
   - **Acceptance Criteria**: 
     - Test verifies entrypoints start and log startup
     - Test verifies graceful shutdown works
     - Test passes consistently

2. **As a developer**, I want to verify error handling works so that entrypoints fail gracefully.
   - **Acceptance Criteria**:
     - Test verifies entrypoints handle startup errors
     - Test verifies error logging occurs

### Automated Tests

Test cases should include:

```typescript
describe('Entrypoint E2E-lite', () => {
  it('should start main app and shut down gracefully', async () => {
    // Arrange: Build project, set env vars
    const child = spawn('node', ['dist/index.js'], {
      env: { ...process.env, REDIS_URL: 'redis://localhost:6379/0' },
    });
    
    // Wait for startup log
    await waitForLog(child, /Server listening|Application started/);
    
    // Act: Send SIGTERM
    child.kill('SIGTERM');
    
    // Assert: Exit code 0
    const exitCode = await new Promise((resolve) => {
      child.on('exit', resolve);
    });
    expect(exitCode).toBe(0);
  });
  
  it('should start MCP server and handle Redis failure', async () => {
    // Arrange: Invalid Redis URL
    // Act: Spawn MCP server
    // Assert: Logs error and exits or logs startup
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify startup
- [ ] Tests verify graceful shutdown
- [ ] Tests are gated by test:e2e-lite

### Git Commit and Push Requirements

- [ ] New test file `tests/e2e/entrypoints.test.ts` is created
- [ ] Commit message follows project conventions (e.g., "test: add E2E-lite entrypoint tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test file creation

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify entrypoint behavior
- [ ] Tests are properly gated
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **Phase 7 (Integration & E2E-lite Scenarios) is complete**
