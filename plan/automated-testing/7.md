# TASK-007: Test isSystemSettingEnabled behavior

**Section**: 1. DatabaseService Unit Tests
**Subsection**: 1.4
**Task ID**: TASK-007

**NOTE**: This task has been split into granular subtasks:
- **TASK-007.1**: Test isSystemSettingEnabled with value = 1 (returns true)
- **TASK-007.2**: Test isSystemSettingEnabled with value = 0 (returns false)
- **TASK-007.3**: Test isSystemSettingEnabled when setting missing (returns false)
- **TASK-007.4**: Test isSystemSettingEnabled when query fails (returns false, logs error)

Please execute the subtasks (7.1, 7.2, 7.3, 7.4) instead of this parent task.

## Description

Add comprehensive test cases for the `isSystemSettingEnabled` method to verify it correctly reads system settings from the database. The tests should cover all scenarios: setting exists with value 1 (true), setting exists with value 0 (false), setting missing, and error cases where the query fails.

**This task has been split into subtasks - see TASK-007.1 through TASK-007.4**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/database-service.ts` (lines 43-63) - `isSystemSettingEnabled()` method

## Current State

The `isSystemSettingEnabled` method:
- Queries `system_settings` table for a setting by name
- Returns `true` if `value = 1`, `false` if `value = 0` or missing
- Returns `false` on error (fail-closed behavior)
- Logs errors when queries fail

The test file `tests/services/database-service.test.ts` exists with connection tests from previous tasks.

**Important**: This task should be executed after TASK-004, TASK-005, TASK-006.

## Checklist

### Preparation and Setup

- [ ] Review `isSystemSettingEnabled` implementation
- [ ] Understand `system_settings` table schema
- [ ] Review SQLite table creation patterns for tests
- [ ] Understand how to create test data in SQLite

### Implementation Steps

- [ ] Step 1: Set up test database with schema
  - [ ] Create `system_settings` table in test database
  - [ ] Table should have: `name` (TEXT PRIMARY KEY), `value` (INTEGER)
  - [ ] Add helper function to create table if needed
- [ ] Step 2: Write test for setting present, value = 1
  - [ ] Create test: `it('should return true when setting exists with value 1', () => { ... })`
  - [ ] Arrange: Insert row with `name='test_setting'`, `value=1`
  - [ ] Act: Call `isSystemSettingEnabled('test_setting')`
  - [ ] Assert: Returns `true`
- [ ] Step 3: Write test for setting present, value = 0
  - [ ] Create test: `it('should return false when setting exists with value 0', () => { ... })`
  - [ ] Arrange: Insert row with `name='test_setting'`, `value=0`
  - [ ] Act: Call `isSystemSettingEnabled('test_setting')`
  - [ ] Assert: Returns `false`
- [ ] Step 4: Write test for setting missing
  - [ ] Create test: `it('should return false when setting does not exist', () => { ... })`
  - [ ] Arrange: Empty `system_settings` table (or no matching row)
  - [ ] Act: Call `isSystemSettingEnabled('non_existent')`
  - [ ] Assert: Returns `false` (no exception thrown)
- [ ] Step 5: Write test for query error
  - [ ] Create test: `it('should return false and log error when query fails', () => { ... })`
  - [ ] Arrange: Drop `system_settings` table or cause query to fail
  - [ ] Act: Call `isSystemSettingEnabled('test')`
  - [ ] Assert: Returns `false`, error is logged

### Specific Requirements

- [ ] Requirement 1: Test must verify value = 1 returns true
  - Acceptance: Setting with value 1 returns `true`
- [ ] Requirement 2: Test must verify value = 0 returns false
  - Acceptance: Setting with value 0 returns `false`
- [ ] Requirement 3: Test must verify missing setting returns false
  - Acceptance: Non-existent setting returns `false` without exception
- [ ] Requirement 4: Test must verify error handling
  - Acceptance: Query error returns `false` and logs error

### Error Handling and Edge Cases

- [ ] Handle case where table doesn't exist
- [ ] Handle case where multiple settings exist (shouldn't happen with PRIMARY KEY)
- [ ] Verify case-insensitive name matching (if applicable)
- [ ] Test with various setting names (special characters, etc.)

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify tests are isolated (don't affect each other)
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining test data setup
- [ ] Document why fail-closed behavior is important
- [ ] Note any edge cases covered

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify tests cover all scenarios
- [ ] Verify tests are properly isolated
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 1 â€“ DatabaseService Unit Tests**
- **Execution Timing**: Should be executed after TASK-004, TASK-005, TASK-006
- **Dependencies**: 
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005: Test database connection success
  - TASK-006: Test database connection failure
- **Important Considerations**: 
  - Use in-memory database for isolation
  - Create `system_settings` table schema in test setup
  - Mock logger if needed to verify error logging
  - Fail-closed behavior (returns false on error) is intentional for safety
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: Test file exists with connection tests

## Related Tasks

- Previous: TASK-006 (Test database connection failure)
- Next: TASK-008 (Test setSystemSetting happy path)
- Dependencies:
  - TASK-004: Create a new test file for DatabaseService
  - TASK-005: Test database connection success
  - TASK-006: Test database connection failure
- Related:
  - TASK-008: Will test setting system settings (write operations)

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing comprehensive test cases for the `isSystemSettingEnabled` method.

**Definition of Done**: "Test cases are written that verify `isSystemSettingEnabled` correctly handles all scenarios: setting with value 1 (true), setting with value 0 (false), missing setting (false), and query errors (false with logging). All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify system settings are read correctly so that feature flags work as expected.
   - **Acceptance Criteria**: 
     - Test verifies value 1 returns `true`
     - Test verifies value 0 returns `false`
     - Test verifies missing setting returns `false`

2. **As a developer**, I want to verify error handling works so that the system fails safely.
   - **Acceptance Criteria**:
     - Test verifies query errors return `false` (fail-closed)
     - Test verifies errors are logged for debugging

### Automated Tests

Test cases should include:

```typescript
describe('isSystemSettingEnabled', () => {
  it('should return true when setting exists with value 1', () => {
    // Arrange: Create table, insert setting with value 1
    // Act: Call isSystemSettingEnabled
    // Assert: Returns true
  });
  
  it('should return false when setting exists with value 0', () => {
    // Arrange: Insert setting with value 0
    // Act: Call isSystemSettingEnabled
    // Assert: Returns false
  });
  
  it('should return false when setting does not exist', () => {
    // Arrange: Empty table
    // Act: Call isSystemSettingEnabled
    // Assert: Returns false, no exception
  });
  
  it('should return false and log error when query fails', () => {
    // Arrange: Drop table or cause error
    // Act: Call isSystemSettingEnabled
    // Assert: Returns false, error logged
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests cover all scenarios
- [ ] Tests verify error logging
- [ ] Tests are properly isolated

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/services/database-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add isSystemSettingEnabled comprehensive tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover value 1, value 0, missing, and error cases
- [ ] Tests verify error logging
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
