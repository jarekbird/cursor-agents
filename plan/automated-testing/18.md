# TASK-018: Test lock acquisition failure in processNextTask

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.3
**Task ID**: TASK-018

## Description

Add a test case for the `processNextTask` method to verify it correctly handles the case where Redis lock acquisition fails (lock is held by another process). The test should verify that the method returns the appropriate result and logs the lock holder information.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `processNextTask()` method with lock acquisition logic

## Current State

The `processNextTask` method:
- Attempts to acquire a Redis lock using `SET` with NX and EX options
- If lock acquisition fails (returns non-'OK'), another process holds the lock
- Returns `{ processed: false, reason: 'lock_held' }`
- Logs information about the lock holder and TTL

The test file `tests/services/task-operator-service.test.ts` exists with basic structure from TASK-016.

**Important**: This task should be executed after TASK-016 and TASK-017.

## Checklist

### Preparation and Setup

- [ ] Review `processNextTask` lock acquisition implementation
- [ ] Understand Redis `SET` command with NX and EX options
- [ ] Review how to mock Redis `set` method
- [ ] Understand lock value format and TTL

### Implementation Steps

- [ ] Step 1: Set up Redis mock
  - [ ] Mock Redis instance or `ioredis` module
  - [ ] Create spy on `set` method
  - [ ] Configure `set` to return `null` or non-'OK' value (simulating lock held)
- [ ] Step 2: Set up logger mock
  - [ ] Mock logger module
  - [ ] Set up spy on `logger.info` or `logger.warn` to verify logging
- [ ] Step 3: Write test for lock acquisition failure
  - [ ] Create test: `it('should return lock_held when lock acquisition fails', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Create `TaskOperatorService` instance with mocked Redis
    - [ ] Mock Redis `set` to return `null` (lock held)
    - [ ] Optionally mock Redis `get` to return lock holder info
  - [ ] Act: Call `processNextTask()`
  - [ ] Assert: 
    - [ ] Result is `{ processed: false, reason: 'lock_held' }`
    - [ ] Logger was called with lock holder information
    - [ ] No database operations were performed

### Specific Requirements

- [ ] Requirement 1: Test must verify lock failure handling
  - Acceptance: Method returns `{ processed: false, reason: 'lock_held' }` when lock is held
- [ ] Requirement 2: Test must verify logging
  - Acceptance: Logger is called with lock holder and TTL information
- [ ] Requirement 3: Test must verify no processing occurs
  - Acceptance: No database queries or task processing occurs
- [ ] Requirement 4: Test must mock Redis correctly
  - Acceptance: Redis `set` returns non-'OK' value

### Error Handling and Edge Cases

- [ ] Handle case where Redis `set` returns `null`
- [ ] Handle case where Redis `set` throws an error
- [ ] Verify method doesn't attempt to process tasks when lock fails
- [ ] Test that lock holder info is logged correctly

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining lock acquisition failure scenario
- [ ] Document why lock holder info is logged
- [ ] Note any Redis mocking considerations

### Verification

- [ ] Verify test passes consistently
- [ ] Verify lock failure is handled correctly
- [ ] Verify logging occurs
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-016 and TASK-017
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-017: Test isTaskOperatorEnabled delegation
- **Important Considerations**: 
  - Redis `set` with NX returns `null` if key already exists (lock held)
  - Lock holder info may be retrieved via Redis `get` to log PID
  - This is a common scenario in distributed systems (multiple instances)
  - Method should fail fast when lock is held
- **Task Independence**: Can be completed independently after dependencies
- **Current State**: Test file exists with basic structure

## Related Tasks

- Previous: TASK-017 (Test isTaskOperatorEnabled delegation)
- Next: TASK-019 (Test processNextTask with no tasks available)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-017: Test isTaskOperatorEnabled delegation
- Related:
  - TASK-019 through TASK-027: Will test other processNextTask scenarios

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `processNextTask` when lock acquisition fails.

**Definition of Done**: "A test case is written that verifies `processNextTask` correctly handles lock acquisition failure by returning `{ processed: false, reason: 'lock_held' }` and logging lock holder information. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify lock failure handling works so that the system handles concurrent instances correctly.
   - **Acceptance Criteria**: 
     - Test verifies method returns lock_held when lock is held
     - Test verifies no processing occurs when lock fails
     - Test passes consistently

2. **As a developer**, I want to verify lock information is logged so that I can debug lock contention issues.
   - **Acceptance Criteria**:
     - Test verifies logger is called with lock holder info
     - Test verifies TTL information is logged

### Automated Tests

The test case should be:

```typescript
it('should return lock_held when lock acquisition fails', async () => {
  // Arrange: Mock Redis set to return null (lock held)
  const mockRedis = {
    set: jest.fn().mockResolvedValue(null), // Lock held
    get: jest.fn().mockResolvedValue('other-pid-12345'), // Lock holder
  };
  const service = TaskOperatorService.getInstance(mockRedis);
  
  // Act
  const result = await service.processNextTask();
  
  // Assert
  expect(result).toEqual({ processed: false, reason: 'lock_held' });
  expect(mockRedis.set).toHaveBeenCalled();
  // Verify logger was called with lock info
});
```

- [ ] Test case written and passes
- [ ] Test verifies lock failure handling
- [ ] Test verifies logging
- [ ] Test verifies no processing occurs

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add processNextTask lock acquisition failure test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies lock failure handling
- [ ] Test verifies logging
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
