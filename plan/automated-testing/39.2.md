# TASK-039.2: Test /admin/queues/refresh - error handling

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.2.2
**Task ID**: TASK-039.2

## Description

Add a test case for the `/admin/queues/refresh` endpoint to verify it correctly handles errors when refresh fails. The test should verify that the endpoint returns 500 with an error message.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/admin/queues/refresh` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/admin/queues/refresh` endpoint:
- Returns JSON: `{ error: 'Failed to refresh Bull Board' }` with status 500 on error

The test file `tests/app.test.ts` exists with previous tests including TASK-039.1.

**Important**: This task should be executed after TASK-039.1, completing TASK-039.

## Checklist

### Preparation and Setup

- [ ] Review `/admin/queues/refresh` endpoint error handling
- [ ] Understand how to force refresh to fail
- [ ] Review test setup from TASK-039.1

### Implementation Steps

- [ ] Step 1: Write test for error path
  - [ ] Create test: `it('should return 500 when refresh fails', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Force `updateBullBoard` to throw (via mock or temporary modification)
  - [ ] Act: POST to `/admin/queues/refresh`
  - [ ] Assert: 
    - [ ] Response status is 500
    - [ ] Response body is `{ error: 'Failed to refresh Bull Board' }`

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: Returns 500 with error message on failure
- [ ] Requirement 2: Test must verify error message
  - Acceptance: Error message is descriptive

### Error Handling and Edge Cases

- [ ] Handle case where queue manager is unavailable
- [ ] Verify error message is descriptive
- [ ] Test with various error types

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining error handling
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-039.1 (completes TASK-039)
- **Dependencies**: 
  - TASK-039.1: Test /admin/queues/refresh - successful refresh
- **Important Considerations**: 
  - Error handling ensures graceful failure
  - This is the second and final subtask for TASK-039
- **Task Independence**: Can be completed independently after TASK-039.1
- **Current State**: Test file exists with previous tests

## Related Tasks

- Parent: TASK-039 (Add tests for /admin/queues/refresh)
- Previous: TASK-039.1 (Test /admin/queues/refresh - successful refresh)
- Next: TASK-040 (Add tests for /queues/:queueName)
- Dependencies:
  - TASK-039.1: Test /admin/queues/refresh - successful refresh
- Related:
  - TASK-039.1: Other subtask

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `/admin/queues/refresh` error handling.

**Definition of Done**: "A test case is written that verifies `/admin/queues/refresh` correctly handles errors when refresh fails, returning 500 with error message. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that failures are handled gracefully.
   - **Acceptance Criteria**:
     - Test verifies 500 error is returned on failure
     - Test verifies error message is descriptive

### Automated Tests

The test case should be:

```typescript
describe('POST /admin/queues/refresh', () => {
  it('should return 500 when refresh fails', async () => {
    // Arrange: Force updateBullBoard to throw
    const app = new CursorAgentsApp();
    jest.spyOn(app, 'updateBullBoard').mockImplementation(() => {
      throw new Error('Refresh failed');
    });
    
    // Act
    const response = await request(app.getApp())
      .post('/admin/queues/refresh')
      .expect(500);
    
    // Assert
    expect(response.body).toEqual({
      error: 'Failed to refresh Bull Board',
    });
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test case added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add /admin/queues/refresh error handling test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
- [ ] **TASK-039 (all subtasks) is complete**

