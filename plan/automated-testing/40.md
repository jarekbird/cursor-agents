# TASK-040: Add tests for /queues/:queueName

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.3
**Task ID**: TASK-040

**NOTE**: This task has been split into granular subtasks:
- **TASK-040.1**: Add tests for GET /queues/:queueName - existing queue
- **TASK-040.2**: Add tests for GET /queues/:queueName - missing queue
- **TASK-040.3**: Add tests for GET /queues/:queueName - error handling

Please execute the subtasks (40.1, 40.2, 40.3) instead of this parent task.

## Description

Add test cases for the `GET /queues/:queueName` endpoint to verify it correctly returns queue information. The tests should verify existing queue (200 with queue info), missing queue (404), and error path (500).

**This task has been split into subtasks - see TASK-040.1 through TASK-040.3**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `GET /queues/:queueName` endpoint
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `GET /queues/:queueName` endpoint:
- Accepts GET requests with queue name parameter
- Calls `queueManager.getQueueInfo(queueName)`
- Returns 200 with queue info JSON when queue exists
- Returns 404 with message `Queue "<name>" not found` when queue doesn't exist
- Returns 500 with generic error JSON when `getQueueInfo` throws

The test file `tests/app.test.ts` exists but may not have comprehensive `/queues/:queueName` tests.

**Important**: This task should be executed after TASK-039.

## Checklist

### Preparation and Setup

- [ ] Review `GET /queues/:queueName` endpoint implementation
- [ ] Understand `getQueueInfo` method behavior
- [ ] Review existing `app.test.ts` structure
- [ ] Understand queue info structure

### Implementation Steps

- [ ] Step 1: Write test for existing queue
  - [ ] Create test: `it('should return queue info for existing queue', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `queueManager.getQueueInfo` to return sample queue object for `"q1"`
    - [ ] Create app instance
  - [ ] Act: GET `/queues/q1` using `supertest`
  - [ ] Assert: 
    - [ ] Response status is 200
    - [ ] Response body equals mock queue info
- [ ] Step 2: Write test for missing queue
  - [ ] Create test: `it('should return 404 when queue is not found', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `getQueueInfo` to return `null`
  - [ ] Act: GET `/queues/q1`
  - [ ] Assert: 
    - [ ] Response status is 404
    - [ ] Response body contains message `Queue "q1" not found`
- [ ] Step 3: Write test for error path
  - [ ] Create test: `it('should return 500 when getQueueInfo throws', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock `getQueueInfo` to throw error
  - [ ] Act: GET `/queues/q1`
  - [ ] Assert: 
    - [ ] Response status is 500
    - [ ] Response body contains error JSON

### Specific Requirements

- [ ] Requirement 1: Test must verify existing queue handling
  - Acceptance: Returns 200 with queue info
- [ ] Requirement 2: Test must verify missing queue handling
  - Acceptance: Returns 404 with descriptive message
- [ ] Requirement 3: Test must verify error handling
  - Acceptance: Returns 500 with error JSON
- [ ] Requirement 4: Test must verify queue name parameter
  - Acceptance: Queue name is passed correctly to `getQueueInfo`

### Error Handling and Edge Cases

- [ ] Handle case where queue name contains special characters
- [ ] Handle case where queue name is empty
- [ ] Verify error messages are descriptive
- [ ] Test with various queue info structures

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining queue info endpoint
- [ ] Document queue info structure
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify queue info retrieval works
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-039
- **Dependencies**: 
  - TASK-039: Add tests for /admin/queues/refresh
- **Important Considerations**: 
  - Queue info endpoint provides visibility into queue state
  - 404 response should be descriptive
  - Error handling ensures graceful failure
  - Queue name parameter must be validated
- **Task Independence**: Can be completed independently after TASK-039
- **Current State**: Test file exists but may not have comprehensive queue info tests

## Related Tasks

- Previous: TASK-039 (Add tests for /admin/queues/refresh)
- Next: TASK-041 (Add tests for /queues/:queueName DELETE)
- Dependencies:
  - TASK-039: Add tests for /admin/queues/refresh
- Related:
  - TASK-041: Will test queue deletion endpoint

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding test cases for the `GET /queues/:queueName` endpoint.

**Definition of Done**: "Test cases are added that verify `GET /queues/:queueName` correctly returns queue info for existing queues (200), returns 404 for missing queues, and handles errors gracefully (500). All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue info retrieval works so that queue state can be inspected.
   - **Acceptance Criteria**: 
     - Test verifies existing queue returns 200 with info
     - Test verifies missing queue returns 404
     - Test passes consistently

2. **As a developer**, I want to verify error handling works so that failures are handled gracefully.
   - **Acceptance Criteria**:
     - Test verifies 500 error is returned on failure
     - Test verifies error message is descriptive

### Automated Tests

Test cases should include:

```typescript
describe('GET /queues/:queueName', () => {
  it('should return queue info for existing queue', async () => {
    // Arrange: Mock getQueueInfo to return queue object
    const mockQueueInfo = { name: 'q1', waiting: 5, active: 2 };
    mockQueueManager.getQueueInfo.mockReturnValue(mockQueueInfo);
    
    // Act
    const response = await request(app.getApp())
      .get('/queues/q1')
      .expect(200);
    
    // Assert
    expect(response.body).toEqual(mockQueueInfo);
  });
  
  it('should return 404 when queue is not found', async () => {
    // Arrange: getQueueInfo returns null
    // Act: GET /queues/q1
    // Assert: 404, message "Queue \"q1\" not found"
  });
  
  it('should return 500 when getQueueInfo throws', async () => {
    // Arrange: getQueueInfo throws
    // Act: GET /queues/q1
    // Assert: 500, error JSON
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests verify existing queue handling
- [ ] Tests verify missing queue handling
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add GET /queues/:queueName endpoint tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests verify queue info retrieval
- [ ] Tests verify error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
