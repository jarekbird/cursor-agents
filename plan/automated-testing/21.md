# TASK-021: Test conversation creation failure

**Section**: 2. TaskOperatorService Unit Tests
**Subsection**: 2.6
**Task ID**: TASK-021

## Description

Add a test case for the `processNextTask` method to verify it correctly handles the case where conversation creation fails. The test should verify that when `createNewConversation()` fails (after retries), the task status is reset to ready, the lock is released, and an error result is returned.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/services/task-operator-service.ts` - `processNextTask()` method with conversation creation error handling

## Current State

The `processNextTask` method:
- Attempts to create a conversation via cursor-runner API
- Retries conversation creation on failure (typically 2 attempts)
- If conversation creation fails after retries, resets task status to ready
- Releases the lock
- Returns `{ processed: false, reason: 'error' }`

The test file `tests/services/task-operator-service.test.ts` exists with previous tests including TASK-020.

**Important**: This task should be executed after TASK-020 (test happy path).

## Checklist

### Preparation and Setup

- [ ] Review `processNextTask` conversation creation error handling
- [ ] Understand retry logic for conversation creation
- [ ] Review how task status is reset on failure
- [ ] Understand lock release on error

### Implementation Steps

- [ ] Step 1: Set up mocks for failure scenario
  - [ ] Mock Redis `set` to return `'OK'` (lock acquired)
  - [ ] Mock `DatabaseService.getNextReadyTask` to return sample task
  - [ ] Mock `DatabaseService.updateTaskStatus` for both IN_PROGRESS and reset to ready
  - [ ] Mock `fetch` for conversation creation to fail (return error or non-OK status)
- [ ] Step 2: Write test for conversation creation failure
  - [ ] Create test: `it('should reset task to ready and release lock when conversation creation fails', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Sample task with `id=1`, `status=0` (ready)
    - [ ] Mock conversation creation to fail twice (retry logic)
    - [ ] Mock `updateTaskStatus` to track calls
  - [ ] Act: Call `processNextTask()`
  - [ ] Assert: 
    - [ ] Result is `{ processed: false, reason: 'error' }`
    - [ ] Task status was set to IN_PROGRESS first
    - [ ] Task status was reset to ready (STATUS_READY = 0)
    - [ ] Lock was released
    - [ ] Conversation creation was attempted (with retries)

### Specific Requirements

- [ ] Requirement 1: Test must verify error handling
  - Acceptance: Method returns `{ processed: false, reason: 'error' }` when conversation creation fails
- [ ] Requirement 2: Test must verify task status reset
  - Acceptance: Task status is reset to ready after failure
- [ ] Requirement 3: Test must verify lock release
  - Acceptance: Lock is released when conversation creation fails
- [ ] Requirement 4: Test must verify retry logic
  - Acceptance: Conversation creation is attempted multiple times before failing

### Error Handling and Edge Cases

- [ ] Handle case where conversation creation fails on first attempt
- [ ] Handle case where conversation creation fails on retry
- [ ] Verify task status is reset even if update fails
- [ ] Test that no pending task entry is created

### Testing

- [ ] Run `npm run test:unit` to verify test executes
- [ ] Verify test passes consistently
- [ ] Verify all mocks are called correctly
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining conversation creation failure scenario
- [ ] Document why task is reset to ready
- [ ] Note retry logic behavior

### Verification

- [ ] Verify test passes consistently
- [ ] Verify error handling works correctly
- [ ] Verify task status reset works
- [ ] Confirm test follows project conventions

## Notes

- This task is part of **Phase 2 â€“ TaskOperatorService Unit Tests**
- **Execution Timing**: Should be executed after TASK-020
- **Dependencies**: 
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-020: Test happy path processNextTask
- **Important Considerations**: 
  - Conversation creation may have retry logic (typically 2 attempts)
  - Task status should be reset to ready to allow retry later
  - Lock must be released to allow other instances to process
  - Error should be logged for debugging
- **Task Independence**: Can be completed independently after TASK-020
- **Current State**: Test file exists with happy path test

## Related Tasks

- Previous: TASK-020 (Test happy path processNextTask)
- Next: TASK-022 (Test cursor-runner HTTP failure)
- Dependencies:
  - TASK-016: Create a new test file for TaskOperatorService
  - TASK-020: Test happy path processNextTask
- Related:
  - TASK-022: Will test async iterate failure
  - TASK-020: Tested happy path

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `processNextTask` when conversation creation fails.

**Definition of Done**: "A test case is written that verifies `processNextTask` correctly handles conversation creation failure by resetting task status to ready, releasing the lock, and returning `{ processed: false, reason: 'error' }`. The test verifies retry logic and cleanup. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify error handling works so that the system recovers from conversation creation failures.
   - **Acceptance Criteria**: 
     - Test verifies method returns error when conversation creation fails
     - Test verifies task status is reset to ready
     - Test verifies lock is released

2. **As a developer**, I want to verify retry logic works so that transient failures are handled.
   - **Acceptance Criteria**:
     - Test verifies conversation creation is retried
     - Test verifies failure after retries is handled correctly

### Automated Tests

The test case should be:

```typescript
it('should reset task to ready and release lock when conversation creation fails', async () => {
  // Arrange: Mock conversation creation to fail
  const sampleTask = { id: 1, prompt: 'test', order: 0, uuid: 'test-uuid', status: 0 };
  const mockRedis = { set: jest.fn().mockResolvedValue('OK'), del: jest.fn().mockResolvedValue(1) };
  const mockDbService = {
    getNextReadyTask: jest.fn().mockReturnValue(sampleTask),
    updateTaskStatus: jest.fn().mockReturnValue(true),
  };
  global.fetch = jest.fn()
    .mockRejectedValue(new Error('Connection failed')); // Conversation creation fails
  
  const service = TaskOperatorService.getInstance(mockRedis);
  // Inject mocks
  
  // Act
  const result = await service.processNextTask();
  
  // Assert
  expect(result).toEqual({ processed: false, reason: 'error' });
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(1, 4); // IN_PROGRESS
  expect(mockDbService.updateTaskStatus).toHaveBeenCalledWith(1, 0); // Reset to ready
  // Verify lock was released
});
```

- [ ] Test case written and passes
- [ ] Test verifies conversation creation failure handling
- [ ] Test verifies task status reset
- [ ] Test verifies lock release

### Git Commit and Push Requirements

- [ ] Test case added to `tests/services/task-operator-service.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add processNextTask conversation creation failure test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case addition

### Final Checklist

- [ ] Test case written and passes
- [ ] Test verifies error handling
- [ ] Test verifies task status reset
- [ ] Test verifies lock release
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
