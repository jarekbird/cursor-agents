# TASK-028.1: Test Redis scan discovery - successful queue discovery

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.1.1
**Task ID**: TASK-028.1

## Description

Add a test case for the `initialize()` method to verify it correctly discovers existing queues from Redis keys and recreates them. The test should verify that queue names are extracted correctly and factories are called for each discovered queue.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `initialize()` method with Redis scan discovery
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `QueueManager.initialize()` method:
- Scans Redis for existing BullMQ queue keys
- Discovers queue names from these keys
- Recreates queues, workers, and queue events for discovered queues

The test file `tests/queue/queue-manager.test.ts` already exists with some tests but may not cover Redis scan discovery.

**Important**: This task should be executed after Phase 2 (TASK-016 through TASK-027). This is the first subtask of TASK-028.

## Checklist

### Preparation and Setup

- [ ] Review `QueueManager.initialize()` Redis scan implementation
- [ ] Understand Redis `SCAN` command and key patterns
- [ ] Review existing `queue-manager.test.ts` structure
- [ ] Understand how queue names are extracted from Redis keys

### Implementation Steps

- [ ] Step 1: Set up Redis scan mock
  - [ ] Mock Redis `scan` or `scanStream` to return queue keys
  - [ ] Return keys like: `bull:queue1:meta`, `bull:queue2:delayed`, `bull:queue3:wait`, `bull:queue1:wait`, etc.
  - [ ] Ensure keys follow BullMQ naming patterns
- [ ] Step 2: Write test for successful queue discovery
  - [ ] Create test: `it('should discover and recreate queues from Redis keys', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Mock Redis `scan` to return multiple queue keys
    - [ ] Extract unique queue names (e.g., `queue1`, `queue2`, `queue3`)
    - [ ] Set up spies on `queueFactory`, `workerFactory`, `queueEventsFactory`
  - [ ] Act: Call `queueManager.initialize()`
  - [ ] Assert: 
    - [ ] Factories are called for each discovered queue
    - [ ] Correct number of queues are created
    - [ ] Queue names are extracted correctly

### Specific Requirements

- [ ] Requirement 1: Test must verify queue discovery
  - Acceptance: Queues are discovered from Redis keys correctly
- [ ] Requirement 2: Test must verify queue recreation
  - Acceptance: Factories are called for each discovered queue
- [ ] Requirement 3: Test must verify key pattern matching
  - Acceptance: Queue names are extracted correctly from Redis keys

### Error Handling and Edge Cases

- [ ] Handle case where Redis scan returns no keys
- [ ] Handle case where key patterns don't match expected format
- [ ] Verify duplicate queue names are handled (same queue, different key types)

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining Redis scan discovery
- [ ] Document key pattern matching logic

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify queue discovery works correctly
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after Phase 2 (TASK-016 through TASK-027)
- **Dependencies**: 
  - TASK-016 through TASK-027: Phase 2 TaskOperatorService tests
- **Important Considerations**: 
  - Redis keys follow BullMQ patterns: `bull:{queueName}:{type}`
  - Queue names must be extracted and deduplicated
  - This is the first of 2 subtasks for TASK-028
- **Task Independence**: Can be completed independently after Phase 2
- **Current State**: Test file exists but may not cover Redis scan discovery

## Related Tasks

- Parent: TASK-028 (Extend queue-manager.test.ts for Redis scan discovery)
- Next: TASK-028.2 (Test Redis scan discovery - error handling)
- Dependencies:
  - TASK-016 through TASK-027: Phase 2 tests
- Related:
  - TASK-028.2: Will test error handling

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for Redis scan-based queue discovery success path.

**Definition of Done**: "A test case is written that verifies `initialize()` correctly discovers queues from Redis keys and recreates them using factories. The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue discovery works so that existing queues are properly restored on restart.
   - **Acceptance Criteria**: 
     - Test verifies queues are discovered from Redis keys
     - Test verifies factories are called for each queue
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('initialize - Redis scan discovery', () => {
  it('should discover and recreate queues from Redis keys', async () => {
    // Arrange: Mock Redis scan to return queue keys
    const mockRedis = {
      scan: jest.fn().mockResolvedValue([
        '0', // cursor
        ['bull:queue1:meta', 'bull:queue1:wait', 'bull:queue2:delayed', 'bull:queue3:meta'],
      ]),
    };
    const queueManager = new QueueManager(mockRedis);
    const queueFactorySpy = jest.spyOn(queueManager, 'queueFactory');
    const workerFactorySpy = jest.spyOn(queueManager, 'workerFactory');
    
    // Act
    await queueManager.initialize();
    
    // Assert
    // Verify factories called for queue1, queue2, queue3
    expect(queueFactorySpy).toHaveBeenCalledTimes(3); // Unique queues
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify queue discovery
- [ ] Tests verify queue recreation

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add Redis scan discovery success test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify queue discovery
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

