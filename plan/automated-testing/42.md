# TASK-042: Add tests for /agents endpoints

**Section**: 5. HTTP/API Black-box Tests (App)
**Subsection**: 5.5
**Task ID**: TASK-042

**NOTE**: This task has been split into granular subtasks:
- **TASK-042.1**: Add tests for POST /agents endpoint
- **TASK-042.2**: Add tests for GET /agents endpoint
- **TASK-042.3**: Add tests for GET /agents/:name endpoint
- **TASK-042.4**: Add tests for DELETE /agents/:name endpoint

Please execute the subtasks (42.1, 42.2, 42.3, 42.4) instead of this parent task.

## Description

Add comprehensive test cases for all `/agents` endpoints: `POST /agents` (create), `GET /agents` (list), `GET /agents/:name` (get status), and `DELETE /agents/:name` (delete). The tests should verify validation, happy paths, and error handling for each endpoint.

**This task has been split into subtasks - see TASK-042.1 through TASK-042.4**

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/app.ts` - `/agents` endpoints
- `virtual-assistant/cursor-agents/tests/app.test.ts` - existing test structure

## Current State

The `/agents` endpoints include:
- `POST /agents`: Creates one-time or recurring agents with validation
- `GET /agents`: Lists all agents across queues
- `GET /agents/:name`: Gets status for specific agent
- `DELETE /agents/:name`: Deletes an agent

The test file `tests/app.test.ts` exists but may not have comprehensive `/agents` endpoint tests.

**Important**: This task should be executed after TASK-041.

## Checklist

### Preparation and Setup

- [ ] Review all `/agents` endpoint implementations
- [ ] Understand validation rules (name, targetUrl, schedule requirements)
- [ ] Review existing `app.test.ts` structure
- [ ] Understand agent creation methods (`addOneTimeAgent`, `addRecurringAgent`)

### Implementation Steps

- [ ] Step 1: Write tests for `POST /agents` validation
  - [ ] Create test: `it('should return 400 when name is missing', async () => { ... })`
  - [ ] Create test: `it('should return 400 when targetUrl is missing', async () => { ... })`
  - [ ] Create test: `it('should return 400 when oneTime=false and no schedule', async () => { ... })`
- [ ] Step 2: Write tests for `POST /agents` happy paths
  - [ ] Create test: `it('should create one-time agent with defaults', async () => { ... })`
  - [ ] Create test: `it('should create recurring agent with schedule', async () => { ... })`
- [ ] Step 3: Write tests for `POST /agents` error path
  - [ ] Create test: `it('should return 500 when queue method rejects', async () => { ... })`
- [ ] Step 4: Write tests for `GET /agents`
  - [ ] Create test: `it('should list all agents and filter null values', async () => { ... })`
  - [ ] Create test: `it('should return 500 when listQueues rejects', async () => { ... })`
- [ ] Step 5: Write tests for `GET /agents/:name`
  - [ ] Create test: `it('should return agent status when agent exists', async () => { ... })`
  - [ ] Create test: `it('should return 404 when agent not found', async () => { ... })`
  - [ ] Create test: `it('should return 500 when getAgentStatus throws', async () => { ... })`
- [ ] Step 6: Write tests for `DELETE /agents/:name`
  - [ ] Create test: `it('should delete agent successfully', async () => { ... })`
  - [ ] Create test: `it('should return 500 when removeAgent throws', async () => { ... })`

### Specific Requirements

- [ ] Requirement 1: Test must verify POST validation
  - Acceptance: All validation errors return 400 with descriptive messages
- [ ] Requirement 2: Test must verify POST happy paths
  - Acceptance: One-time and recurring agents are created correctly
- [ ] Requirement 3: Test must verify GET /agents
  - Acceptance: Lists all agents, filters null values, handles errors
- [ ] Requirement 4: Test must verify GET /agents/:name
  - Acceptance: Returns status for existing agents, 404 for missing, 500 for errors
- [ ] Requirement 5: Test must verify DELETE /agents/:name
  - Acceptance: Deletes agents successfully, handles errors

### Error Handling and Edge Cases

- [ ] Handle case where agent name contains special characters
- [ ] Handle case where multiple agents exist
- [ ] Verify null filtering in GET /agents
- [ ] Test with various agent configurations

### Testing

- [ ] Run `npm run test:http` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining agent endpoint behavior
- [ ] Document validation rules
- [ ] Note error handling approach

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify all endpoints work correctly
- [ ] Verify error handling works
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 5 â€“ HTTP/API Black-box Tests (App)**
- **Execution Timing**: Should be executed after TASK-041
- **Dependencies**: 
  - TASK-041: Add tests for /queues/:queueName DELETE
- **Important Considerations**: 
  - This is a large task covering multiple endpoints
  - Validation rules must match implementation exactly
  - Default values (method, timeout, queue) should be verified
  - Null filtering in GET /agents is important
  - Error messages should match implementation
- **Task Independence**: Can be completed independently after TASK-041
- **Current State**: Test file exists but may not have comprehensive /agents endpoint tests

## Related Tasks

- Previous: TASK-041 (Add tests for /queues/:queueName DELETE)
- Next: TASK-043 (Add tests for /task-operator endpoints)
- Dependencies:
  - TASK-041: Add tests for /queues/:queueName DELETE
- Related:
  - TASK-043 through TASK-045: Will add more HTTP/API tests

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves adding comprehensive test cases for all `/agents` endpoints.

**Definition of Done**: "Test cases are added that verify all `/agents` endpoints (POST, GET, GET /:name, DELETE) with validation, happy paths, and error handling. All tests pass consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify agent creation works so that agents can be created via API.
   - **Acceptance Criteria**: 
     - Test verifies validation works correctly
     - Test verifies one-time and recurring agents are created
     - Test passes consistently

2. **As a developer**, I want to verify agent listing works so that all agents can be retrieved.
   - **Acceptance Criteria**:
     - Test verifies all agents are listed
     - Test verifies null values are filtered
     - Test verifies error handling works

3. **As a developer**, I want to verify agent status retrieval works so that individual agent state can be checked.
   - **Acceptance Criteria**:
     - Test verifies existing agents return status
     - Test verifies missing agents return 404
     - Test verifies errors return 500

4. **As a developer**, I want to verify agent deletion works so that agents can be removed.
   - **Acceptance Criteria**:
     - Test verifies agents are deleted successfully
     - Test verifies errors are handled gracefully

### Automated Tests

Test cases should include:

```typescript
describe('POST /agents', () => {
  it('should return 400 when name is missing', async () => {
    // Arrange: Request without name
    // Act: POST /agents
    // Assert: 400, error message
  });
  
  it('should create one-time agent with defaults', async () => {
    // Arrange: Valid one-time agent request
    // Act: POST /agents
    // Assert: 200, addOneTimeAgent called with defaults
  });
  
  it('should create recurring agent with schedule', async () => {
    // Arrange: Valid recurring agent request
    // Act: POST /agents
    // Assert: 200, addRecurringAgent called with schedule
  });
});

describe('GET /agents', () => {
  it('should list all agents and filter null values', async () => {
    // Arrange: Mock listQueues and getAgentStatus
    // Act: GET /agents
    // Assert: 200, agents array without nulls
  });
});

describe('GET /agents/:name', () => {
  it('should return agent status when agent exists', async () => {
    // Arrange: Mock getAgentStatus to return status
    // Act: GET /agents/test
    // Assert: 200, status JSON
  });
  
  it('should return 404 when agent not found', async () => {
    // Arrange: getAgentStatus returns null
    // Act: GET /agents/non-existent
    // Assert: 404, message "Agent \"non-existent\" not found"
  });
});

describe('DELETE /agents/:name', () => {
  it('should delete agent successfully', async () => {
    // Arrange: Mock removeAgent
    // Act: DELETE /agents/test
    // Assert: 200, success
  });
});
```

- [ ] All test cases written and pass
- [ ] Tests cover all endpoints
- [ ] Tests verify validation
- [ ] Tests verify error handling

### Git Commit and Push Requirements

- [ ] Test cases added to `tests/app.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add comprehensive /agents endpoints tests")
- [ ] Changes are pushed to origin
- [ ] Commit includes only the test case additions

### Final Checklist

- [ ] All test cases written and pass
- [ ] Tests cover POST, GET, GET /:name, DELETE
- [ ] Tests verify validation and error handling
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete
