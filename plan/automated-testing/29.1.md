# TASK-029.1: Test getOrCreateQueue - new queue creation

**Section**: 3. QueueManager Enhancements
**Subsection**: 3.2.1
**Task ID**: TASK-029.1

## Description

Add a test case for the `getOrCreateQueue` method to verify it correctly creates new queues with proper concurrency settings. The test should verify queue, worker, and events creation for a new queue.

**Reference Implementation**: 
- `virtual-assistant/cursor-agents/src/queue/queue-manager.ts` - `getOrCreateQueue()` method
- `virtual-assistant/cursor-agents/tests/queue/queue-manager.test.ts` - existing test structure

## Current State

The `getOrCreateQueue` method:
- Checks if queue already exists in internal map
- Creates new queue, worker, and queue events if not exists
- Sets concurrency to default for non-task-operator queues
- Returns queue instance

The test file `tests/queue/queue-manager.test.ts` exists but may not have comprehensive `getOrCreateQueue` tests.

**Important**: This task should be executed after TASK-028. This is the first subtask of TASK-029.

## Checklist

### Preparation and Setup

- [ ] Review `getOrCreateQueue` implementation
- [ ] Understand concurrency settings (default for non-task-operator)
- [ ] Review existing test structure
- [ ] Understand queue, worker, and events creation

### Implementation Steps

- [ ] Step 1: Write test for new queue creation
  - [ ] Create test: `it('should create new queue with correct concurrency settings', async () => { ... })`
  - [ ] Arrange: 
    - [ ] Queue name that doesn't exist (e.g., `'new-queue'`)
    - [ ] Set up spies on factories
  - [ ] Act: Call `getOrCreateQueue('new-queue')`
  - [ ] Assert: 
    - [ ] Queue factory called with correct name
    - [ ] Worker factory called with concurrency (default)
    - [ ] Queue events factory called
    - [ ] Queue added to internal map

### Specific Requirements

- [ ] Requirement 1: Test must verify new queue creation
  - Acceptance: Queue, worker, and events are created for new queue
- [ ] Requirement 2: Test must verify concurrency settings
  - Acceptance: Non-task-operator queues have default concurrency
- [ ] Requirement 3: Test must verify return value
  - Acceptance: Method returns queue instance

### Error Handling and Edge Cases

- [ ] Handle case where queue creation fails
- [ ] Handle case where worker creation fails
- [ ] Verify queue is not added to map if creation fails

### Testing

- [ ] Run `npm run test:unit` to verify all tests execute
- [ ] Verify all test cases pass
- [ ] Verify existing tests still pass
- [ ] Run full test suite to ensure no regressions
- [ ] **DO NOT manually test by running the server** - use automated tests only

### Documentation

- [ ] Add comments explaining queue creation behavior

### Verification

- [ ] Verify all test cases pass consistently
- [ ] Verify queue creation works
- [ ] Verify concurrency settings work
- [ ] Confirm tests follow project conventions

## Notes

- This task is part of **Phase 3 â€“ QueueManager Enhancements**
- **Execution Timing**: Should be executed after TASK-028
- **Dependencies**: 
  - TASK-028: Extend queue-manager.test.ts for Redis scan discovery
- **Important Considerations**: 
  - Default concurrency allows parallel processing for other queues
  - This is the first of 3 subtasks for TASK-029
- **Task Independence**: Can be completed independently after TASK-028
- **Current State**: Test file exists but may not have comprehensive getOrCreateQueue tests

## Related Tasks

- Parent: TASK-029 (Add tests for getOrCreateQueue)
- Next: TASK-029.2 (Test getOrCreateQueue - task-operator queue)
- Dependencies:
  - TASK-028: Extend queue-manager.test.ts for Redis scan discovery
- Related:
  - TASK-029.2, TASK-029.3: Other subtasks

## Definition of Done

### Task Type: TESTING TASK

**Description**: This task involves writing a test case for `getOrCreateQueue` when creating a new queue.

**Definition of Done**: "A test case is written that verifies `getOrCreateQueue` correctly creates new queues with proper concurrency settings (default for non-task-operator). The test passes consistently. All changes have been committed to git and pushed to origin."

### User Stories

1. **As a developer**, I want to verify queue creation works so that queues are properly initialized.
   - **Acceptance Criteria**: 
     - Test verifies queue, worker, and events are created
     - Test verifies concurrency settings are correct
     - Test passes consistently

### Automated Tests

The test case should be:

```typescript
describe('getOrCreateQueue', () => {
  it('should create new queue with correct concurrency settings', async () => {
    // Arrange: New queue name
    const queueManager = new QueueManager(mockRedis);
    const queueFactorySpy = jest.spyOn(queueManager, 'queueFactory');
    const workerFactorySpy = jest.spyOn(queueManager, 'workerFactory');
    
    // Act
    const queue = await queueManager.getOrCreateQueue('new-queue');
    
    // Assert
    expect(queueFactorySpy).toHaveBeenCalledWith('new-queue');
    expect(workerFactorySpy).toHaveBeenCalledWith('new-queue', expect.objectContaining({
      concurrency: expect.any(Number), // Default concurrency
    }));
    expect(queue).toBeDefined();
  });
});
```

- [ ] Test case written and passes
- [ ] Tests verify new queue creation
- [ ] Tests verify concurrency settings

### Git Commit and Push Requirements

- [ ] Test case added to `tests/queue/queue-manager.test.ts`
- [ ] Commit message follows project conventions (e.g., "test: add getOrCreateQueue new queue creation test")
- [ ] Changes are pushed to origin
- [ ] Commit includes only this test case

### Final Checklist

- [ ] Test case written and passes
- [ ] Tests verify queue creation
- [ ] Tests verify concurrency settings
- [ ] All changes committed to git
- [ ] Code pushed to origin
- [ ] Task marked as complete

