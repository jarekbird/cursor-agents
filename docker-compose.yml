services:
  # cursor-agents Node.js application service
  cursor-agents:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cursor-agents
    restart: unless-stopped
    # Remove port mapping - Traefik will route traffic
    # ports:
    #   - "3002:3002"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3002
      # Redis Configuration - Use shared Redis instance
      - REDIS_URL=redis://redis:6379/0
      # BullMQ Configuration
      - BULLMQ_CONCURRENCY=${BULLMQ_CONCURRENCY:-5}
      # Optional: Cursor runner URL for processing prompts
      - CURSOR_RUNNER_URL=${CURSOR_RUNNER_URL:-http://cursor-runner:3001}
    volumes:
      # Mount shared cursor volume (contains repositories, tools, and scripts directories)
      # Tool scripts should be placed in /cursor/tools (one script per tool)
      # One-time scripts created by cursor-cli are placed in /cursor/scripts
      - cursor_runner_repositories:/cursor
    networks:
      - virtual-assistant-network
    # Note: Redis and Traefik services are defined in jarek-va/docker-compose.yml
    # This service connects to them via the shared network
    labels:
      - "traefik.enable=true"
      # Path-based routing - accessible at /agents/* on the same domain
      # Priority ensures this router is evaluated before the general Rails app router
      - "traefik.http.routers.cursor-agents.priority=10"
      - "traefik.http.routers.cursor-agents.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/agents`)"
      - "traefik.http.routers.cursor-agents.entrypoints=websecure"
      - "traefik.http.routers.cursor-agents.tls.certresolver=letsencrypt"
      - "traefik.http.services.cursor-agents.loadbalancer.server.port=3002"
      # Strip /agents prefix before forwarding to the service
      - "traefik.http.middlewares.cursor-agents-stripprefix.stripprefix.prefixes=/agents"
      # Security headers middleware
      - "traefik.http.middlewares.cursor-agents-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.cursor-agents-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cursor-agents-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cursor-agents-headers.headers.stsPreload=true"
      # Apply both strip prefix and security headers
      - "traefik.http.routers.cursor-agents.middlewares=cursor-agents-stripprefix,cursor-agents-headers"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  # Reference the shared repositories volume from cursor-runner
  cursor_runner_repositories:
    external: true
    name: cursor_runner_repositories

networks:
  virtual-assistant-network:
    external: true
    name: virtual-assistant-network

